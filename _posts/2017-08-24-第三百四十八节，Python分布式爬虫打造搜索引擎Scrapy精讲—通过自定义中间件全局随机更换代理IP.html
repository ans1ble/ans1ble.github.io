第三百四十八节，Python分布式爬虫打造搜索引擎Scrapy精讲—通过自定义中间件全局随机更换代理IP


			<div id="cnblogs_post_body" class="blogpost-body"><p><strong>第三百四十八节，Python分布式爬虫打造搜索引擎Scrapy精讲—通过自定义中间件全局随机更换代理IP</strong></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>设置代理ip只需要，自定义一个中间件，重写<span style="color: #0000ff">process_request</span>方法，</strong></span></p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">request.meta['proxy']</span> = "http://185.82.203.146:1080" &nbsp; 设置代理IP</strong></span></p>
<p><span style="color: #ff0000"><strong>中间件，注意将中间件注册到配置文件里去</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff">from</span> adc.daili_ip.sh_yong_ip.sh_yong_ip <span style="color: #0000ff">import</span><span style="color: #000000"> sui_ji_hq_ip

</span><span style="color: #0000ff">from</span> fake_useragent <span style="color: #0000ff">import</span> UserAgent    <span style="color: #008000">#</span><span style="color: #008000">导入浏览器用户代理模块</span>

<span style="color: #0000ff">class</span> RequestsUserAgentmiddware(object):                                    <span style="color: #008000">#</span><span style="color: #008000">自定义浏览器代理中间件</span>
    <span style="color: #008000">#</span><span style="color: #008000">中间件随机更换Requests请求头信息的User-Agent浏览器用户代理</span>
    <span style="color: #0000ff">def</span> <span style="color: #800080">__init__</span><span style="color: #000000">(self,crawler):
        super(RequestsUserAgentmiddware, self).</span><span style="color: #800080">__init__</span>()                   <span style="color: #008000">#</span><span style="color: #008000">获取上一级父类基类的，__init__方法里的对象封装值</span>
        self.ua = UserAgent()                                               <span style="color: #008000">#</span><span style="color: #008000">实例化浏览器用户代理模块类</span>
        self.ua_type = crawler.settings.get(<span style="color: #800000">'</span><span style="color: #800000">RANDOM_UA_TYPE</span><span style="color: #800000">'</span>,<span style="color: #800000">'</span><span style="color: #800000">random</span><span style="color: #800000">'</span>)      <span style="color: #008000">#</span><span style="color: #008000">获取settings.py配置文件里的RANDOM_UA_TYPE配置的浏览器类型，如果没有，默认random，随机获取各种浏览器类型</span>
<span style="color: #000000">
    @classmethod                                                            </span><span style="color: #008000">#</span><span style="color: #008000">函数上面用上装饰符@classmethod，函数里有一个必写形式参数cls用来接收当前类名称</span>
    <span style="color: #0000ff">def</span> from_crawler(cls, crawler):                                         <span style="color: #008000">#</span><span style="color: #008000">重载from_crawler方法</span>
        <span style="color: #0000ff">return</span> cls(crawler)                                                 <span style="color: #008000">#</span><span style="color: #008000">将crawler爬虫返回给类</span>

    <span style="color: #0000ff">def</span> process_request(self, request, spider):                             <span style="color: #008000">#</span><span style="color: #008000">重载process_request方法</span>
        <span style="color: #0000ff">def</span> get_ua():                                                       <span style="color: #008000">#</span><span style="color: #008000">自定义函数，返回浏览器代理对象里指定类型的浏览器信息</span>
            <span style="color: #0000ff">return</span><span style="color: #000000"> getattr(self.ua, self.ua_type)
        sssf </span>=<span style="color: #000000"> get_ua()
        </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">启用用户代理浏览器信息：{0}</span><span style="color: #800000">'</span><span style="color: #000000">.format(sssf))
        request.headers.setdefault(</span><span style="color: #800000">'</span><span style="color: #800000">User-Agent</span><span style="color: #800000">'</span>, get_ua())                  <span style="color: #008000">#</span><span style="color: #008000">将浏览器代理信息添加到Requests请求</span>


<span style="background-color: #ff99cc"><span style="color: #0000ff">class</span><span style="color: #000000"> MyproxiesSpiderMiddleware(object):
    </span><span style="color: #008000">#</span><span style="color: #008000">中间件随机更换IP</span>

    <span style="color: #0000ff">def</span> process_request(self, request, spider):                             <span style="color: #008000">#</span><span style="color: #008000">重写process_request方法</span>
        <span style="color: #008000">#</span><span style="color: #008000">到数据库随机获取一个IP</span>
<span style="color: #000000">
        xieyi </span>= request._get_url()                                          <span style="color: #008000">#</span><span style="color: #008000">_get_url可以获取到请求URL，来判断是什么协议请求如https</span>
        <span style="color: #0000ff">print</span><span style="color: #000000">(xieyi)
        dai_ip </span>= sui_ji_hq_ip(<span style="color: #800000">'</span><span style="color: #800000">http</span><span style="color: #800000">'</span>)                                       <span style="color: #008000">#</span><span style="color: #008000">到数据库随机获取一个代理IP</span>
        request.meta[<span style="color: #800000">'</span><span style="color: #800000">proxy</span><span style="color: #800000">'</span>] = <span style="color: #800000">"</span><span style="color: #800000">http://{0}</span><span style="color: #800000">"</span>.format(dai_ip)                 <span style="color: #008000">#</span><span style="color: #008000">字符串格式化设置代理IP</span>

        <span style="color: #008000">#</span><span style="color: #008000">request.meta['proxy'] = "http://185.82.203.146:1080"   设置代理IP</span></span></pre>
</div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>随机数据库获取IP</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf8 -*-</span>
<span style="color: #0000ff">import</span><span style="color: #000000"> time

</span><span style="color: #0000ff">import</span><span style="color: #000000"> requests

</span><span style="color: #0000ff">from</span> adc.daili_ip.mysq <span style="color: #0000ff">import</span><span style="color: #000000"> shujuku as ORM


</span><span style="color: #0000ff">def</span><span style="color: #000000"> suiji_ip(rst):
    </span><span style="color: #800000">"""</span><span style="color: #800000">
    调用此函数随机到数据库获取代理IP返回IP，如果IP不可用会自动删除返回False
    </span><span style="color: #800000">"""</span><span style="color: #000000">
    atime </span>= time.localtime(time.time()-240)          <span style="color: #008000">#</span><span style="color: #008000">设置获取多少时间以内检测过的IP(单位秒)</span>
    sudu = <span style="color: #800000">'</span><span style="color: #800000">00:00:03</span><span style="color: #800000">'</span>                               <span style="color: #008000">#</span><span style="color: #008000">设置获取访问速度小于等于多少的IP，单位(时分秒)默认3秒</span>
    dqatime = <span style="color: #800000">"</span><span style="color: #800000">{0}-{1}-{2} {3}:{4}:{5}</span><span style="color: #800000">"</span><span style="color: #000000">.format(
        atime.tm_year,
        atime.tm_mon,
        atime.tm_mday,
        atime.tm_hour,
        atime.tm_min,
        atime.tm_sec
    )  </span><span style="color: #008000">#</span><span style="color: #008000"> 将格式化时间日期，单独取出来拼接成一个完整日期</span>

    <span style="color: #0000ff">try</span><span style="color: #000000">:
        mysq </span>=<span style="color: #000000"> ORM.session()
        shuju </span>=<span style="color: #000000"> mysq.query(
            ORM.daili_ip.ip,
            ORM.daili_ip.port,
            ORM.daili_ip.xtype,
            ORM.daili_ip.seshi_ri_qi,
            ORM.daili_ip.connectTimeMs
        ).from_statement(
            </span><span style="color: #800000">"</span><span style="color: #800000">SELECT ip,port,xtype,seshi_ri_qi,connectTimeMs FROM daili_ip WHERE xtype='{0}' AND ce_shi='{1}' AND seshi_ri_qi&gt;='{2}' AND connectTimeMs&lt;='{3}' ORDER BY RAND() LIMIT 1</span><span style="color: #800000">"</span>.format(rst, <span style="color: #800000">'</span><span style="color: #800000">1</span><span style="color: #800000">'</span><span style="color: #000000">, dqatime, sudu)
        ).all()
        mysq.close()
        </span><span style="color: #0000ff">if</span><span style="color: #000000"> shuju:
            </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">获取到IP</span><span style="color: #800000">'</span><span style="color: #000000">)
        </span><span style="color: #0000ff">else</span><span style="color: #000000">:
            </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">获取IP失败，请检查获取条件</span><span style="color: #800000">'</span><span style="color: #000000">)
    </span><span style="color: #0000ff">except</span><span style="color: #000000"> Exception as e:
        </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">查询代理IP数据出错</span><span style="color: #800000">'</span><span style="color: #000000">)
        </span><span style="color: #0000ff">return</span><span style="color: #000000"> True
    ip </span>=<span style="color: #000000"> shuju[0][0]
    duan_kou </span>= shuju[0][1<span style="color: #000000">]
    </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">启用代理IP，数据库获取到IP：{0}</span><span style="color: #800000">'</span><span style="color: #000000">.format(shuju))

    http_url </span>= <span style="color: #800000">'</span><span style="color: #800000">{0}://image.baidu.com/</span><span style="color: #800000">'</span><span style="color: #000000">.format(rst)
    proxy_url </span>= <span style="color: #800000">'</span><span style="color: #800000">{0}://{1}:{2}</span><span style="color: #800000">'</span><span style="color: #000000">.format(rst, ip, duan_kou)
    headers </span>=<span style="color: #000000"> {
        </span><span style="color: #800000">'</span><span style="color: #800000">Referer</span><span style="color: #800000">'</span><span style="color: #000000">: http_url,
        </span><span style="color: #800000">'</span><span style="color: #800000">User-Agent</span><span style="color: #800000">'</span>: <span style="color: #800000">'</span><span style="color: #800000">Mozilla/5.0 (Windows NT 10.0; WOW64; rv:54.0) Gecko/20100101 Firefox/54.0</span><span style="color: #800000">'</span><span style="color: #000000">,
    }

    </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">启用代理IP，测试网址：{0}</span><span style="color: #800000">'</span><span style="color: #000000">.format(http_url))
    </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">启用代理IP，测试头：{0}</span><span style="color: #800000">'</span><span style="color: #000000">.format(proxy_url))
    </span><span style="color: #0000ff">try</span><span style="color: #000000">:
        proxy_dict </span>=<span style="color: #000000"> {
            </span><span style="color: #800000">'</span><span style="color: #800000">http</span><span style="color: #800000">'</span><span style="color: #000000">: proxy_url
        }
        response </span>= requests.get(http_url, proxies=proxy_dict, headers=<span style="color: #000000">headers)
    </span><span style="color: #0000ff">except</span><span style="color: #000000"> Exception as e:
        </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">启用代理IP，测速连接失败{0}</span><span style="color: #800000">'</span><span style="color: #000000">.format(e))
        </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">启用代理IP，测速连接失败，当前IP不可用，删除当前ip！</span><span style="color: #800000">'</span><span style="color: #000000">)
        fanhui </span>= mysq.query(ORM.daili_ip).filter(ORM.daili_ip.ip == ip).delete()  <span style="color: #008000">#</span><span style="color: #008000"> 删除不可以数据</span>
<span style="color: #000000">        mysq.commit()
        mysq.close()
        </span><span style="color: #0000ff">if</span> fanhui == 1<span style="color: #000000">:
            </span><span style="color: #0000ff">print</span>(<span style="color: #800000">"</span><span style="color: #800000">成功删除当前IP</span><span style="color: #800000">"</span><span style="color: #000000">)
        </span><span style="color: #0000ff">else</span><span style="color: #000000">:
            </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">删除当前IP失败</span><span style="color: #800000">'</span><span style="color: #000000">)
        </span><span style="color: #0000ff">return</span><span style="color: #000000"> False
    </span><span style="color: #0000ff">else</span><span style="color: #000000">:
        code </span>= response.status_code  <span style="color: #008000">#</span><span style="color: #008000"> 获取状态吗</span>
        sudu = str(response.elapsed)  <span style="color: #008000">#</span><span style="color: #008000"> 获取响应时间</span>
        <span style="color: #0000ff">if</span> code &gt;= 200 <span style="color: #0000ff">and</span> code &lt; 300<span style="color: #000000">:
            atime </span>=<span style="color: #000000"> time.localtime()
            dqatime </span>= <span style="color: #800000">"</span><span style="color: #800000">{0}-{1}-{2} {3}:{4}:{5}</span><span style="color: #800000">"</span><span style="color: #000000">.format(
                atime.tm_year,
                atime.tm_mon,
                atime.tm_mday,
                atime.tm_hour,
                atime.tm_min,
                atime.tm_sec
            )  </span><span style="color: #008000">#</span><span style="color: #008000"> 将格式化时间日期，单独取出来拼接成一个完整日期</span>

            <span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">启用代理IP，测试代理ip--{0}{1}--状态可用--状态码--{2}</span><span style="color: #800000">'</span><span style="color: #000000">.format(ip, duan_kou, code))
            </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">启用代理IP，当前IP可以，正在向数据库标记</span><span style="color: #800000">'</span><span style="color: #000000">)
            fanhui </span>= mysq.query(ORM.daili_ip).filter(ORM.daili_ip.ip ==<span style="color: #000000"> ip).update({
                </span><span style="color: #800000">"</span><span style="color: #800000">ce_shi</span><span style="color: #800000">"</span>: <span style="color: #800000">"</span><span style="color: #800000">1</span><span style="color: #800000">"</span><span style="color: #000000">,
                </span><span style="color: #800000">"</span><span style="color: #800000">seshi_ri_qi</span><span style="color: #800000">"</span><span style="color: #000000">: dqatime,
                </span><span style="color: #800000">"</span><span style="color: #800000">connectTimeMs</span><span style="color: #800000">"</span><span style="color: #000000">: sudu
            })
            mysq.commit()
            mysq.close()
            </span><span style="color: #0000ff">if</span> fanhui == 1<span style="color: #000000">:
                </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">向数据库成功标记可用IP！</span><span style="color: #800000">'</span><span style="color: #000000">)
            </span><span style="color: #0000ff">else</span><span style="color: #000000">:
                </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">向数据库标记可用IP失败！！！</span><span style="color: #800000">'</span><span style="color: #000000">)
            </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">向爬虫返回IP：{0}:{1}</span><span style="color: #800000">'</span><span style="color: #000000">.format(ip, duan_kou))
            </span><span style="color: #0000ff">return</span> ip + <span style="color: #800000">'</span><span style="color: #800000">:</span><span style="color: #800000">'</span> +<span style="color: #000000"> duan_kou
        </span><span style="color: #0000ff">else</span><span style="color: #000000">:
            </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">启用代理IP，测试代理ip--{0}{1}--状态不可用--状态码--{2}</span><span style="color: #800000">'</span><span style="color: #000000">.format(ip, duan_kou, code))
            </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">返回状态码不可以，正在向数据库删除当前IP</span><span style="color: #800000">'</span><span style="color: #000000">)
            fanhui </span>= mysq.query(ORM.daili_ip).filter(ORM.daili_ip.ip == ip).delete()  <span style="color: #008000">#</span><span style="color: #008000"> 删除不可以数据</span>
<span style="color: #000000">            mysq.commit()
            mysq.close()
            </span><span style="color: #0000ff">if</span> fanhui == 1<span style="color: #000000">:
                </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">删除当前IP成功</span><span style="color: #800000">'</span><span style="color: #000000">)
            </span><span style="color: #0000ff">else</span><span style="color: #000000">:
                </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">删除当前IP失败</span><span style="color: #800000">'</span><span style="color: #000000">)
            </span><span style="color: #0000ff">return</span><span style="color: #000000"> False


</span><span style="color: #0000ff">def</span><span style="color: #000000"> sui_ji_hq_ip(rst):
    </span><span style="color: #800000">"""</span><span style="color: #800000">
    正式使用：调用此函数，接收一个参数协议，如http
    循环到数据库获取IP，IP如果不可用删除后继续获取，直到ip可以后返回ip
    值循环获取测试30分钟内有效的IP
    </span><span style="color: #800000">"""</span><span style="color: #000000">
    n </span>=<span style="color: #000000"> True
    h </span>=<span style="color: #000000"> None
    </span><span style="color: #0000ff">while</span><span style="color: #000000"> n:
        youxiao_ip </span>=<span style="color: #000000"> suiji_ip(rst)
        </span><span style="color: #0000ff">if</span><span style="color: #000000"> youxiao_ip:
            h </span>=<span style="color: #000000"> youxiao_ip
            n </span>=<span style="color: #000000"> False
    </span><span style="color: #0000ff">return</span><span style="color: #000000"> h

</span><span style="color: #008000">#</span><span style="color: #008000"> print(sui_ji_hq_ip('http'))</span></pre>
</div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>数据库模块文件</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff">import</span><span style="color: #000000"> sqlalchemy
</span><span style="color: #0000ff">from</span> sqlalchemy.ext.declarative <span style="color: #0000ff">import</span><span style="color: #000000"> declarative_base
</span><span style="color: #0000ff">from</span> sqlalchemy <span style="color: #0000ff">import</span><span style="color: #000000"> Column, Integer, String, ForeignKey, UniqueConstraint, Index,text,DATETIME,TIME
</span><span style="color: #0000ff">from</span> sqlalchemy.orm <span style="color: #0000ff">import</span><span style="color: #000000"> sessionmaker, relationship
</span><span style="color: #0000ff">from</span> sqlalchemy <span style="color: #0000ff">import</span><span style="color: #000000"> create_engine

</span><span style="color: #0000ff">import</span><span style="color: #000000"> requests
</span><span style="color: #0000ff">import</span><span style="color: #000000"> json
</span><span style="color: #0000ff">import</span><span style="color: #000000"> time
</span><span style="color: #0000ff">import</span><span style="color: #000000"> datetime


</span><span style="color: #008000">#</span><span style="color: #008000">配置数据库引擎信息</span>
ENGINE = create_engine(<span style="color: #800000">"</span><span style="color: #800000">mysql+pymysql://root:279819@127.0.0.1:3306/cshi?charset=utf8</span><span style="color: #800000">"</span>, max_overflow=500, echo=<span style="color: #000000">True)

Base </span>= declarative_base()       <span style="color: #008000">#</span><span style="color: #008000">创建一个SQLORM基类</span>

<span style="color: #0000ff">class</span> daili_ip(Base):            <span style="color: #008000">#</span><span style="color: #008000">ip池设计表</span>
    <span style="color: #800080">__tablename__</span> = <span style="color: #800000">'</span><span style="color: #800000">daili_ip</span><span style="color: #800000">'</span><span style="color: #000000">

    id </span>= Column(Integer, primary_key=True, autoincrement=<span style="color: #000000">True)
    ip </span>= Column(String(300), unique=True)       <span style="color: #008000">#</span><span style="color: #008000">IP</span>
    port = Column(String(300))                  <span style="color: #008000">#</span><span style="color: #008000">端口</span>
    city = Column(String(300))                  <span style="color: #008000">#</span><span style="color: #008000">城市</span>
    isp = Column(String(300))                   <span style="color: #008000">#</span><span style="color: #008000">运营商</span>
    connectTimeMs = Column(TIME())              <span style="color: #008000">#</span><span style="color: #008000">速度</span>
    anonymity = Column(String(300))             <span style="color: #008000">#</span><span style="color: #008000">匿名方式</span>
    country = Column(String(300))               <span style="color: #008000">#</span><span style="color: #008000">国家</span>
    xtype = Column(String(300))                 <span style="color: #008000">#</span><span style="color: #008000">协议</span>
    zhuang_tai_ma = Column(String(300))         <span style="color: #008000">#</span><span style="color: #008000">状态码</span>
    ruku_riqi = Column(DATETIME())             <span style="color: #008000">#</span><span style="color: #008000">入库日期</span>
    ce_shi = Column(String(300))                <span style="color: #008000">#</span><span style="color: #008000">测试状态</span>
    seshi_ri_qi = Column(DATETIME())           <span style="color: #008000">#</span><span style="color: #008000">测试日期</span>
    shi_xiao_riqi = Column(DATETIME())         <span style="color: #008000">#</span><span style="color: #008000"> 失效日期</span>


<span style="color: #0000ff">def</span><span style="color: #000000"> init_db():
    Base.metadata.create_all(ENGINE)        </span><span style="color: #008000">#</span><span style="color: #008000">向数据库创建指定表</span>

<span style="color: #0000ff">def</span><span style="color: #000000"> drop_db():
    Base.metadata.drop_all(ENGINE)          </span><span style="color: #008000">#</span><span style="color: #008000">向数据库删除指定表</span>

<span style="color: #0000ff">def</span><span style="color: #000000"> session():
    cls </span>= sessionmaker(bind=ENGINE)         <span style="color: #008000">#</span><span style="color: #008000">创建sessionmaker类,操作表</span>
    <span style="color: #0000ff">return</span><span style="color: #000000"> cls()


</span><span style="color: #008000">#</span><span style="color: #008000"> drop_db()         #删除表</span><span style="color: #008000">
#</span><span style="color: #008000"> init_db()</span></pre>
</div>
<p>&nbsp;</p></div>