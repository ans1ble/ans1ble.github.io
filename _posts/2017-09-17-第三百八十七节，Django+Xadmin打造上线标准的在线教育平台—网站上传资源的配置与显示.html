第三百八十七节，Django+Xadmin打造上线标准的在线教育平台—网站上传资源的配置与显示


			<div id="cnblogs_post_body" class="blogpost-body"><p><strong>第三百八十七节，Django+Xadmin打造上线标准的在线教育平台—网站上传资源的配置与显示</strong></p>
<p>&nbsp;</p>
<p><strong>首先了解一下static静态文件与上传资源的区别，<strong>static静态文件里面一般防止的我们网站样式的文件，包括ccs，js，网站样式图片</strong></strong></p>
<p><strong><strong>上传资源是用户操作上传的图片等资源</strong></strong></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong><strong><strong>上传资源的配置</strong></strong></strong></span></p>
<p><span style="color: #ff0000"><strong><strong><strong>1，首先在项目里创建一个名称叫<span style="color: #0000ff">media</span>的文件夹专门保存用户上传</strong></strong></strong></span></p>
<p><span style="color: #ff0000"><strong><strong><strong>2，settings.py文件配置上传资源的路径</strong></strong></strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000"> 上传资源路径，如果图片，上传文件等</span>
MEDIA_URL = <span style="color: #800000">'</span><span style="color: #800000">/media/</span><span style="color: #800000">'</span>                           <span style="color: #008000">#</span><span style="color: #008000"> 设置上传资源前缀名称</span>
MEDIA_ROOT = os.path.join(BASE_DIR, <span style="color: #800000">'</span><span style="color: #800000">media</span><span style="color: #800000">'</span>)    <span style="color: #008000">#</span><span style="color: #008000"> 设置上传文件路径</span></pre>
</div>
<p><span style="color: #0000ff"><strong>这样配置好后，当用户上传文件时，会根据数据表类的上传字段设置来，将文件上传到，<strong><strong><strong>media文件夹里，如下</strong></strong></strong></strong></span></p>
<p><span style="color: #ff0000"><strong>数据表类</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff">class</span><span style="color: #000000"> CourseOrg(models.Model):
    name </span>= models.CharField(max_length=50, verbose_name=<span style="color: #800000">'</span><span style="color: #800000">机构名称</span><span style="color: #800000">'</span><span style="color: #000000">)
    desc </span>= models.TextField(verbose_name=<span style="color: #800000">'</span><span style="color: #800000">机构描述</span><span style="color: #800000">'</span><span style="color: #000000">)
    category </span>= models.CharField(max_length=20, verbose_name=<span style="color: #800000">'</span><span style="color: #800000">机构类别</span><span style="color: #800000">'</span>, default=<span style="color: #800000">'</span><span style="color: #800000">pxjg</span><span style="color: #800000">'</span>, choices=((<span style="color: #800000">'</span><span style="color: #800000">pxjg</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">培训机构</span><span style="color: #800000">'</span>), (<span style="color: #800000">'</span><span style="color: #800000">gx</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">高校</span><span style="color: #800000">'</span>), (<span style="color: #800000">'</span><span style="color: #800000">gr</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">个人</span><span style="color: #800000">'</span><span style="color: #000000">)))
    click </span>= models.IntegerField(default=0, verbose_name=<span style="color: #800000">'</span><span style="color: #800000">点击数</span><span style="color: #800000">'</span><span style="color: #000000">)
    fav_nums </span>= models.IntegerField(default=0, verbose_name=<span style="color: #800000">'</span><span style="color: #800000">收藏数</span><span style="color: #800000">'</span><span style="color: #000000">)
    <span style="background-color: #ffff00">image </span></span><span style="background-color: #ffff00">= models.ImageField(<span style="background-color: #ff99cc">upload_to=<span style="color: #800000">'</span><span style="color: #800000">org/%Y/%m</span><span style="color: #800000">'</span></span>, verbose_name=<span style="color: #800000">'</span><span style="color: #800000">封面图</span><span style="color: #800000">'</span>, max_length=100</span><span style="color: #000000"><span style="background-color: #ffff00">)</span>
    address </span>= models.CharField(max_length=150, verbose_name=<span style="color: #800000">'</span><span style="color: #800000">机构地址</span><span style="color: #800000">'</span><span style="color: #000000">)
    city </span>= models.ForeignKey(CityDict, verbose_name=<span style="color: #800000">'</span><span style="color: #800000">外键城市表</span><span style="color: #800000">'</span><span style="color: #000000">)
    add_time </span>= models.DateTimeField(default=datetime.now, verbose_name=<span style="color: #800000">'</span><span style="color: #800000">添加日期</span><span style="color: #800000">'</span><span style="color: #000000">)

    </span><span style="color: #0000ff">class</span><span style="color: #000000"> Meta:
        verbose_name </span>= <span style="color: #800000">'</span><span style="color: #800000">课程机构表</span><span style="color: #800000">'</span><span style="color: #000000">
        verbose_name_plural </span>=<span style="color: #000000"> verbose_name

    </span><span style="color: #0000ff">def</span> <span style="color: #800080">__str__</span><span style="color: #000000">(self):
        </span><span style="color: #0000ff">return</span> self.name</pre>
</div>
<p><img src="https://images2017.cnblogs.com/blog/955761/201709/955761-20170917105920547-526599002.png" alt=""></p>
<p><span style="color: #0000ff"><strong>此时可以看到上传文件安装年月来保存文件，那么怎么设置文件名</strong></span></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>设置上传文件名称</strong></span></p>
<p><span style="color: #ff0000"><strong>1、先在你项目中添加一个文件夹如：<code>system</code>&nbsp;在文件夹下添加<code>__init__.py</code>&nbsp;和<code>storage.py</code>文件,并在<code>storage.py</code>中添加如下代码：</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000"> -*- coding: UTF-8 -*-</span>
<span style="color: #0000ff">from</span> django.core.files.storage <span style="color: #0000ff">import</span><span style="color: #000000"> FileSystemStorage
</span><span style="color: #0000ff">from</span> django.http <span style="color: #0000ff">import</span><span style="color: #000000"> HttpResponse<br>
</span><span style="color: #0000ff">class</span><span style="color: #000000"> ImageStorage(FileSystemStorage):
    </span><span style="color: #0000ff">from</span> django.conf <span style="color: #0000ff">import</span><span style="color: #000000"> settings
    
    </span><span style="color: #0000ff">def</span> <span style="color: #800080">__init__</span>(self, location=settings.MEDIA_ROOT, base_url=<span style="color: #000000">settings.MEDIA_URL):
        </span><span style="color: #008000">#</span><span style="color: #008000"> 初始化</span>
        super(ImageStorage, self).<span style="color: #800080">__init__</span><span style="color: #000000">(location, base_url)

    </span><span style="color: #008000">#</span><span style="color: #008000"> 重写 _save方法        </span>
    <span style="color: #0000ff">def</span><span style="color: #000000"> _save(self, name, content):
        </span><span style="color: #008000">#</span><span style="color: #008000">name为上传文件名称</span>
        <span style="color: #0000ff">import</span><span style="color: #000000"> os, time, random
        </span><span style="color: #008000">#</span><span style="color: #008000"> 文件扩展名</span>
        ext = os.path.splitext(name)[1<span style="color: #000000">]
        </span><span style="color: #008000">#</span><span style="color: #008000"> 文件目录</span>
        d =<span style="color: #000000"> os.path.dirname(name)
        </span><span style="color: #008000">#</span><span style="color: #008000"> 定义文件名，年月日时分秒随机数</span>
        fn = time.strftime(<span style="color: #800000">'</span><span style="color: #800000">%Y%m%d%H%M%S</span><span style="color: #800000">'</span><span style="color: #000000">)
        fn </span>= fn + <span style="color: #800000">'</span><span style="color: #800000">_%d</span><span style="color: #800000">'</span> % random.randint(0,100<span style="color: #000000">)
        </span><span style="color: #008000">#</span><span style="color: #008000"> 重写合成文件名</span>
        name = os.path.join(d, fn +<span style="color: #000000"> ext)
        </span><span style="color: #008000">#</span><span style="color: #008000"> 调用父类方法</span>
        <span style="color: #0000ff">return</span> super(ImageStorage, self)._save(name, content)</pre>
</div>
<p><span style="color: #ff0000"><strong>2、在<code>models.py</code>文件中添加如下代码：</strong></span></p>
<p><span style="color: #ff0000"><strong>在数据库文件导入我们设置的类</strong></span></p>
<p><span style="color: #ff0000"><strong>在上传字段里设置<span style="color: #0000ff">storage=ImageStorage()</span>执行类，就是我们自定义<strong><code>storage.py</code>中的类</strong></strong></span></p>
<div class="cnblogs_code">
<pre><span style="background-color: #ff99cc"><span style="color: #0000ff">from</span> system.storage <span style="color: #0000ff">import</span></span><span style="color: #000000"><span style="background-color: #ff99cc"> ImageStorage</span>
pic</span>=models.ImageField(<span style="background-color: #ffff00">upload_to=<span style="color: #800000">'</span><span style="color: #800000">img/%Y/%m/%d</span><span style="color: #800000">'</span></span>,<span style="background-color: #ff99cc">storage=ImageStorage()</span>)  <span style="color: #008000">#</span><span style="color: #008000">如果上传文件可以将ImageField换为FileField</span></pre>
</div>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>上传文件显示</strong></span></p>
<p><span style="color: #ff0000"><strong>上传的文件如图片，要在前台或者后台显示，就需要配置才能显示</strong></span></p>
<p><span style="color: #ff0000"><strong>要给上传文件访问配置一个专门的url路由映射</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff">from</span> django.conf.urls <span style="color: #0000ff">import</span> url, include                   <span style="color: #008000">#</span><span style="color: #008000"> 导入django自在的include逻辑</span>
<span style="color: #0000ff">from</span> django.contrib <span style="color: #0000ff">import</span><span style="color: #000000"> admin
</span><span style="color: #0000ff">from</span> django.views.generic <span style="color: #0000ff">import</span> TemplateView               <span style="color: #008000">#</span><span style="color: #008000"> 导入django自带的TemplateView逻辑</span>
<span style="background-color: #ff99cc"><span style="color: #0000ff">from</span> django.views.static <span style="color: #0000ff">import</span> serve                       <span style="color: #008000">#</span><span style="color: #008000"> 导入django自带的serve静态资源逻辑</span></span>
<span style="color: #0000ff">import</span> xadmin                                               <span style="color: #008000">#</span><span style="color: #008000"> 导入xadmin</span>

<span style="color: #0000ff">from</span> app_users.views <span style="color: #0000ff">import</span> deng_lu, zhu_ce, active_code, logout                 <span style="color: #008000">#</span><span style="color: #008000"> 导入登录逻辑处理类</span>
<span style="color: #0000ff">from</span> app_organization.views <span style="color: #0000ff">import</span> org_list                                      <span style="color: #008000">#</span><span style="color: #008000"> 导入授课机构逻辑</span>
<span style="background-color: #ff99cc"><span style="color: #0000ff">from</span> MxOnline.settings <span style="color: #0000ff">import</span></span><span style="color: #000000"><span style="background-color: #ff99cc"> MEDIA_ROOT</span>


urlpatterns </span>=<span style="color: #000000"> [
    url(r</span><span style="color: #800000">'</span><span style="color: #800000">^xadmin/</span><span style="color: #800000">'</span><span style="color: #000000">, xadmin.site.urls),

    url(r</span><span style="color: #800000">'</span><span style="color: #800000">^index.html</span><span style="color: #800000">'</span>, TemplateView.as_view(template_name=<span style="color: #800000">'</span><span style="color: #800000">index.html</span><span style="color: #800000">'</span>), name=<span style="color: #800000">'</span><span style="color: #800000">index</span><span style="color: #800000">'</span><span style="color: #000000">),

    </span><span style="color: #008000">#</span><span style="color: #008000"> 注册</span>
    url(r<span style="color: #800000">'</span><span style="color: #800000">^register.html</span><span style="color: #800000">'</span>, zhu_ce.as_view(), name=<span style="color: #800000">'</span><span style="color: #800000">register</span><span style="color: #800000">'</span><span style="color: #000000">),
    url(r</span><span style="color: #800000">'</span><span style="color: #800000">^captcha/</span><span style="color: #800000">'</span>, include(<span style="color: #800000">'</span><span style="color: #800000">captcha.urls</span><span style="color: #800000">'</span>), name=<span style="color: #800000">'</span><span style="color: #800000">captcha</span><span style="color: #800000">'</span><span style="color: #000000">),
    url(r</span><span style="color: #800000">'</span><span style="color: #800000">^active/(?P&lt;active_de&gt;.*)/$</span><span style="color: #800000">'</span>, active_code.as_view(), name=<span style="color: #800000">"</span><span style="color: #800000">user_active</span><span style="color: #800000">"</span><span style="color: #000000">),

    </span><span style="color: #008000">#</span><span style="color: #008000"> 登录</span>
    url(r<span style="color: #800000">'</span><span style="color: #800000">^login.html</span><span style="color: #800000">'</span>, TemplateView.as_view(template_name=<span style="color: #800000">'</span><span style="color: #800000">login.html</span><span style="color: #800000">'</span>), name=<span style="color: #800000">'</span><span style="color: #800000">login</span><span style="color: #800000">'</span><span style="color: #000000">),
    url(r</span><span style="color: #800000">'</span><span style="color: #800000">^deng_lu</span><span style="color: #800000">'</span>, deng_lu.as_view(), name=<span style="color: #800000">'</span><span style="color: #800000">deng_lu</span><span style="color: #800000">'</span><span style="color: #000000">),
    url(r</span><span style="color: #800000">'</span><span style="color: #800000">^logout</span><span style="color: #800000">'</span>, logout.as_view(), name=<span style="color: #800000">'</span><span style="color: #800000">deng_lu</span><span style="color: #800000">'</span><span style="color: #000000">),

    </span><span style="color: #008000">#</span><span style="color: #008000"> 授课机构</span>
    url(r<span style="color: #800000">'</span><span style="color: #800000">^org_list.html</span><span style="color: #800000">'</span>, org_list.as_view(), name=<span style="color: #800000">'</span><span style="color: #800000">org_list</span><span style="color: #800000">'</span><span style="color: #000000">),

    </span><span style="color: #008000">#</span><span style="color: #008000"> 专门处理静态资源请求映射，也就是media上传文件夹里的请求映射</span>
    <span style="background-color: #ff99cc">url(r<span style="color: #800000">'</span><span style="color: #800000">media/(?P&lt;path&gt;.*)$</span><span style="color: #800000">'</span>, serve, {<span style="color: #800000">'</span><span style="color: #800000">document_root</span><span style="color: #800000">'</span></span><span style="color: #000000"><span style="background-color: #ff99cc">: MEDIA_ROOT})　　<span style="color: #008080"># MEDIA_ROOT为配置上传文件的路径变量</span></span>
]</span></pre>
</div>
<p><strong>此时后台可以显示图片了</strong></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>前台显示可以通过settings.py配置的上传资源前缀名称来拼接路径显示</strong></span></p>
<p><span style="color: #ff0000"><strong>HTML文件</strong></span></p>
<div class="cnblogs_code">
<pre>                                &lt;a href=<span style="color: #800000">"</span><span style="color: #800000">org-detail-homepage.html</span><span style="color: #800000">"</span>&gt;
                                    &lt;img width=<span style="color: #800000">"</span><span style="color: #800000">200</span><span style="color: #800000">"</span> height=<span style="color: #800000">"</span><span style="color: #800000">120</span><span style="color: #800000">"</span> <span style="color: #0000ff">class</span>=<span style="color: #800000">"</span><span style="color: #800000">scrollLoading</span><span style="color: #800000">"</span><span style="color: #000000">
                                         data</span>-url=<span style="color: #800000">"</span><span style="color: #800000"><span style="background-color: #ffff00">{{ MEDIA_URL }}</span><span style="background-color: #ff99cc">{{ ji.image }}</span></span><span style="color: #800000">"</span>/&gt;         {<span style="color: #008000">#</span><span style="color: #008000"> 需要拼接静态资源路径 #}</span>
                                &lt;/a&gt;</pre>
</div>
<p><span style="color: #ff0000"><strong>注意：如果在html文件要获取到settings.py配置的MEDIA_URL，需要在配置文件设置一个静态资源处理类</strong></span></p>
<div class="cnblogs_code">
<pre>TEMPLATES =<span style="color: #000000"> [
    {
        </span><span style="color: #800000">'</span><span style="color: #800000">BACKEND</span><span style="color: #800000">'</span>: <span style="color: #800000">'</span><span style="color: #800000">django.template.backends.django.DjangoTemplates</span><span style="color: #800000">'</span><span style="color: #000000">,
        </span><span style="color: #800000">'</span><span style="color: #800000">DIRS</span><span style="color: #800000">'</span>: [os.path.join(BASE_DIR, <span style="color: #800000">'</span><span style="color: #800000">templates</span><span style="color: #800000">'</span>)],                      <span style="color: #008000">#</span><span style="color: #008000"> 配置模板文件路径，也就是html路径</span>
        <span style="color: #800000">'</span><span style="color: #800000">APP_DIRS</span><span style="color: #800000">'</span><span style="color: #000000">: True,
        </span><span style="color: #800000">'</span><span style="color: #800000">OPTIONS</span><span style="color: #800000">'</span><span style="color: #000000">: {
            </span><span style="color: #800000">'</span><span style="color: #800000">context_processors</span><span style="color: #800000">'</span><span style="color: #000000">: [
                </span><span style="color: #800000">'</span><span style="color: #800000">django.template.context_processors.debug</span><span style="color: #800000">'</span><span style="color: #000000">,
                </span><span style="color: #800000">'</span><span style="color: #800000">django.template.context_processors.request</span><span style="color: #800000">'</span><span style="color: #000000">,
                </span><span style="color: #800000">'</span><span style="color: #800000">django.contrib.auth.context_processors.auth</span><span style="color: #800000">'</span><span style="color: #000000">,
                </span><span style="color: #800000">'</span><span style="color: #800000">django.contrib.messages.context_processors.messages</span><span style="color: #800000">'</span><span style="color: #000000">,
                </span><span style="background-color: #ff99cc"><span style="color: #800000">'</span><span style="color: #800000">django.template.context_processors.media</span><span style="color: #800000">'</span>,                 <span style="color: #008000">#</span><span style="color: #008000"> 配置html页面获取MEDIA_URL路径</span></span>
<span style="color: #000000">            ],
        },
    },
]</span></pre>
</div>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>&nbsp;</strong></span></p>
<p>&nbsp;</p></div>