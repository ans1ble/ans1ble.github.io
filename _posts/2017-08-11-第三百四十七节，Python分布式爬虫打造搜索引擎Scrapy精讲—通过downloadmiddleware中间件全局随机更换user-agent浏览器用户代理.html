第三百四十七节，Python分布式爬虫打造搜索引擎Scrapy精讲—通过downloadmiddleware中间件全局随机更换user-agent浏览器用户代理


			<div id="cnblogs_post_body" class="blogpost-body"><p><strong>第三百四十七节，Python分布式爬虫打造搜索引擎Scrapy精讲—通过downloadmiddleware随机更换user-agent浏览器用户代理</strong></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>downloadmiddleware介绍</strong></span><br><strong>中间件是一个框架，可以连接到请求/响应处理中。这是一种很轻的、低层次的系统，可以改变Scrapy的请求和回应。也就是在Requests请求和Response响应之间的中间件，可以全局的修改<strong>Requests请求和Response响应</strong></strong></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong><strong><span style="color: #0000ff">UserAgentMiddleware()</span>方法，默认中间件</strong></strong></span></p>
<p><span style="color: #ff0000"><strong>源码里<strong><span style="color: #0000ff">downloadmiddleware</span>里的<span style="color: #0000ff">useragent.py</span>下的<span style="color: #0000ff">UserAgentMiddleware()</span>方法，默认中间件</strong></strong></span></p>
<p><span style="color: #000000"><strong><strong>我们可以从源码看到当</strong></strong></span><strong>Requests请求时默认的User-Agent是Scrapy，这个很容易被网站识别而拦截爬虫</strong></p>
<p><strong><img src="https://images2017.cnblogs.com/blog/955761/201708/955761-20170811131007492-523062920.png" alt=""></strong></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>我们可以修改默认中间件<strong><strong><span style="color: #0000ff">UserAgentMiddleware()</span>来</strong></strong>随机更换<span style="color: #0000ff">Requests</span>请求头信息的<span style="color: #0000ff">User-Agent</span>浏览器用户代理</strong></span></p>
<p><span style="color: #ff0000"><strong>第一步、在settings.py配置文件，开启中间件注册<span style="color: #0000ff">DOWNLOADER_MIDDLEWARES={ }</span></strong></span></p>
<p><span style="color: #000000"><strong>将默认的将默认的<span style="color: #0000ff">UserAgentMiddleware</span>设置为None，或者设置成最大就最后执行，这样我们自定义的中间件修改默认的user_agent就会先执行</strong></span></p>
<p><span style="color: #0000ff"><strong><strong>settings.py配置文件</strong></strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000"> Enable or disable downloader middlewares</span><span style="color: #008000">
#</span><span style="color: #008000"> See http://scrapy.readthedocs.org/en/latest/topics/downloader-middleware.html</span>
<span style="color: #000000">
DOWNLOADER_MIDDLEWARES </span>= {              <span style="color: #008000">#</span><span style="color: #008000">开启注册中间件</span>
   <span style="background-color: #ff99cc"><span style="color: #800000">'</span><span style="color: #800000">scrapy.downloadermiddlewares.useragent.UserAgentMiddleware</span><span style="color: #800000">'</span>: None, <span style="color: #008000">#</span><span style="color: #008000">将默认的UserAgentMiddleware设置为None</span></span>
}</pre>
</div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><strong><span style="color: #ff0000">第二步、安装浏览器用户代理模块</span><span style="color: #0000ff">fake-useragent 0.1.7</span></strong></p>
<p><span style="color: #000000"><strong><strong>fake-useragent 是一个专门用于爬虫伪装浏览器User-Agent请求头的模块。此模块在线维护了各个浏览器的各种版本库，提供我们使用</strong></strong></span></p>
<p><span style="color: #000000"><strong><strong>在线各种浏览器信息：<span style="color: #0000ff">http://fake-useragent.herokuapp.com/browsers/0.1.7</span> &nbsp; &nbsp; 0.1.7版本，<strong>fake-useragent会随机到这里调用浏览器代理</strong></strong></strong></span></p>
<p><span style="color: #0000ff"><strong><strong><strong>首先安装这个模块</strong></strong></strong></span></p>
<div class="cnblogs_code">
<pre>pip install fake-useragent</pre>
</div>
<p><span style="color: #0000ff"><strong><strong><strong>使用说明：</strong></strong></strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf8 -*-</span>

<span style="color: #0000ff">from</span> fake_useragent <span style="color: #0000ff">import</span> UserAgent  <span style="color: #008000">#</span><span style="color: #008000">导入浏览器代理模块</span>
ua = UserAgent()                      <span style="color: #008000">#</span><span style="color: #008000">实例化浏览器代理类</span>
<span style="color: #000000">
ua.ie                                 </span><span style="color: #008000">#</span><span style="color: #008000">随机获取IE类型的代理</span><span style="color: #008000">
#</span><span style="color: #008000"> Mozilla/5.0 (Windows; U; MSIE 9.0; Windows NT 9.0; en-US);</span>
ua.msie                               <span style="color: #008000">#</span><span style="color: #008000">随机获取msie类型的代理，下面的相同</span><span style="color: #008000">
#</span><span style="color: #008000"> Mozilla/5.0 (compatible; MSIE 10.0; Macintosh; Intel Mac OS X 10_7_3; Trident/6.0)'</span>
ua[<span style="color: #800000">'</span><span style="color: #800000">Internet Explorer</span><span style="color: #800000">'</span><span style="color: #000000">]
</span><span style="color: #008000">#</span><span style="color: #008000"> Mozilla/5.0 (compatible; MSIE 8.0; Windows NT 6.1; Trident/4.0; GTB7.4; InfoPath.2; SV1; .NET CLR 3.3.69573; WOW64; en-US)</span>
<span style="color: #000000">ua.opera
</span><span style="color: #008000">#</span><span style="color: #008000"> Opera/9.80 (X11; Linux i686; U; ru) Presto/2.8.131 Version/11.11</span>
<span style="color: #000000">ua.chrome
</span><span style="color: #008000">#</span><span style="color: #008000"> Mozilla/5.0 (Windows NT 6.1) AppleWebKit/537.2 (KHTML, like Gecko) Chrome/22.0.1216.0 Safari/537.2'</span>
<span style="color: #000000">ua.google
</span><span style="color: #008000">#</span><span style="color: #008000"> Mozilla/5.0 (Macintosh; Intel Mac OS X 10_7_4) AppleWebKit/537.13 (KHTML, like Gecko) Chrome/24.0.1290.1 Safari/537.13</span>
ua[<span style="color: #800000">'</span><span style="color: #800000">google chrome</span><span style="color: #800000">'</span><span style="color: #000000">]
</span><span style="color: #008000">#</span><span style="color: #008000"> Mozilla/5.0 (X11; CrOS i686 2268.111.0) AppleWebKit/536.11 (KHTML, like Gecko) Chrome/20.0.1132.57 Safari/536.11</span>
<span style="color: #000000">ua.firefox
</span><span style="color: #008000">#</span><span style="color: #008000"> Mozilla/5.0 (Windows NT 6.2; Win64; x64; rv:16.0.1) Gecko/20121011 Firefox/16.0.1</span>
<span style="color: #000000">ua.ff
</span><span style="color: #008000">#</span><span style="color: #008000"> Mozilla/5.0 (X11; Ubuntu; Linux i686; rv:15.0) Gecko/20100101 Firefox/15.0.1</span>
<span style="color: #000000">ua.safari
</span><span style="color: #008000">#</span><span style="color: #008000"> Mozilla/5.0 (iPad; CPU OS 6_0 like Mac OS X) AppleWebKit/536.26 (KHTML, like Gecko) Version/6.0 Mobile/10A5355d Safari/8536.25</span>

<span style="color: #008000">#</span><span style="color: #008000"> and the best one, random via real world browser usage statistic</span>
ua.random                               <span style="color: #008000">#</span><span style="color: #008000">随机获取各种浏览器类型的代理，</span></pre>
</div>
<p><strong>更多使用&nbsp;<span style="color: #0000ff">https://pypi.python.org/pypi/fake-useragent/0.1.7</span></strong></p>
<p><br><br></p>
<p><span style="color: #ff0000"><strong>第三步、自定义中间件来全局随机更换<span style="color: #0000ff">Requests</span>请求头信息的<span style="color: #0000ff">User-Agent</span>浏览器用户代理</strong></span></p>
<p><strong>在<span style="color: #0000ff">middlewares.py</span>文件里，自定义中间件</strong></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000"> -*- coding: utf-8 -*-</span>

<span style="color: #008000">#</span><span style="color: #008000"> Define here the models for your spider middleware</span><span style="color: #008000">
#
#</span><span style="color: #008000"> See documentation in:</span><span style="color: #008000">
#</span><span style="color: #008000"> http://doc.scrapy.org/en/latest/topics/spider-middleware.html</span>

<span style="color: #0000ff">from</span> scrapy <span style="color: #0000ff">import</span><span style="color: #000000"> signals
</span><span style="color: #0000ff">from</span> fake_useragent <span style="color: #0000ff">import</span> <span style="background-color: #ffff00">UserAgent</span>    <span style="color: #008000">#</span><span style="color: #008000">导入浏览器用户代理模块</span>

<span style="color: #0000ff">class</span> RequestsUserAgentmiddware(object):                                    <span style="color: #008000">#</span><span style="color: #008000">自定义浏览器代理中间件</span>
    <span style="color: #008000">#</span><span style="color: #008000">随机更换Requests请求头信息的User-Agent浏览器用户代理</span>
<span style="background-color: #ff99cc">    <span style="color: #0000ff">def</span> <span style="color: #800080">__init__</span><span style="color: #000000">(self,crawler):
        super(RequestsUserAgentmiddware, self).</span><span style="color: #800080">__init__</span>()                   <span style="color: #008000">#</span><span style="color: #008000">获取上一级父类基类的，__init__方法里的对象封装值</span>
        <span style="background-color: #ffff00">self.ua = UserAgent()</span>                                               <span style="color: #008000">#</span><span style="color: #008000">实例化浏览器用户代理模块类</span>
        <span style="background-color: #ffff00">self.ua_type = crawler.settings.get(<span style="color: #800000">'</span><span style="color: #800000">RANDOM_UA_TYPE</span><span style="color: #800000">'</span>,<span style="color: #800000">'</span><span style="color: #800000">random</span><span style="color: #800000">'</span>)</span>      <span style="color: #008000">#</span><span style="color: #008000">获取settings.py配置文件里的RANDOM_UA_TYPE配置的浏览器类型，如果没有，默认random，随机获取各种浏览器类型</span>
<span style="color: #000000">
    @classmethod                                                            </span><span style="color: #008000">#</span><span style="color: #008000">函数上面用上装饰符@classmethod，函数里有一个必写形式参数cls用来接收当前类名称</span>
    <span style="color: #0000ff">def</span> from_crawler(cls, crawler):                                         <span style="color: #008000">#</span><span style="color: #008000">重载from_crawler方法</span>
        <span style="color: #0000ff">return</span> cls(crawler)                                                 <span style="color: #008000">#</span><span style="color: #008000">将crawler爬虫返回给类</span></span>

<span style="background-color: #ff99cc">    <span style="color: #0000ff">def</span> process_request(self, request, spider):                             <span style="color: #008000">#</span><span style="color: #008000">重载process_request方法</span>
        <span style="color: #0000ff">def</span> get_ua():                                                       <span style="color: #008000">#</span><span style="color: #008000">自定义函数，返回浏览器代理对象里指定类型的浏览器信息</span>
            <span style="color: #0000ff">return</span><span style="color: #000000"><span style="background-color: #ffff00"> getattr(self.ua, self.ua_type)</span>
        request.headers.setdefault(</span><span style="background-color: #ffff00"><span style="color: #800000">'</span><span style="color: #800000">User-Agent</span><span style="color: #800000">'</span>,</span> <span style="background-color: #ffff00">get_ua()</span>)                  <span style="color: #008000">#</span><span style="color: #008000">将浏览器代理信息添加到Requests请求</span></span></pre>
</div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>第四步、将我们自定义的中间件注册到</strong></span><span style="color: #0000ff"><strong>settings.py</strong></span><span style="color: #ff0000"><strong>配置文件，的<span style="color: #0000ff">DOWNLOADER_MIDDLEWARES里</span></strong></span></p>
<p><span style="color: #000000"><strong>注意一点要把默认的<span style="color: #0000ff">UserAgentMiddleware</span>中间件设置为<span style="color: #0000ff">None</span>，使其我们自定义的中间件生效</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000"> Enable or disable downloader middlewares</span><span style="color: #008000">
#</span><span style="color: #008000"> See http://scrapy.readthedocs.org/en/latest/topics/downloader-middleware.html</span>
<span style="color: #000000">
DOWNLOADER_MIDDLEWARES </span>= {              <span style="color: #008000">#</span><span style="color: #008000">开启注册中间件</span>
   <span style="background-color: #ff99cc"><span style="color: #800000">'</span><span style="color: #800000">adc.middlewares.RequestsUserAgentmiddware</span><span style="color: #800000">'</span>: 543<span style="color: #000000">,
   </span></span><span style="color: #800000">'</span><span style="color: #800000">scrapy.downloadermiddlewares.useragent.UserAgentMiddleware</span><span style="color: #800000">'</span>: None, <span style="color: #008000">#</span><span style="color: #008000">将默认的UserAgentMiddleware设置为None</span>
}</pre>
</div>
<p><span style="color: #ff0000"><strong>我们可以打断点调试一下，看看是否生效</strong></span></p>
<p><span style="color: #ff0000"><strong><img src="https://images2017.cnblogs.com/blog/955761/201708/955761-20170811164347570-311871567.png" alt=""></strong></span></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>原理说明图</strong></span></p>
<p><span style="color: #ff0000"><strong><img src="https://images2017.cnblogs.com/blog/955761/201708/955761-20170811170356648-966031559.png" alt=""></strong></span></p>
<p>&nbsp;</p></div>