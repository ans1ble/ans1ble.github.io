第二百八十六节，MySQL数据库-MySQL事务操作(回滚)


			<div id="cnblogs_post_body" class="blogpost-body"><p><strong>MySQL数据库-MySQL事务操作(回滚)<br><br></strong></p>
<p><span style="color: #ff0000"><strong>事务用于将某些操作的多个SQL作为原子性操作，一旦有某一个出现错误，即可回滚到原来的状态，从而保证数据库数据完整性。</strong></span></p>
<p>&nbsp;</p>
<p><span style="color: #0000ff"><strong>举例：有这样一张表</strong></span></p>
<p><span style="color: #0000ff"><strong><img src="https://images2015.cnblogs.com/blog/955761/201706/955761-20170615180928587-1239485911.png" alt=""></strong></span></p>
<p>&nbsp;</p>
<p><span style="color: #0000ff"><strong>从表里可以看出张三的资金里有850元，李四的资金有632元</strong></span></p>
<p><span style="color: #0000ff"><strong>假如张三向李四划款20元，那么张三的资金应该减20，李四的资金应该加20</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff">UPDATE</span> usr <span style="color: #0000ff">SET</span> zij <span style="color: #808080">=</span> zij <span style="color: #808080">-</span> <span style="color: #800000; font-weight: bold">20</span> <span style="color: #0000ff">WHERE</span> yhm <span style="color: #808080">=</span> <span style="color: #ff0000">'</span><span style="color: #ff0000">张三</span><span style="color: #ff0000">'</span><span style="color: #000000">;
</span><span style="color: #0000ff">UPDATE</span> usr <span style="color: #0000ff">SET</span> zij <span style="color: #808080">=</span> zij <span style="color: #808080">+</span> <span style="color: #800000; font-weight: bold">20</span> <span style="color: #0000ff">WHERE</span> yhm <span style="color: #808080">=</span> <span style="color: #ff0000">'</span><span style="color: #ff0000">李四</span><span style="color: #ff0000">'</span>;</pre>
</div>
<p><img src="https://images2015.cnblogs.com/blog/955761/201706/955761-20170615183139775-1399463760.png" alt=""></p>
<p><span style="color: #0000ff"><strong>可以看到张三的资金以减20，李四的资金以加20</strong></span></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>但是如果在李四资金加的时候SQL语句出错，那么就会导致张三减少20成功，李四加上20失败，张三的资金减少了，李四资金没加上，钱就失踪了</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff">UPDATE</span> usr <span style="color: #0000ff">SET</span> zij <span style="color: #808080">=</span> zij <span style="color: #808080">-</span> <span style="color: #800000; font-weight: bold">20</span> <span style="color: #0000ff">WHERE</span> yhm <span style="color: #808080">=</span> <span style="color: #ff0000">'</span><span style="color: #ff0000">张三</span><span style="color: #ff0000">'</span><span style="color: #000000">;
</span><span style="color: #0000ff">UPDATE</span> <span style="background-color: #ff99cc">usr2</span> <span style="color: #0000ff">SET</span> zij <span style="color: #808080">=</span> zij <span style="color: #808080">+</span> <span style="color: #800000; font-weight: bold">20</span> <span style="color: #0000ff">WHERE</span> yhm <span style="color: #808080">=</span> <span style="color: #ff0000">'</span><span style="color: #ff0000">李四</span><span style="color: #ff0000">'</span>;</pre>
</div>
<p><img src="https://images2015.cnblogs.com/blog/955761/201706/955761-20170615184205275-1229833586.png" alt=""></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000; background-color: #ffff00"><strong>定义一个存储过程来执行事务（回滚）</strong></span></p>
<p><span style="color: #ff0000"><strong>TRANSACTION表示事务</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #000000">delimiter $$
</span><span style="color: #0000ff">DROP</span> <span style="color: #0000ff">PROCEDURE</span> <span style="color: #0000ff">IF</span> <span style="color: #808080">EXISTS</span><span style="color: #000000"> p1;
</span><span style="color: #0000ff">create</span> <span style="color: #0000ff">PROCEDURE</span> p1(  <span style="color: #008080">--</span><span style="color: #008080"> 创建存储过程</span>
    OUT p_return_code <span style="color: #0000ff">tinyint</span>   <span style="color: #008080">--</span><span style="color: #008080"> out类型参数，用于返回值</span>
<span style="color: #000000">)
</span><span style="color: #0000ff">BEGIN</span> 
  <span style="background-color: #ffff00"><span style="color: #0000ff">DECLARE</span> <span style="color: #0000ff">exit</span> handler <span style="color: #0000ff">for</span> sqlexception  <span style="color: #008080">--</span><span style="color: #008080"> 捕捉错误，如果是sql错误就执行里面的</span>
  <span style="color: #0000ff">BEGIN</span> 
    <span style="color: #008080">--</span><span style="color: #008080"> ERROR </span>
    <span style="color: #0000ff">set</span> p_return_code <span style="color: #808080">=</span> <span style="color: #800000; font-weight: bold">1</span>;  <span style="color: #008080">--</span><span style="color: #008080"> 返回值1,说明sql错误</span>
    <span style="color: #0000ff">rollback</span>;   <span style="color: #008080">--</span><span style="color: #008080"> 回滚数据</span>
  <span style="color: #0000ff">END</span></span><span style="color: #000000"><span style="background-color: #ffff00">;</span> 
 
  </span><span style="background-color: #ffcc99"><span style="color: #0000ff">DECLARE</span> <span style="color: #0000ff">exit</span> handler <span style="color: #0000ff">for</span> sqlwarning   <span style="color: #008080">--</span><span style="color: #008080"> 捕捉错误，如果是sql警告就执行里面的</span>
  <span style="color: #0000ff">BEGIN</span> 
    <span style="color: #008080">--</span><span style="color: #008080"> WARNING </span>
    <span style="color: #0000ff">set</span> p_return_code <span style="color: #808080">=</span> <span style="color: #800000; font-weight: bold">2</span>;  <span style="color: #008080">--</span><span style="color: #008080"> 返回值2，说明出现sql警告</span>
    <span style="color: #0000ff">rollback</span>;  <span style="color: #008080">--</span><span style="color: #008080"> 回滚数据</span>
  <span style="color: #0000ff">END</span></span><span style="color: #000000"><span style="background-color: #ffcc99">;</span> 
 
  <span style="background-color: #ccffcc">START </span></span><span style="background-color: #ccffcc"><span style="color: #0000ff">TRANSACTION</span>;  <span style="color: #008080">--</span><span style="color: #008080"> 开始事务</span>
        <span style="color: #008080">--</span><span style="color: #008080"> 执行sql语句</span>
        <span style="color: #0000ff">UPDATE</span> usr <span style="color: #0000ff">SET</span> zij <span style="color: #808080">=</span> zij <span style="color: #808080">-</span> <span style="color: #800000; font-weight: bold">20</span> <span style="color: #0000ff">WHERE</span> yhm <span style="color: #808080">=</span> <span style="color: #ff0000">'</span><span style="color: #ff0000">张三</span><span style="color: #ff0000">'</span><span style="color: #000000">;
        </span><span style="color: #0000ff">UPDATE</span> <span style="color: #ff0000; background-color: #ff99cc">usr2</span> <span style="color: #0000ff">SET</span> zij <span style="color: #808080">=</span> zij <span style="color: #808080">+</span> <span style="color: #800000; font-weight: bold">20</span> <span style="color: #0000ff">WHERE</span> yhm <span style="color: #808080">=</span> <span style="color: #ff0000">'</span><span style="color: #ff0000">李四</span><span style="color: #ff0000">'</span><span style="color: #000000">;
  </span><span style="color: #0000ff">COMMIT</span>;  <span style="color: #008080">--</span><span style="color: #008080"> 提交</span>
 
  <span style="color: #008080">--</span><span style="color: #008080"> SUCCESS </span>
  <span style="color: #0000ff">set</span> p_return_code <span style="color: #808080">=</span> <span style="color: #800000; font-weight: bold">0</span>; <span style="color: #008080">--</span><span style="color: #008080"> 返回0说明成功</span></span>
 
<span style="color: #0000ff">END</span><span style="color: #000000"> $$
delimiter ;</span></pre>
</div>
<p><span style="color: #ff0000; background-color: #ffff00"><strong>执行存储过程，执行事务</strong></span></p>
<div class="cnblogs_code">
<pre>CALL p1(<span style="color: #008000">@u</span>); <span style="color: #008080">--</span><span style="color: #008080"> 执行存储过程。传参接收返回值</span>
<span style="color: #0000ff">SELECT</span> <span style="color: #008000">@u</span>;  <span style="color: #008080">--</span><span style="color: #008080"> 查看返回值</span></pre>
</div>
<p><img src="https://images2015.cnblogs.com/blog/955761/201706/955761-20170615194427462-634475271.png" alt=""></p>
<p><span style="color: #ff0000"><strong>可以看到返回1，说明sql错误，事务里的sql语句<strong>一旦有出现错误，将进行所有数据回滚，也就是无论成功的还是失败的语句都数据不变</strong></strong></span></p>
<p><span style="color: #ff0000"><strong><img src="https://images2015.cnblogs.com/blog/955761/201706/955761-20170615194956009-1135859424.png" alt=""></strong></span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000; background-color: #ffff00"><strong>pymysql模块，默认开启了事务（回滚），也就是说<strong>pymysql模块自动实现了事务（回滚）</strong>【重点】</strong></span></p>
<p><span style="color: #ff0000; background-color: #ffff00"><strong><img src="https://images2015.cnblogs.com/blog/955761/201706/955761-20170615195235900-1218135870.png" alt=""></strong></span></p>
<p><span style="color: #ff0000; background-color: #ffffff"><strong>还是上面的列子，将一个sql语句写错</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000">coding:utf-8</span>

<span style="color: #0000ff">import</span><span style="color: #000000"> tornado.ioloop
</span><span style="color: #0000ff">import</span> tornado.web                                              <span style="color: #008000">#</span><span style="color: #008000">导入tornado模块下的web文件</span>
<span style="color: #0000ff">import</span> pymysql                                                  <span style="color: #008000">#</span><span style="color: #008000">导入数据库模块</span>

<span style="color: #0000ff">class</span><span style="color: #000000"> khdHandler(tornado.web.RequestHandler):
    </span><span style="color: #0000ff">def</span><span style="color: #000000"> get(self):

        </span><span style="color: #008000">#</span><span style="color: #008000">连接数据库</span>
        conn = pymysql.connect(host=<span style="color: #800000">'</span><span style="color: #800000">127.0.0.1</span><span style="color: #800000">'</span>, port=3306, user=<span style="color: #800000">'</span><span style="color: #800000">root</span><span style="color: #800000">'</span>, passwd=<span style="color: #800000">'</span><span style="color: #800000">279819</span><span style="color: #800000">'</span>, db=<span style="color: #800000">'</span><span style="color: #800000">cshi</span><span style="color: #800000">'</span>,charset=<span style="color: #800000">'</span><span style="color: #800000">utf8</span><span style="color: #800000">'</span><span style="color: #000000">)
        </span><span style="color: #008000">#</span><span style="color: #008000"> 创建游标</span>
        cursor = conn.cursor(cursor=<span style="color: #000000">pymysql.cursors.DictCursor)

        </span><span style="color: #008000">#</span><span style="color: #008000">获取存储过程(函数)的返回值</span>
        <span style="background-color: #ffff00">effect_row = cursor.execute(<span style="color: #800000">"</span><span style="color: #800000">UPDATE usr SET zij = zij - 20 WHERE yhm = '张三'</span><span style="color: #800000">"</span><span style="color: #000000">)
        effect_row </span>= cursor.execute(<span style="color: #800000">"</span><span style="color: #800000">UPDATE <span style="background-color: #ff99cc">usr2</span> SET zij = zij + 20 WHERE yhm = '李四'</span><span style="color: #800000">"</span></span><span style="color: #000000"><span style="background-color: #ffff00">)</span>
        fhuizhi </span>=<span style="color: #000000"> cursor.fetchone()
        </span><span style="color: #0000ff">print</span><span style="color: #000000">(fhuizhi)


        </span><span style="color: #008000">#</span><span style="color: #008000"> 提交，不然无法保存新建或者修改的数据</span>
<span style="color: #000000">        conn.commit()

        </span><span style="color: #008000">#</span><span style="color: #008000"> 关闭游标</span>
<span style="color: #000000">        cursor.close()
        </span><span style="color: #008000">#</span><span style="color: #008000"> 关闭连接</span>
<span style="color: #000000">        conn.close()

        self.write(</span><span style="color: #800000">"</span><span style="color: #800000">欢迎访问</span><span style="color: #800000">"</span><span style="color: #000000">)


settings </span>= {                                            <span style="color: #008000">#</span><span style="color: #008000">html文件归类配置，设置一个字典</span>
    <span style="color: #800000">"</span><span style="color: #800000">template_path</span><span style="color: #800000">"</span>:<span style="color: #800000">"</span><span style="color: #800000">views</span><span style="color: #800000">"</span>,                            <span style="color: #008000">#</span><span style="color: #008000">键为template_path固定的，值为要存放HTML的文件夹名称</span>
    <span style="color: #800000">"</span><span style="color: #800000">static_path</span><span style="color: #800000">"</span>:<span style="color: #800000">"</span><span style="color: #800000">statics</span><span style="color: #800000">"</span>,                            <span style="color: #008000">#</span><span style="color: #008000">键为static_path固定的，值为要存放js和css的文件夹名称</span>
<span style="color: #000000">}

</span><span style="color: #008000">#</span><span style="color: #008000">路由映射</span>
application = tornado.web.Application([                 <span style="color: #008000">#</span><span style="color: #008000">创建一个变量等于tornado.web下的Application方法</span>
    (r<span style="color: #800000">"</span><span style="color: #800000">/khd</span><span style="color: #800000">"</span><span style="color: #000000">, khdHandler),
],</span>**settings)                                           <span style="color: #008000">#</span><span style="color: #008000">将html文件归类配置字典，写在路由映射的第二个参数里</span>

<span style="color: #0000ff">if</span> <span style="color: #800080">__name__</span> == <span style="color: #800000">"</span><span style="color: #800000">__main__</span><span style="color: #800000">"</span><span style="color: #000000">:
    </span><span style="color: #008000">#</span><span style="color: #008000">内部socket运行起来</span>
    application.listen(8002)                            <span style="color: #008000">#</span><span style="color: #008000">设置端口</span>
    tornado.ioloop.IOLoop.instance().start()</pre>
</div>
<p><span style="color: #ff0000"><strong>当执行时可以看到，提示第二个语句表名称是错误的，但是第一个应该是执行成功的</strong></span></p>
<p><span style="color: #ff0000"><strong><img src="https://images2015.cnblogs.com/blog/955761/201706/955761-20170615200329400-1968928041.png" alt=""></strong></span></p>
<p><span style="color: #ff0000"><strong>在这种情况下，可以看到<strong>pymysql模块自动实现了事务（回滚），数据库数据没有改变</strong></strong></span></p>
<p><span style="color: #ff0000"><strong><img src="https://images2015.cnblogs.com/blog/955761/201706/955761-20170615200527728-873959481.png" alt=""></strong></span></p>
<p>&nbsp;</p></div>