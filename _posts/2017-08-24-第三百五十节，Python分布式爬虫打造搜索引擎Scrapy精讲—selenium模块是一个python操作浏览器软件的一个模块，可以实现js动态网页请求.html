第三百五十节，Python分布式爬虫打造搜索引擎Scrapy精讲—selenium模块是一个python操作浏览器软件的一个模块，可以实现js动态网页请求


			<div id="cnblogs_post_body" class="blogpost-body"><p><br><strong>第三百五十节，Python分布式爬虫打造搜索引擎Scrapy精讲—selenium模块是一个python操作浏览器软件的一个模块，可以实现js动态网页请求</strong></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong><strong>selenium模块</strong></strong></span></p>
<p><span style="color: #000000"><strong><strong><strong>selenium模块为第三方模块需要安装，<strong>selenium模块是一个操作各种浏览器对应软件的api接口模块</strong></strong></strong></strong></span></p>
<p><span style="color: #000000"><strong><strong><strong><strong><strong><strong><strong><strong>selenium模块是一个操作各种浏览器对应软件的api接口模块，所以还得需要下载对应浏览器的操作软件</strong></strong></strong></strong></strong></strong></strong></strong></span></p>
<p><span style="color: #ff0000"><strong><strong><strong><strong><strong><strong><strong><strong>操作原理是：<strong><strong>selenium模块操作浏览器操作软件，<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>浏览器操作软件操作浏览器</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></span></p>
<p><span style="color: #ff0000"><strong>Selenium 2.0适用于以下浏览器</strong></span><br><strong>　　Google Chrome</strong><br><strong>　　Internet Explorer 7, 8, 9, 10, 11</strong><br><strong>　　Firefox</strong><br><strong>　　Safari</strong><br><strong>　　Opera</strong><br><strong>　　HtmlUnit</strong><br><strong>　　phantomjs</strong><br><strong>　　Android</strong><br><strong>　　iOS</strong></p>
<p><strong><img src="https://images2017.cnblogs.com/blog/955761/201708/955761-20170824205035746-617336861.png" alt=""></strong></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #0000ff"><strong>Selenium 的核心，就是用js控制浏览器</strong></span></p>
<p><span style="color: #ff0000"><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>下载对应浏览器的<strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>浏览器操作软件</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></span></p>
<p>&nbsp;</p>
<p><strong>Chrome: https://sites.google.com/a/chromium.org/chromedriver/downloads</strong><br><strong>Edge:	https://developer.microsoft.com/en-us/microsoft-edge/tools/webdriver/</strong><br><strong><span style="color: #0000ff">Firefox:	https://github.com/mozilla/geckodriver/releases</span></strong><br><strong>Safari:	https://webkit.org/blog/6900/webdriver-support-in-safari-10/</strong></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>我们这里以火狐浏览器为列</strong></span></p>
<p><span style="color: #0000ff"><strong>首先将火狐浏览器的操作软件，geckodriver.exe文件放置到爬虫目录里</strong></span></p>
<p><span style="color: #ff0000"><strong>selenium模块可以模拟用户行为操作各种版本浏览器</strong></span></p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">webdriver.Firefox('操作浏览器软件路径')</span>实例化火狐浏览器对象</strong></span><br><span style="color: #ff0000"><strong><span style="color: #0000ff">get('url')</span>访问网站</strong></span><br><span style="color: #ff0000"><strong><span style="color: #0000ff">find_element_by_xpath('xpath表达式')</span>通过xpath表达式找对应元素</strong></span><br><span style="color: #ff0000"><strong><span style="color: #0000ff">clear()</span>清空输入框里的内容</strong></span><br><span style="color: #ff0000"><strong><span style="color: #0000ff">send_keys('内容')</span>将内容写入输入框</strong></span><br><span style="color: #ff0000"><strong><span style="color: #0000ff">click()</span>点击事件</strong></span><br><span style="color: #ff0000"><strong><span style="color: #0000ff">get_screenshot_as_file('截图保存路径名称')</span>将网页截图，保存到此目录</strong></span><br><span style="color: #ff0000"><strong><span style="color: #0000ff">page_source</span>获取网页htnl源码</strong></span><br><span style="color: #ff0000"><strong><span style="color: #0000ff">browser.close()</span> 关闭浏览器</strong></span></p>
<p>&nbsp;</p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf8 -*-</span>
<span style="color: #0000ff">from</span> selenium <span style="color: #0000ff">import</span> webdriver  <span style="color: #008000">#</span><span style="color: #008000"> 导入selenium模块来操作浏览器软件</span>
<span style="color: #0000ff">import</span><span style="color: #000000"> time

browser </span>= webdriver.Firefox(executable_path=<span style="color: #800000">'</span><span style="color: #800000">H:/py/16/adc/adc/Firefox/geckodriver.exe</span><span style="color: #800000">'</span><span style="color: #000000">)
browser.get(</span><span style="color: #800000">'</span><span style="color: #800000">https://www.tmall.com/?spm=a220o.1000855.a2226mz.1.5c90c3484bZCx6</span><span style="color: #800000">'</span><span style="color: #000000">)

</span><span style="color: #008000">#</span><span style="color: #008000"> 模拟用户操作</span>
browser.find_element_by_xpath(<span style="color: #800000">'</span><span style="color: #800000">//input[@id="mq"]</span><span style="color: #800000">'</span>).clear()                 <span style="color: #008000">#</span><span style="color: #008000"> 通过xpath表达式找到输入框，clear()清空输入框里的内容</span>
browser.find_element_by_xpath(<span style="color: #800000">'</span><span style="color: #800000">//input[@id="mq"]</span><span style="color: #800000">'</span>).send_keys(<span style="color: #800000">'</span><span style="color: #800000">连衣裙</span><span style="color: #800000">'</span>)     <span style="color: #008000">#</span><span style="color: #008000"> 通过xpath表达式找到输入框，send_keys()将内容写入输入框</span>
browser.find_element_by_xpath(<span style="color: #800000">'</span><span style="color: #800000">//button[@type="submit"]</span><span style="color: #800000">'</span>).click()          <span style="color: #008000">#</span><span style="color: #008000"> 通过xpath表达式找到搜索按钮,click()点击事件</span>
<span style="color: #000000">
time.sleep(</span>3)   <span style="color: #008000">#</span><span style="color: #008000"> 等待3秒</span>
browser.get_screenshot_as_file(<span style="color: #800000">'</span><span style="color: #800000">H:/py/17/img/123.jpg</span><span style="color: #800000">'</span>)  <span style="color: #008000">#</span><span style="color: #008000"> 将网页截图，保存到此目录</span>
<span style="color: #000000">
neir </span>= browser.page_source   <span style="color: #008000">#</span><span style="color: #008000"> 获取网页内容</span>
<span style="color: #0000ff">print</span><span style="color: #000000">(neir)

browser.close()     </span><span style="color: #008000">#</span><span style="color: #008000"> 关闭浏览器</span></pre>
</div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>利用scrapy的Selector方法。来过滤帅选数据</strong></span></p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">Selector()方法</span>,过滤帅选数据,参数是得到的字符串html源码</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf8 -*-</span>
<span style="color: #0000ff">from</span> selenium <span style="color: #0000ff">import</span> webdriver  <span style="color: #008000">#</span><span style="color: #008000"> 导入selenium模块来操作浏览器软件</span>
<span style="color: #0000ff">import</span><span style="color: #000000"> time
</span><span style="background-color: #ff99cc"><span style="color: #0000ff">from</span> scrapy.selector <span style="color: #0000ff">import</span></span><span style="color: #000000"><span style="background-color: #ff99cc"> Selector</span>

browser </span>= webdriver.Firefox(executable_path=<span style="color: #800000">'</span><span style="color: #800000">H:/py/16/adc/adc/Firefox/geckodriver.exe</span><span style="color: #800000">'</span><span style="color: #000000">)
browser.get(</span><span style="color: #800000">'</span><span style="color: #800000">https://www.tmall.com/?spm=a220o.1000855.a2226mz.1.5c90c3484bZCx6</span><span style="color: #800000">'</span><span style="color: #000000">)

</span><span style="color: #008000">#</span><span style="color: #008000"> 模拟用户操作</span>
browser.find_element_by_xpath(<span style="color: #800000">'</span><span style="color: #800000">//input[@id="mq"]</span><span style="color: #800000">'</span>).clear()                 <span style="color: #008000">#</span><span style="color: #008000"> 通过xpath表达式找到输入框，clear()清空输入框里的内容</span>
browser.find_element_by_xpath(<span style="color: #800000">'</span><span style="color: #800000">//input[@id="mq"]</span><span style="color: #800000">'</span>).send_keys(<span style="color: #800000">'</span><span style="color: #800000">连衣裙</span><span style="color: #800000">'</span>)     <span style="color: #008000">#</span><span style="color: #008000"> 通过xpath表达式找到输入框，send_keys()将内容写入输入框</span>
browser.find_element_by_xpath(<span style="color: #800000">'</span><span style="color: #800000">//button[@type="submit"]</span><span style="color: #800000">'</span>).click()          <span style="color: #008000">#</span><span style="color: #008000"> 通过xpath表达式找到搜索按钮,click()点击事件</span>
<span style="color: #000000">
time.sleep(</span>3)   <span style="color: #008000">#</span><span style="color: #008000"> 等待3秒</span>
browser.get_screenshot_as_file(<span style="color: #800000">'</span><span style="color: #800000">H:/py/17/img/123.jpg</span><span style="color: #800000">'</span>)  <span style="color: #008000">#</span><span style="color: #008000"> 将网页截图，保存到此目录</span>
<span style="color: #000000; background-color: #ff99cc">
neir </span>= browser.page_source   <span style="color: #008000">#</span><span style="color: #008000"> 获取网页内容</span><span style="color: #008000">
#</span><span style="color: #008000"> print(neir)</span>
<span style="background-color: #ff99cc">gl_neir = Selector(text=</span><span style="color: #000000"><span style="background-color: #ff99cc">neir)</span>
<span style="background-color: #ff99cc">dedao </span></span><span style="background-color: #ff99cc">= gl_neir.css(<span style="color: #800000">'</span><span style="color: #800000">title::text</span><span style="color: #800000">'</span><span style="color: #000000">).extract()
</span><span style="color: #0000ff">print</span></span><span style="color: #000000"><span style="background-color: #ff99cc">(dedao)
</span>
browser.close()     </span><span style="color: #008000">#</span><span style="color: #008000"> 关闭浏览器</span></pre>
</div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong><strong>selenium操作浏览器滚动滚动条</strong></strong></span></p>
<p><span style="color: #0000ff"><strong><strong>execute_script(js)</strong></strong><span style="color: #ff0000"><strong><strong>方法，执行原生态js脚本</strong></strong></span></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf8 -*-</span>
<span style="color: #0000ff">from</span> selenium <span style="color: #0000ff">import</span> webdriver  <span style="color: #008000">#</span><span style="color: #008000"> 导入selenium模块来操作浏览器软件</span>
<span style="color: #0000ff">import</span><span style="color: #000000"> time
</span><span style="color: #0000ff">from</span> scrapy.selector <span style="color: #0000ff">import</span><span style="color: #000000"> Selector

browser </span>= webdriver.Firefox(executable_path=<span style="color: #800000">'</span><span style="color: #800000">H:/py/16/adc/adc/Firefox/geckodriver.exe</span><span style="color: #800000">'</span><span style="color: #000000">)
browser.get(</span><span style="color: #800000">'</span><span style="color: #800000">https://www.oschina.net/blog</span><span style="color: #800000">'</span><span style="color: #000000">)


<span style="background-color: #ff99cc">time.sleep(</span></span><span style="background-color: #ff99cc">3)       <span style="color: #008000">#</span><span style="color: #008000"> 等待3秒</span>
<span style="color: #0000ff">for</span> i <span style="color: #0000ff">in</span> range(3):  <span style="color: #008000">#</span><span style="color: #008000"> 滚动3次滚动条</span>
    js = <span style="color: #800000">'</span><span style="color: #800000">window.scrollTo(0,document.body.scrollHeight); var lenofpage=document.body.scrollHeight; return lenofpage</span><span style="color: #800000">'</span><span style="color: #000000">
    browser.execute_script(js)  </span><span style="color: #008000">#</span><span style="color: #008000"> 执行js语言滚动滚动条</span>
    time.sleep(3</span><span style="color: #000000"><span style="background-color: #ff99cc">)</span>

neir </span>= browser.page_source   <span style="color: #008000">#</span><span style="color: #008000"> 获取网页内容</span><span style="color: #008000">
#</span><span style="color: #008000"> print(neir)</span>
gl_neir = Selector(text=<span style="color: #000000">neir)
dedao </span>= gl_neir.css(<span style="color: #800000">'</span><span style="color: #800000">title::text</span><span style="color: #800000">'</span><span style="color: #000000">).extract()
</span><span style="color: #0000ff">print</span><span style="color: #000000">(dedao)

</span><span style="color: #008000">#</span><span style="color: #008000"> browser.close()     # 关闭浏览器</span></pre>
</div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>设置请求网页不加载图片，提高请求效率</strong></span><br><span style="color: #ff0000"><strong><span style="color: #0000ff">ChromeOptions()</span>方法，创建谷歌浏览器设置对象</strong></span><br><span style="color: #ff0000"><strong><span style="color: #0000ff">Chrome()</span>方法，创建谷歌浏览器对象</strong></span></p>
<p><span style="color: #ff0000"><strong>下面以谷歌浏览器为列</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf8 -*-</span>
<span style="color: #0000ff">from</span> selenium <span style="color: #0000ff">import</span> webdriver  <span style="color: #008000">#</span><span style="color: #008000"> 导入selenium模块来操作浏览器软件</span>
<span style="color: #0000ff">from</span> scrapy.selector <span style="color: #0000ff">import</span><span style="color: #000000"> Selector

</span><span style="color: #008000">#</span><span style="color: #008000">设置请求网页不加载图片，提高请求效率</span>
<span style="background-color: #ff99cc">chrome_options = webdriver.ChromeOptions()                          <span style="color: #008000">#</span><span style="color: #008000">创建谷歌浏览器设置对象</span>
prefs = {<span style="color: #800000">"</span><span style="color: #800000">profile.managed_default_content_settings.images</span><span style="color: #800000">"</span>: 2}      <span style="color: #008000">#</span><span style="color: #008000">设置谷歌浏览器不加载图片</span>
chrome_options.add_experimental_option(<span style="color: #800000">'</span><span style="color: #800000">prefs</span><span style="color: #800000">'</span>, prefs)              <span style="color: #008000">#</span><span style="color: #008000">将不加载图片添加到浏览器</span>
<span style="color: #000000">
browser </span>= webdriver.Chrome(executable_path=<span style="color: #800000">'</span><span style="color: #800000">H:/py/16/adc/adc/Firefox/chromedriver.exe</span><span style="color: #800000">'</span>, chrome_options=<span style="color: #000000">chrome_options)
</span></span><span style="color: #008000">#</span><span style="color: #008000"> browser.set_page_load_timeout(40) #设置页面最长加载时间为40s</span>
browser.get(<span style="color: #800000">'</span><span style="color: #800000">https://www.taobao.com/</span><span style="color: #800000">'</span><span style="color: #000000">)


neir </span>= browser.page_source   <span style="color: #008000">#</span><span style="color: #008000"> 获取网页内容</span><span style="color: #008000">
#</span><span style="color: #008000"> print(neir)</span>
gl_neir = Selector(text=<span style="color: #000000">neir)
dedao </span>= gl_neir.css(<span style="color: #800000">'</span><span style="color: #800000">title::text</span><span style="color: #800000">'</span><span style="color: #000000">).extract()
</span><span style="color: #0000ff">print</span><span style="color: #000000">(dedao)

</span><span style="color: #008000">#</span><span style="color: #008000"> browser.close()     # 关闭浏览器</span></pre>
</div>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong><strong><strong>selenium模块还可以操作</strong></strong>PhantomJS浏览器，<strong>PhantomJS是一个无界面浏览器，比较清爽，但是多线程是性能会下降</strong></strong></span></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong><strong>重点：我们推荐使用chromedriver.exe，谷歌浏览器</strong></strong></span></p></div>