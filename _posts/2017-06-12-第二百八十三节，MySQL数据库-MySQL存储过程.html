第二百八十三节，MySQL数据库-MySQL存储过程


			<div id="cnblogs_post_body" class="blogpost-body"><p><strong>MySQL数据库-MySQL存储过程</strong></p>
<p><span style="color: #ff0000; font-size: 18pt"><strong><strong>MySQL存储过程，也就是有点像<strong><strong>MySQL函数，但是他与<strong><strong><strong><strong>MySQL函数是有区别的，后面会讲到函数，所以注意区分</strong></strong></strong></strong></strong></strong></strong></strong></span></p>
<p><span style="color: #0000ff"><strong>注意：函数与存储过程的区别</strong></span></p>
<p><span style="color: #0000ff"><strong>存储过程是：CREATE PROCEDURE 创建的</strong></span></p>
<p><span style="color: #0000ff"><strong>函数时：create function 创建的</strong></span></p>
<p><span style="color: #0000ff"><strong>存储过程是：CALL &nbsp;执行的</strong></span></p>
<p><span style="color: #0000ff"><strong>函数时：SELECT 执行的</strong></span></p>
<p><span style="color: #0000ff"><strong>函数里：不支持SQL语句【重点】</strong></span></p>
<p><span style="color: #0000ff"><strong>存储过程里：支持SQL语句【重点】</strong></span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000; background-color: #ffff00"><strong><strong><strong><strong>1、创建存储过程(函数)无参</strong></strong></strong></strong></span></p>
<p><span style="color: #ff0000"><strong>delimiter设置数据库语句结束符，默认是遇到;表示语句结束，delimiter可以自定义语句结束符，后面跟结束符</strong></span><br><span style="color: #ff0000"><strong>create procedure创建存储过程(函数)，后面跟、函数名称()</strong></span><br><span style="color: #ff0000"><strong>BEGIN表示SQL语句开始，后面跟SQL语句</strong></span><br><span style="color: #ff0000"><strong>END表示SQL语句结束</strong></span></p>
<p><span style="color: #0000ff"><strong>举例：有这样一张表</strong></span></p>
<p><span style="color: #ff0000"><strong><img src="https://images2015.cnblogs.com/blog/955761/201706/955761-20170612185530900-1518766776.png" alt=""></strong></span></p>
<p><span style="color: #ff0000"><strong>创建一个usr_nl_20 ()函数，功能是查询<strong>usr表nl字段等于20的数据</strong></strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008080">--</span><span style="color: #008080"> delimiter设置数据库语句结束符，默认是遇到;表示语句结束，delimiter可以自定义语句结束符，后面跟结束符</span><span style="color: #008080">
--</span><span style="color: #008080"> create procedure创建存储过程(函数)，后面跟、函数名称()</span><span style="color: #008080">
--</span><span style="color: #008080"> BEGIN表示SQL语句开始，后面跟SQL语句</span><span style="color: #008080">
--</span><span style="color: #008080"> END表示SQL语句结束</span>

<span style="color: #008080">--</span><span style="color: #008080"> 格式：</span><span style="color: #008080">
--</span><span style="color: #008080"> delimiter $$                                        -- 将语句结束符改为$$</span><span style="color: #008080">
--</span><span style="color: #008080"> create procedure 函数名称()</span><span style="color: #008080">
--</span><span style="color: #008080"> BEGIN                                                    -- SQL语句开始</span><span style="color: #008080">
--</span><span style="color: #008080">     SQL语句</span><span style="color: #008080">
--</span><span style="color: #008080"> END $$                                                    -- SQL语句开始</span><span style="color: #008080">
--</span><span style="color: #008080"> delimiter ;                                        -- 将语句结束符改为默认</span>
<span style="background-color: #ff99cc"><span style="color: #000000">
delimiter $$
</span><span style="color: #0000ff">CREATE</span> <span style="color: #0000ff">PROCEDURE</span><span style="color: #000000"> usr_nl_20 ()
</span><span style="color: #0000ff">BEGIN</span></span>
    <span style="background-color: #ffff00"><span style="color: #0000ff">SELECT</span><span style="color: #000000">
        id,
        yhm,
        xb,
        nl
    </span><span style="color: #0000ff">FROM</span><span style="color: #000000">
        usr
    </span><span style="color: #0000ff">WHERE</span><span style="color: #000000">
        nl </span><span style="color: #808080">=</span> <span style="color: #800000; font-weight: bold">20</span><span style="color: #000000"> ;
</span></span><span style="background-color: #ff99cc"><span style="color: #0000ff">END</span><span style="color: #000000"> $$
delimiter ;</span></span></pre>
</div>
<p><img src="https://images2015.cnblogs.com/blog/955761/201706/955761-20170612185835681-1700989268.png" alt=""></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000; background-color: #ffff00"><strong>2、执行存储过程(函数)</strong></span></p>
<p><span style="color: #ff0000"><strong>call执行存储过程(函数)，后面跟、函数名称()</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008080">--</span><span style="color: #008080"> call执行存储过程(函数)，后面跟、函数名称()</span>
CALL usr_nl_20();</pre>
</div>
<p><img src="https://images2015.cnblogs.com/blog/955761/201706/955761-20170612190541634-84755468.png" alt=""></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000; background-color: #ffff00"><strong>3、删除存储过程(函数)</strong></span></p>
<p><span style="color: #ff0000"><strong>DROP PROCEDURE删除存储过程(函数)，后面跟要删除的函数名称</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008080">--</span><span style="color: #008080"> DROP PROCEDURE删除存储过程(函数)，后面跟要删除的函数名称</span>
<span style="color: #0000ff">DROP</span> <span style="color: #0000ff">PROCEDURE</span> usr_nl_20;</pre>
</div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000; background-color: #ffff00"><strong>4、修改存储过程(函数)</strong></span></p>
<p><span style="color: #ff0000"><strong>一般<strong>函数都不用修改的办法，一般都是删除后重写</strong></strong></span></p>
<p><span style="color: #ff0000"><strong>DROP PROCEDURE删除存储过程(函数)，后面跟要删除的函数名称</strong></span><br><span style="color: #ff0000"><strong>if EXISTS判断后面的变量或者函数是否存在，如果存在执行if EXISTS前面的语句</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008080">--</span><span style="color: #008080"> DROP PROCEDURE删除存储过程(函数)，后面跟要删除的函数名称</span><span style="color: #008080">
--</span><span style="color: #008080"> if EXISTS判断后面的变量或者函数是否存在，如果存在执行if EXISTS前面的语句</span>

<span style="background-color: #ffff00"><span style="color: #0000ff">DROP</span> <span style="color: #0000ff">PROCEDURE</span> <span style="color: #0000ff">if</span> <span style="color: #808080">EXISTS</span> usr_nl_20;</span>        <span style="color: #008080">--</span><span style="color: #008080"> 判断usr_nl_20函数是否存在，如果存在删除函数，如果不存在则不删除</span><span style="color: #008080">
--</span><span style="color: #008080"> 如果存在函数删除后创建函数，不存在创建函数</span>
<span style="background-color: #ff99cc"><span style="color: #000000">delimiter $$
</span><span style="color: #0000ff">CREATE</span> <span style="color: #0000ff">PROCEDURE</span><span style="color: #000000"> usr_nl_20 ()
</span><span style="color: #0000ff">BEGIN</span>
    <span style="color: #0000ff">SELECT</span><span style="color: #000000">
        id,
        yhm,
        xb,
        nl
    </span><span style="color: #0000ff">FROM</span><span style="color: #000000">
        usr
    </span><span style="color: #0000ff">WHERE</span><span style="color: #000000">
        nl </span><span style="color: #808080">=</span> <span style="color: #800000; font-weight: bold">20</span><span style="color: #000000"> ;
</span><span style="color: #0000ff">END</span><span style="color: #000000"> $$
delimiter ;</span></span></pre>
</div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000; background-color: #ffff00"><strong>5、创建存储过程(函数)有参，<strong><span style="color: #0000ff">in</span>&nbsp;仅用于传入参数用</strong></strong></span></p>
<p><span style="color: #ff0000"><strong>对于存储过程，可以接收参数，<span style="color: #0000ff">其形式参数有三种用途类型：</span></strong></span><br><span style="color: #ff0000"><strong>　　<span style="color: #0000ff">in</span>          仅用于传入参数用</strong></span><br><span style="color: #ff0000"><strong>　　<span style="color: #0000ff">out</span>        仅用于返回值用</strong></span><br><span style="color: #ff0000"><strong>　　<span style="color: #0000ff">inout</span>     既可以传入又可以当作返回值</strong></span></p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">DECLARE</span>定义变量</strong></span><br><span style="color: #ff0000"><strong><span style="color: #0000ff">DEFAULT</span>设置变量的默认值</strong></span><br><span style="color: #ff0000"><strong><span style="color: #0000ff">SET</span>给变量赋值 要赋值的变量 值</strong></span><br><span style="color: #ff0000"><strong>定义变量的方式:<span style="color: #0000ff">DECLARE</span>&nbsp; 变量名称 &nbsp;指定变量接收的数据类型 &nbsp;<span style="color: #0000ff">DEFAULT</span>&nbsp; 设置变量的默认值</strong></span></p>
<div class="cnblogs_code">
<pre><span style="background-color: #ffff00"><span style="color: #0000ff">DROP</span> <span style="color: #0000ff">PROCEDURE</span> <span style="color: #0000ff">if</span> <span style="color: #808080">EXISTS</span> usr_nl_20;</span>        <span style="color: #008080">--</span><span style="color: #008080"> 判断usr_nl_20函数是否存在，如果存在删除函数，如果不存在则不删除</span><span style="color: #008080">
--</span><span style="color: #008080"> 如果存在函数删除后创建函数，不存在创建函数</span>

<span style="color: #008080">--</span><span style="color: #008080"> 对于存储过程，可以接收参数，其形式参数有三种用途类型：</span><span style="color: #008080">
--</span><span style="color: #008080"> 　　in 仅用于传入参数用</span><span style="color: #008080">
--</span><span style="color: #008080"> 　　out 仅用于返回值用</span><span style="color: #008080">
--</span><span style="color: #008080"> 　　inout 既可以传入又可以当作返回值</span><span style="color: #008080">
--</span> <span style="color: #008080">
--</span> <span style="color: #008080">
--</span><span style="color: #008080"> DECLARE定义变量</span><span style="color: #008080">
--</span><span style="color: #008080"> DEFAULT设置变量的默认值</span><span style="color: #008080">
--</span><span style="color: #008080"> SET给变量赋值 要赋值的变量 值</span><span style="color: #008080">
--</span><span style="color: #008080"> 定义变量的方式:DECLARE  变量名称  指定变量接收的数据类型  DEFAULT  设置变量的默认值</span>
<span style="color: #000000">

delimiter $$
</span><span style="background-color: #ff99cc"><span style="color: #0000ff">CREATE</span> <span style="color: #0000ff">PROCEDURE</span><span style="color: #000000"> usr_nl_20 (
    </span><span style="color: #808080">in</span> canshu <span style="color: #0000ff">int</span><span style="color: #000000">
)
</span></span><span style="color: #0000ff">BEGIN</span>
    <span style="background-color: #ff99cc"><span style="color: #0000ff">DECLARE</span> d1 <span style="color: #0000ff">int</span><span style="color: #000000">;
    </span><span style="color: #0000ff">DECLARE</span> d2 <span style="color: #0000ff">int</span> <span style="color: #0000ff">DEFAULT</span> <span style="color: #800000; font-weight: bold">3</span><span style="color: #000000">;
    </span><span style="color: #0000ff">SET</span> d1 <span style="color: #808080">=</span> canshu <span style="color: #808080">+</span><span style="color: #000000"> d2;

    </span></span><span style="color: #0000ff">SELECT</span> id,yhm,xb,nl <span style="color: #0000ff">FROM</span> usr <span style="color: #0000ff">WHERE</span> id <span style="color: #808080">&gt;</span><span style="color: #000000"><span style="background-color: #ff99cc"> d1</span>;
</span><span style="color: #0000ff">END</span><span style="color: #000000"> $$
delimiter ;</span></pre>
</div>
<p><span style="color: #ff0000"><strong>运行有参函数</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008080">--</span><span style="color: #008080"> 运行有参函数</span>
CALL usr_nl_20(<span style="color: #800000; font-weight: bold">1</span>);</pre>
</div>
<p><img src="https://images2015.cnblogs.com/blog/955761/201706/955761-20170613135417790-1326703875.png" alt=""></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000; background-color: #ffff00"><strong>6、创建存储过程(函数)有参，<strong><span style="color: #0000ff">in</span>&nbsp;仅用于传入参数用，<strong><span style="color: #0000ff">out</span>&nbsp;仅用于返回值用</strong></strong></strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #000000">delimiter $$
</span><span style="color: #0000ff">DROP</span> <span style="color: #0000ff">PROCEDURE</span> <span style="color: #0000ff">if</span> <span style="color: #808080">EXISTS</span><span style="color: #000000"> usr_nl_20;
</span><span style="color: #0000ff">CREATE</span> <span style="color: #0000ff">PROCEDURE</span><span style="color: #000000"> usr_nl_20 (
    </span><span style="color: #808080">in</span> <span style="background-color: #ffff00">canshu</span> <span style="color: #0000ff">int</span>,  <span style="color: #008080">--</span><span style="color: #008080"> in 仅用于传入参数用</span>
    OUT <span style="background-color: #ff99cc">canshu2</span> <span style="color: #0000ff">INT</span>  <span style="color: #008080">--</span><span style="color: #008080"> out 仅用于返回值用</span>
<span style="color: #000000">)
</span><span style="color: #0000ff">BEGIN</span>
    <span style="color: #0000ff">DECLARE</span> d2 <span style="color: #0000ff">INT</span> <span style="color: #0000ff">DEFAULT</span> <span style="color: #800000; font-weight: bold">3</span>;  <span style="color: #008080">--</span><span style="color: #008080"> 设置变量d2等于3</span>
    <span style="color: #0000ff">IF</span> <span style="background-color: #ffff00">canshu</span> <span style="color: #808080">=</span> <span style="color: #800000; font-weight: bold">1</span> <span style="color: #0000ff">THEN</span>  <span style="color: #008080">--</span><span style="color: #008080"> 判断传入参数如果等于1</span>
        <span style="color: #0000ff">SET</span> <span style="background-color: #ff99cc">canshu2</span> <span style="color: #808080">=</span> <span style="color: #800000; font-weight: bold">100</span> <span style="color: #808080">+</span> d2;  <span style="color: #008080">--</span><span style="color: #008080"> 赋值返回参数等于100加d2</span>
    ELSEIF <span style="background-color: #ffff00">canshu</span> <span style="color: #808080">=</span> <span style="color: #800000; font-weight: bold">2</span> <span style="color: #0000ff">THEN</span>  <span style="color: #008080">--</span><span style="color: #008080"> 判断传入参数等于2</span>
        <span style="color: #0000ff">SET</span> <span style="background-color: #ff99cc">canshu2</span> <span style="color: #808080">=</span> <span style="color: #800000; font-weight: bold">200</span> <span style="color: #808080">+</span> d2;  <span style="color: #008080">--</span><span style="color: #008080"> 返回参数等于200+d2</span>
    <span style="color: #0000ff">ELSE</span>  <span style="color: #008080">--</span><span style="color: #008080"> 否则</span>
        <span style="color: #0000ff">SET</span> <span style="background-color: #ff99cc">canshu2</span> <span style="color: #808080">=</span> <span style="color: #800000; font-weight: bold">1000</span> <span style="color: #808080">+</span> d2;  <span style="color: #008080">--</span><span style="color: #008080"> 返回参数等于1000+d2</span>
    <span style="color: #0000ff">END</span> <span style="color: #0000ff">IF</span><span style="color: #000000">;
</span><span style="color: #0000ff">END</span><span style="color: #000000"> $$
delimiter ;</span></pre>
</div>
<p><span style="color: #ff0000"><strong>执行函数</strong></span></p>
<p><span style="color: #ff0000"><strong><strong>执行函数，传入参数，和传入引用参数，也就是返回值参数</strong></strong></span></p>
<p><span style="color: #ff0000"><strong><strong>@定义引用参数，也就是返回值参数</strong></strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008080">--</span><span style="color: #008080"> 执行函数，传入参数，和传入引用参数，也就是返回值参数</span><span style="color: #008080">
--</span><span style="color: #008080"> @定义引用参数，也就是返回值参数</span>
CALL usr_nl_20(<span style="color: #800000; font-weight: bold; background-color: #ffff00">1</span>, <span style="color: #008000; background-color: #ff99cc">@u</span><span style="color: #000000">);
</span><span style="color: #0000ff">SELECT</span> <span style="color: #008000; background-color: #ff99cc">@u</span>;    </pre>
</div>
<p><img src="https://images2015.cnblogs.com/blog/955761/201706/955761-20170613150600571-171072978.png" alt=""></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000; background-color: #ffff00"><strong>7、创建存储过程(函数)有参，<strong>in&nbsp;仅用于传入参数用，<strong>out&nbsp;仅用于返回值用，<strong>inout&nbsp;既可以传入又可以当作返回值</strong></strong></strong></strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #000000">delimiter $$
</span><span style="color: #0000ff">DROP</span> <span style="color: #0000ff">PROCEDURE</span> <span style="color: #0000ff">if</span> <span style="color: #808080">EXISTS</span><span style="color: #000000"> usr_nl_20;
</span><span style="color: #0000ff">CREATE</span> <span style="color: #0000ff">PROCEDURE</span><span style="color: #000000"> usr_nl_20 (
    </span><span style="background-color: #ffff00"><span style="color: #808080">in</span> canshu</span> <span style="color: #0000ff">int</span>,  <span style="color: #008080">--</span><span style="color: #008080"> in 仅用于传入参数用</span>
    <span style="background-color: #ff99cc">OUT canshu2</span> <span style="color: #0000ff">INT</span>,  <span style="color: #008080">--</span><span style="color: #008080"> out 仅用于返回值用</span>
    <span style="background-color: #ccffff">INOUT ii</span> <span style="color: #0000ff">INT</span>  <span style="color: #008080">--</span><span style="color: #008080"> inout 既可以传入又可以当作返回值</span>
<span style="color: #000000">)
</span><span style="color: #0000ff">BEGIN</span>
    <span style="color: #0000ff">DECLARE</span> d2 <span style="color: #0000ff">INT</span> <span style="color: #0000ff">DEFAULT</span> <span style="color: #800000; font-weight: bold">3</span>;  <span style="color: #008080">--</span><span style="color: #008080"> 设置变量d2等于3</span>
        <span style="color: #0000ff">SET</span> <span style="background-color: #ccffff">ii <span style="color: #808080">=</span> ii <span style="color: #808080">+</span> <span style="color: #800000; font-weight: bold">1</span><span style="color: #000000">;
    </span></span><span style="color: #0000ff">IF</span> <span style="background-color: #ffff00">canshu</span> <span style="color: #808080">=</span> <span style="color: #800000; font-weight: bold">1</span> <span style="color: #0000ff">THEN</span>  <span style="color: #008080">--</span><span style="color: #008080"> 判断传入参数如果等于1</span>
        <span style="color: #0000ff">SET</span> <span style="background-color: #ff99cc">canshu2</span> <span style="color: #808080">=</span> <span style="color: #800000; font-weight: bold">100</span> <span style="color: #808080">+</span> d2;  <span style="color: #008080">--</span><span style="color: #008080"> 赋值返回参数等于100加d2</span>
    ELSEIF <span style="background-color: #ffff00">canshu</span> <span style="color: #808080">=</span> <span style="color: #800000; font-weight: bold">2</span> <span style="color: #0000ff">THEN</span>  <span style="color: #008080">--</span><span style="color: #008080"> 判断传入参数等于2</span>
        <span style="color: #0000ff">SET</span> <span style="background-color: #ff99cc">canshu2</span> <span style="color: #808080">=</span> <span style="color: #800000; font-weight: bold">200</span> <span style="color: #808080">+</span> d2;  <span style="color: #008080">--</span><span style="color: #008080"> 返回参数等于200+d2</span>
    <span style="color: #0000ff">ELSE</span>  <span style="color: #008080">--</span><span style="color: #008080"> 否则</span>
        <span style="color: #0000ff">SET</span> <span style="background-color: #ff99cc">canshu2</span> <span style="color: #808080">=</span> <span style="color: #800000; font-weight: bold">1000</span> <span style="color: #808080">+</span> d2;  <span style="color: #008080">--</span><span style="color: #008080"> 返回参数等于1000+d2</span>
    <span style="color: #0000ff">END</span> <span style="color: #0000ff">IF</span><span style="color: #000000">;
</span><span style="color: #0000ff">END</span><span style="color: #000000"> $$
delimiter ;</span></pre>
</div>
<p><span style="color: #ff0000"><strong>执行函数</strong></span></p>
<div class="cnblogs_code">
<pre><span style="background-color: #ccffff"><span style="color: #0000ff">SET</span> <span style="color: #008000">@f</span> <span style="color: #808080">=</span> <span style="color: #800000; font-weight: bold">5</span>;</span>  <span style="color: #008080">--</span><span style="color: #008080"> 定义inout类型变，可传入可返回变量</span>
CALL usr_nl_20(<span style="color: #800000; font-weight: bold; background-color: #ffff00">1</span>, <span style="color: #008000; background-color: #ff99cc">@u</span>, <span style="color: #008000; background-color: #ccffff">@f</span>);  <span style="color: #008080">--</span><span style="color: #008080"> 执行函数，参数in 仅用于传入参数用，参数out 仅用于返回值用，参数inout 既可以传入又可以当作返回值</span>
<span style="color: #0000ff">SELECT</span> <span style="color: #008000; background-color: #ff99cc">@u</span>,<span style="color: #008000; background-color: #ccffff">@f</span>;  <span style="color: #008080">--</span><span style="color: #008080"> 查看两个类型的返回值</span></pre>
</div>
<p><img src="https://images2015.cnblogs.com/blog/955761/201706/955761-20170613161607900-1797874915.png" alt=""></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000; background-color: #ffff00"><strong>8、pymysql模块，执行存储过程(函数)，获取SQL语句查询结果、和返回值</strong></span></p>
<p><span style="color: #ff0000"><strong>举例：创建了一个<strong>存储过程(函数)有参，函数里既有返回值、又有<strong>SQL语句查询结果，怎么通过<strong>pymysql模块<strong><strong>既拿到返回结果，又拿到<strong><strong><strong>SQL语句查询结果</strong></strong></strong></strong></strong></strong></strong></strong></strong></span></p>
<p><span style="color: #0000ff; background-color: #ffffff"><strong><strong><strong><strong><strong><strong><strong><strong><strong>表</strong></strong></strong></strong></strong></strong></strong></strong></strong></span></p>
<p><span style="color: #ff0000"><strong><strong><strong><strong><strong><strong><strong><strong><strong><img src="https://images2015.cnblogs.com/blog/955761/201706/955761-20170613165948868-1498764433.png" alt=""></strong></strong></strong></strong></strong></strong></strong></strong></strong></span></p>
<p><span style="color: #0000ff"><strong><strong><strong><strong><strong><strong><strong><strong><strong><strong>执行存储过程(函数)</strong></strong></strong></strong></strong></strong></strong></strong></strong></strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #000000">delimiter $$
</span><span style="color: #0000ff">DROP</span> <span style="color: #0000ff">PROCEDURE</span> <span style="color: #0000ff">if</span> <span style="color: #808080">EXISTS</span><span style="color: #000000"> usr_nl_20;
</span><span style="color: #0000ff">CREATE</span> <span style="color: #0000ff">PROCEDURE</span><span style="color: #000000"> usr_nl_20 (
    </span><span style="color: #808080">in</span> <span style="background-color: #ffff00">canshu</span> <span style="color: #0000ff">int</span>,  <span style="color: #008080">--</span><span style="color: #008080"> in 仅用于传入参数用</span>
    OUT <span style="background-color: #ff99cc">canshu2</span> <span style="color: #0000ff">INT</span>,  <span style="color: #008080">--</span><span style="color: #008080"> out 仅用于返回值用</span>
    INOUT <span style="background-color: #ccffff">ii</span> <span style="color: #0000ff">INT</span>  <span style="color: #008080">--</span><span style="color: #008080"> inout 既可以传入又可以当作返回值</span>
<span style="color: #000000">)
</span><span style="color: #0000ff">BEGIN</span>
    <span style="color: #0000ff">DECLARE</span> d2 <span style="color: #0000ff">INT</span> <span style="color: #0000ff">DEFAULT</span> <span style="color: #800000; font-weight: bold">3</span>;  <span style="color: #008080">--</span><span style="color: #008080"> 设置变量d2等于3</span>
        <span style="color: #0000ff">SET</span> ii <span style="color: #808080">=</span> ii <span style="color: #808080">+</span> <span style="color: #800000; font-weight: bold">1</span><span style="color: #000000">;
        </span><span style="background-color: #ffcc99"><span style="color: #0000ff">SELECT</span> <span style="color: #808080">*</span> <span style="color: #0000ff">FROM</span> usr; <span style="color: #008080">--</span><span style="color: #008080"> SQL查询语句</span></span>
    <span style="color: #0000ff">IF</span> canshu <span style="color: #808080">=</span> <span style="color: #800000; font-weight: bold">1</span> <span style="color: #0000ff">THEN</span>  <span style="color: #008080">--</span><span style="color: #008080"> 判断传入参数如果等于1</span>
        <span style="color: #0000ff">SET</span> canshu2 <span style="color: #808080">=</span> <span style="color: #800000; font-weight: bold">100</span> <span style="color: #808080">+</span> d2;  <span style="color: #008080">--</span><span style="color: #008080"> 赋值返回参数等于100加d2</span>
    ELSEIF canshu <span style="color: #808080">=</span> <span style="color: #800000; font-weight: bold">2</span> <span style="color: #0000ff">THEN</span>  <span style="color: #008080">--</span><span style="color: #008080"> 判断传入参数等于2</span>
        <span style="color: #0000ff">SET</span> canshu2 <span style="color: #808080">=</span> <span style="color: #800000; font-weight: bold">200</span> <span style="color: #808080">+</span> d2;  <span style="color: #008080">--</span><span style="color: #008080"> 返回参数等于200+d2</span>
    <span style="color: #0000ff">ELSE</span>  <span style="color: #008080">--</span><span style="color: #008080"> 否则</span>
        <span style="color: #0000ff">SET</span> canshu2 <span style="color: #808080">=</span> <span style="color: #800000; font-weight: bold">1000</span> <span style="color: #808080">+</span> d2;  <span style="color: #008080">--</span><span style="color: #008080"> 返回参数等于1000+d2</span>
    <span style="color: #0000ff">END</span> <span style="color: #0000ff">IF</span><span style="color: #000000">;
</span><span style="color: #0000ff">END</span><span style="color: #000000"> $$
delimiter ;</span></pre>
</div>
<p><span style="color: #ff0000; background-color: #ffff00"><strong>&nbsp;</strong></span></p>
<p><span style="color: #ff0000; background-color: #ffff00"><strong>pymysql模块，执行存储过程(函数)，获取SQL语句查询结果、和返回值</strong></span></p>
<p><span style="color: #ff0000"><strong>callproc()执行存储过程(函数),两个参数</strong></span><br><span style="color: #ff0000"><strong>使用方式：</strong></span><br><span style="color: #ff0000"><strong>游标变量.callproc('存储过程(函数)名称',(函数参数多个参数,号隔开))</strong></span></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>fetchall()获取存储过程(函数)里的SQL语句查询结果</strong></span><br><span style="color: #ff0000"><strong>使用方式：</strong></span><br><span style="color: #ff0000"><strong>游标变量.fetchall()</strong></span></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>execute()获取存储过程(函数)的返回值,参数是要获取返回值的形式参数索引</strong></span><br><span style="color: #ff0000"><strong>使用方式：</strong></span><br><span style="color: #ff0000"><strong>游标变量.execute("select @_存储过程(函数)名称_0,@_存储过程(函数)名称_1,@_存储过程(函数)名称_2")</strong></span></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>fetchone()拿到存储过程(函数)的返回值</strong></span><br><span style="color: #ff0000"><strong>使用方式：</strong></span><br><span style="color: #ff0000"><strong>游标变量.fetchone()</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000">coding:utf-8</span>

<span style="color: #0000ff">import</span><span style="color: #000000"> tornado.ioloop
</span><span style="color: #0000ff">import</span> tornado.web                                              <span style="color: #008000">#</span><span style="color: #008000">导入tornado模块下的web文件</span>
<span style="color: #0000ff">import</span> pymysql                                                  <span style="color: #008000">#</span><span style="color: #008000">导入数据库模块</span>

<span style="color: #0000ff">class</span><span style="color: #000000"> khdHandler(tornado.web.RequestHandler):
    </span><span style="color: #0000ff">def</span><span style="color: #000000"> get(self):

        </span><span style="color: #008000">#</span><span style="color: #008000">连接数据库</span>
        conn = pymysql.connect(host=<span style="color: #800000">'</span><span style="color: #800000">127.0.0.1</span><span style="color: #800000">'</span>, port=3306, user=<span style="color: #800000">'</span><span style="color: #800000">root</span><span style="color: #800000">'</span>, passwd=<span style="color: #800000">'</span><span style="color: #800000">279819</span><span style="color: #800000">'</span>, db=<span style="color: #800000">'</span><span style="color: #800000">cshi</span><span style="color: #800000">'</span>,charset=<span style="color: #800000">'</span><span style="color: #800000">utf8</span><span style="color: #800000">'</span><span style="color: #000000">)
        </span><span style="color: #008000">#</span><span style="color: #008000"> 创建游标</span>
        cursor = conn.cursor(cursor=<span style="color: #000000">pymysql.cursors.DictCursor)


        </span><span style="background-color: #ffff00"><span style="color: #008000">#</span><span style="color: #008000">执行存储过程(函数)</span>
        row = cursor.callproc(<span style="color: #800000">'</span><span style="color: #800000">usr_nl_20</span><span style="color: #800000">'</span>,(1,2,3<span style="color: #000000">))


        </span><span style="color: #008000">#</span><span style="color: #008000">获取存储过程(函数)里的SQL语句查询结果</span>
        chaxjieg =<span style="color: #000000"> cursor.fetchall()
        </span><span style="color: #0000ff">print</span>(chaxjieg) <span style="color: #008000">#</span><span style="color: #008000">打印SQL语句查询结果</span></span>

        <span style="background-color: #ff99cc"><span style="color: #008000">#</span><span style="color: #008000">获取存储过程(函数)的返回值</span>
        effect_row = cursor.execute(<span style="color: #800000">"</span><span style="color: #800000">select @_usr_nl_20_0,@_usr_nl_20_1,@_usr_nl_20_2</span><span style="color: #800000">"</span><span style="color: #000000">)
        fhuizhi </span>=<span style="color: #000000"> cursor.fetchone()
        </span><span style="color: #0000ff">print</span><span style="color: #000000">(fhuizhi)


        </span></span><span style="color: #008000">#</span><span style="color: #008000"> 提交，不然无法保存新建或者修改的数据</span>
        <span style="color: #008000">#</span><span style="color: #008000"> conn.commit()</span>

        <span style="color: #008000">#</span><span style="color: #008000"> 关闭游标</span>
<span style="color: #000000">        cursor.close()
        </span><span style="color: #008000">#</span><span style="color: #008000"> 关闭连接</span>
<span style="color: #000000">        conn.close()

        self.write(</span><span style="color: #800000">"</span><span style="color: #800000">欢迎访问</span><span style="color: #800000">"</span><span style="color: #000000">)


settings </span>= {                                            <span style="color: #008000">#</span><span style="color: #008000">html文件归类配置，设置一个字典</span>
    <span style="color: #800000">"</span><span style="color: #800000">template_path</span><span style="color: #800000">"</span>:<span style="color: #800000">"</span><span style="color: #800000">views</span><span style="color: #800000">"</span>,                            <span style="color: #008000">#</span><span style="color: #008000">键为template_path固定的，值为要存放HTML的文件夹名称</span>
    <span style="color: #800000">"</span><span style="color: #800000">static_path</span><span style="color: #800000">"</span>:<span style="color: #800000">"</span><span style="color: #800000">statics</span><span style="color: #800000">"</span>,                            <span style="color: #008000">#</span><span style="color: #008000">键为static_path固定的，值为要存放js和css的文件夹名称</span>
<span style="color: #000000">}

</span><span style="color: #008000">#</span><span style="color: #008000">路由映射</span>
application = tornado.web.Application([                 <span style="color: #008000">#</span><span style="color: #008000">创建一个变量等于tornado.web下的Application方法</span>
    (r<span style="color: #800000">"</span><span style="color: #800000">/khd</span><span style="color: #800000">"</span><span style="color: #000000">, khdHandler),
],</span>**settings)                                           <span style="color: #008000">#</span><span style="color: #008000">将html文件归类配置字典，写在路由映射的第二个参数里</span>

<span style="color: #0000ff">if</span> <span style="color: #800080">__name__</span> == <span style="color: #800000">"</span><span style="color: #800000">__main__</span><span style="color: #800000">"</span><span style="color: #000000">:
    </span><span style="color: #008000">#</span><span style="color: #008000">内部socket运行起来</span>
    application.listen(8002)                            <span style="color: #008000">#</span><span style="color: #008000">设置端口</span>
    tornado.ioloop.IOLoop.instance().start()</pre>
</div>
<p><span style="color: #0000ff"><strong>原理图</strong></span></p>
<p><img src="https://images2015.cnblogs.com/blog/955761/201706/955761-20170613175529743-281724386.png" alt=""></p>
<p>&nbsp;</p></div>