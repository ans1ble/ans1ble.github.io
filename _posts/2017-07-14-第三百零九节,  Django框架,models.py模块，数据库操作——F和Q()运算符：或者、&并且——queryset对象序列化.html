第三百零九节queryset对象序列化


			<div id="cnblogs_post_body" class="blogpost-body"><p><strong>第三百零九节，Django框架,models.py模块，数据库操作——F()和<strong>Q()运算符：|或者、&amp;并且</strong></strong></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">F()</span>可以将数据库里的数字类型的数据，转换为可以数字类型</strong></span></p>
<p><span style="color: #ff0000"><strong>首先要导入 <span style="color: #0000ff">from django.db.models import F</span></strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff">from</span> django.shortcuts <span style="color: #0000ff">import</span><span style="color: #000000"> render
</span><span style="color: #0000ff">from</span> app1.models <span style="color: #0000ff">import</span> *    <span style="color: #008000">#</span><span style="color: #008000">导入数据库操作模块</span>

<span style="color: #0000ff">from</span> django.db.models <span style="color: #0000ff">import</span> <span style="background-color: #ff99cc">F</span> <span style="color: #008000">#</span><span style="color: #008000">导入F类</span>

<span style="color: #008000">#</span><span style="color: #008000">逻辑处理模块</span>
<span style="color: #0000ff">def</span><span style="color: #000000"> special(request):
    </span><span style="color: #008000">#</span><span style="color: #008000">获取yu_wen_lao_shi表里id等于1的那条数据，将shuzi字段的值自身加100</span>
    yu_wen_lao_shi.objects.filter(id=1).update(shuzi=<span style="background-color: #ff99cc">F(<span style="color: #800000">'</span><span style="color: #800000">shuzi</span><span style="color: #800000">'</span>)</span> + 100<span style="color: #000000">)

    </span><span style="color: #0000ff">return</span> render(request,<span style="color: #800000">'</span><span style="color: #800000">index.html</span><span style="color: #800000">'</span>,locals())   <span style="color: #008000">#</span><span style="color: #008000">打开页面</span></pre>
</div>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">&nbsp;Q()</span>运算符：<span style="color: #0000ff">|</span>或者、<span style="color: #0000ff">&amp;</span>并且</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000"> Q</span>
    <span style="color: #008000">#
</span>    <span style="color: #008000">#</span><span style="color: #008000"> 方式一：</span>
    <span style="color: #008000">#</span><span style="color: #008000"> Q(nid__gt=10)</span>
    <span style="color: #008000">#</span><span style="color: #008000"> Q(nid=8) | Q(nid__gt=10)</span>
    <span style="color: #008000">#</span><span style="color: #008000"> Q(Q(nid=8) | Q(nid__gt=10)) &amp; Q(caption='root')</span>
    <span style="color: #008000">#</span><span style="color: #008000"> 方式二：</span>
    <span style="color: #008000">#</span><span style="color: #008000"> con = Q()</span>
    <span style="color: #008000">#</span><span style="color: #008000"> q1 = Q()</span>
    <span style="color: #008000">#</span><span style="color: #008000"> q1.connector = 'OR'</span>
    <span style="color: #008000">#</span><span style="color: #008000"> q1.children.append(('id', 1))</span>
    <span style="color: #008000">#</span><span style="color: #008000"> q1.children.append(('id', 10))</span>
    <span style="color: #008000">#</span><span style="color: #008000"> q1.children.append(('id', 9))</span>
    <span style="color: #008000">#</span><span style="color: #008000"> q2 = Q()</span>
    <span style="color: #008000">#</span><span style="color: #008000"> q2.connector = 'OR'</span>
    <span style="color: #008000">#</span><span style="color: #008000"> q2.children.append(('c1', 1))</span>
    <span style="color: #008000">#</span><span style="color: #008000"> q2.children.append(('c1', 10))</span>
    <span style="color: #008000">#</span><span style="color: #008000"> q2.children.append(('c1', 9))</span>
    <span style="color: #008000">#</span><span style="color: #008000"> con.add(q1, 'AND')</span>
    <span style="color: #008000">#</span><span style="color: #008000"> con.add(q2, 'AND')</span>
    <span style="color: #008000">#
</span>    <span style="color: #008000">#</span><span style="color: #008000"> models.Tb1.objects.filter(con)</span></pre>
</div>
<p>实列：</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff">from</span> django.shortcuts <span style="color: #0000ff">import</span><span style="color: #000000"> render
</span><span style="color: #0000ff">from</span> app1.models <span style="color: #0000ff">import</span> *    <span style="color: #008000">#</span><span style="color: #008000">导入数据库操作模块</span>

<span style="color: #0000ff">from</span> django.db.models <span style="color: #0000ff">import</span> F,<span style="background-color: #ff99cc">Q</span>   <span style="color: #008000">#</span><span style="color: #008000">导入F和Q</span>

<span style="color: #0000ff">from</span> django.db.models <span style="color: #0000ff">import</span><span style="color: #000000"> Count, Min, Max, Sum

</span><span style="color: #008000">#</span><span style="color: #008000">逻辑处理模块</span>
<span style="color: #0000ff">def</span><span style="color: #000000"> special(request):
    </span><span style="color: #008000">#</span><span style="color: #008000"> Q(nid__gt=10)</span>
    a = yu_wen_lao_shi.objects.filter(<span style="background-color: #ff99cc">Q(id__gt=3)</span>).values()   <span style="color: #008000">#</span><span style="color: #008000">获取id大于3的数据</span>
    <span style="color: #0000ff">print</span><span style="color: #000000">(a)

    </span><span style="color: #008000">#</span><span style="color: #008000">Q(nid=8) | Q(nid__gt=10)</span>
    b = yu_wen_lao_shi.objects.filter(<span style="background-color: #ff99cc">Q(nl=20)</span> <span style="background-color: #ffff00"><strong>|</strong></span> <span style="background-color: #ff99cc">Q(nl=22)</span>).values()  <span style="color: #008000">#</span><span style="color: #008000">获取nl字段等于20，或者nl字段等于22的数据</span>
    <span style="color: #0000ff">print</span><span style="color: #000000">(b)

    c </span>= yu_wen_lao_shi.objects.filter(<span style="background-color: #ff99cc">Q(id__gt=2)</span> <span style="background-color: #ffff00"><strong>&amp;</strong></span> <span style="background-color: #ff99cc">Q(nl=21)</span>).values()  <span style="color: #008000">#</span><span style="color: #008000">获取id大于2并且nl等于21的数据</span>
    <span style="color: #0000ff">print</span><span style="color: #000000">(c)

    </span><span style="color: #0000ff">return</span> render(request,<span style="color: #800000">'</span><span style="color: #800000">index.html</span><span style="color: #800000">'</span>,locals())   <span style="color: #008000">#</span><span style="color: #008000">打开页面</span></pre>
</div>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>执行原生SQL</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">　　#</span><span style="color: #008000"> from django.db import connection, connections</span>
    <span style="color: #008000">#</span><span style="color: #008000"> cursor = connection.cursor()  # cursor = connections['default'].cursor()</span>
    <span style="color: #008000">#</span><span style="color: #008000"> cursor.execute("""SELECT * from auth_user where id = %s""", [1])</span>
    <span style="color: #008000">#</span><span style="color: #008000"> row = cursor.fetchone()</span></pre>
</div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000; background-color: #ffff00"><strong>queryset对象序列化</strong></span></p>
<p><span style="color: #ff0000"><strong>django的json类型模块<span style="color: #0000ff">serialize()</span></strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff">from</span> django.shortcuts <span style="color: #0000ff">import</span><span style="color: #000000"> render
</span><span style="color: #0000ff">from</span> app1.models <span style="color: #0000ff">import</span> *    <span style="color: #008000">#</span><span style="color: #008000">导入数据库操作模块</span>

<span style="color: #0000ff">from</span> django.db.models <span style="color: #0000ff">import</span> F,Q   <span style="color: #008000">#</span><span style="color: #008000">导入F和Q</span>

<span style="background-color: #ff99cc"><span style="color: #0000ff">from</span> django.core <span style="color: #0000ff">import</span> serializers</span>     <span style="color: #008000">#</span><span style="color: #008000">django的将queryset对象转换成json类型模块</span>
<span style="color: #0000ff">import</span><span style="color: #000000"> json
</span><span style="color: #008000">#</span><span style="color: #008000">逻辑处理模块</span>
<span style="color: #0000ff">def</span><span style="color: #000000"> special(request):
    </span><span style="color: #008000">#</span><span style="color: #008000"> Q(nid__gt=10)</span>
    a = yu_wen_lao_shi.objects.filter(Q(id__gt=3))   <span style="color: #008000">#</span><span style="color: #008000">获取id大于3的数据</span>
    <span style="color: #0000ff">print</span>(a)   <span style="color: #008000">#</span><span style="color: #008000">得到queryset对象</span>
<span style="color: #000000">
    b </span>= <span style="background-color: #ff99cc">serializers.serialize(<span style="color: #800000">"</span><span style="color: #800000">json</span><span style="color: #800000">"</span>,a)</span>     <span style="color: #008000">#</span><span style="color: #008000">将queryset对象转换成json类型</span>
    <span style="color: #0000ff">print</span>(b)                                <span style="color: #008000">#</span><span style="color: #008000">得到json类型</span>
<span style="color: #000000">
    c </span>= json.loads(b)                       <span style="color: #008000">#</span><span style="color: #008000">将json类型还原成Python数据类型</span>
    <span style="color: #0000ff">print</span><span style="color: #000000">(c)
    </span><span style="color: #0000ff">return</span> render(request,<span style="color: #800000">'</span><span style="color: #800000">index.html</span><span style="color: #800000">'</span>,locals())   <span style="color: #008000">#</span><span style="color: #008000">打开页面</span><span style="color: #008000">
#</span><span style="color: #008000"> 返回：</span><span style="color: #008000">
#</span><span style="color: #008000"> &lt;QuerySet [&lt;yu_wen_lao_shi: 张三4&gt;, &lt;yu_wen_lao_shi: 张三5&gt;]&gt;</span><span style="color: #008000">
#</span><span style="color: #008000"> [{"model": "app1.yu_wen_lao_shi", "pk": 4, "fields": {"xm": "\u5f20\u4e094", "xb": "\u5973", "nl": "21", "shg": "174", "gz": "1500"}}, {"model": "app1.yu_wen_lao_shi", "pk": 5, "fields": {"xm": "\u5f20\u4e095", "xb": "\u5973", "nl": "23", "shg": "175", "gz": "1500"}}]</span><span style="color: #008000">
#</span><span style="color: #008000"> [{'pk': 4, 'fields': {'xb': '女', 'shg': '174', 'gz': '1500', 'xm': '张三4', 'nl': '21'}, 'model': 'app1.yu_wen_lao_shi'}, {'pk': 5, 'fields': {'xb': '女', 'shg': '175', 'gz': '1500', 'xm': '张三5', 'nl': '23'}, 'model': 'app1.yu_wen_lao_shi'}]</span></pre>
</div>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">list()</span>将queryset对象转换成列表</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff">from</span> django.shortcuts <span style="color: #0000ff">import</span><span style="color: #000000"> render
</span><span style="color: #0000ff">from</span> app1.models <span style="color: #0000ff">import</span> *    <span style="color: #008000">#</span><span style="color: #008000">导入数据库操作模块</span>

<span style="color: #0000ff">from</span> django.db.models <span style="color: #0000ff">import</span> F,Q   <span style="color: #008000">#</span><span style="color: #008000">导入F和Q</span>

<span style="color: #0000ff">from</span> django.core <span style="color: #0000ff">import</span> serializers     <span style="color: #008000">#</span><span style="color: #008000">django的将queryset对象转换成json类型模块</span>
<span style="color: #0000ff">import</span><span style="color: #000000"> json
</span><span style="color: #008000">#</span><span style="color: #008000">逻辑处理模块</span>
<span style="color: #0000ff">def</span><span style="color: #000000"> special(request):
    </span><span style="color: #008000">#</span><span style="color: #008000"> Q(nid__gt=10)</span>
    a = yu_wen_lao_shi.objects.filter(Q(id__gt=3)).values()   <span style="color: #008000">#</span><span style="color: #008000">获取id大于3的数据</span>
    <span style="color: #0000ff">print</span>(a)   <span style="color: #008000">#</span><span style="color: #008000">得到queryset对象</span>
<span style="color: #000000">
    b </span>= <span style="background-color: #ff99cc">list(a)</span>  <span style="color: #008000">#</span><span style="color: #008000">将queryset对象转换成列表</span>
    <span style="color: #0000ff">print</span><span style="color: #000000">(b)

    </span><span style="color: #0000ff">return</span> render(request, <span style="color: #800000">'</span><span style="color: #800000">index.html</span><span style="color: #800000">'</span>, locals())  <span style="color: #008000">#</span><span style="color: #008000"> 打开页面</span>

<span style="color: #008000">#</span><span style="color: #008000"> 返回：</span><span style="color: #008000">
#</span><span style="color: #008000"> &lt;QuerySet [{'xb': '女', 'gz': '1500', 'id': 4, 'xm': '张三4', 'nl': '21', 'shg': '174'}, {'xb': '女', 'gz': '1500', 'id': 5, 'xm': '张三5', 'nl': '23', 'shg': '175'}]&gt;</span><span style="color: #008000">
#</span><span style="color: #008000; background-color: #ff99cc"> [{'xb': '女', 'gz': '1500', 'id': 4, 'xm': '张三4', 'nl': '21', 'shg': '174'}, {'xb': '女', 'gz': '1500', 'id': 5, 'xm': '张三5', 'nl': '23', 'shg': '175'}]</span></pre>
</div>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>由于json.dumps时无法处理datetime日期，所以可以通过自定义处理器来做扩展，如：</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #000000">queryset对象

</span><span style="color: #0000ff">import</span><span style="color: #000000"> json 
</span><span style="color: #0000ff">from</span> datetime <span style="color: #0000ff">import</span><span style="color: #000000"> date 
</span><span style="color: #0000ff">from</span> datetime <span style="color: #0000ff">import</span><span style="color: #000000"> datetime 
   
</span><span style="color: #0000ff">class</span><span style="color: #000000"><span style="background-color: #ff99cc"> JsonCustomEncoder</span>(json.JSONEncoder): 
    
    </span><span style="color: #0000ff">def</span><span style="color: #000000"> default(self, field): 
     
        </span><span style="color: #0000ff">if</span><span style="color: #000000"> isinstance(field, datetime): 
            </span><span style="color: #0000ff">return</span> o.strftime(<span style="color: #800000">'</span><span style="color: #800000">%Y-%m-%d %H:%M:%S</span><span style="color: #800000">'</span><span style="color: #000000">) 
        </span><span style="color: #0000ff">elif</span><span style="color: #000000"> isinstance(field, date): 
            </span><span style="color: #0000ff">return</span> o.strftime(<span style="color: #800000">'</span><span style="color: #800000">%Y-%m-%d</span><span style="color: #800000">'</span><span style="color: #000000">) 
        </span><span style="color: #0000ff">else</span><span style="color: #000000">: 
            </span><span style="color: #0000ff">return</span><span style="color: #000000"> json.JSONEncoder.default(self, field) 
   
   
</span><span style="color: #008000">#</span><span style="color: #008000"> ds = json.dumps(<span style="background-color: #ff99cc">queryset对象</span>, cls=<span style="background-color: #ff99cc">JsonCustomEncoder</span>) </span></pre>
</div>
<p>&nbsp;</p>
<p>补充：&nbsp;<strong>models 中实现一个字段的默认值为当前登录用户</strong></p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff">class</span><span style="color: #000000"> ding_dan_guan_liAdmin(object):
    list_display </span>= [<span style="color: #800000">'</span><span style="color: #800000">nnd</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">ke_hu_qing_kuang</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">luyinyuan_chengben</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">shou_kuan_qing_kuang</span><span style="color: #800000">'</span><span style="color: #000000">,
                    </span><span style="color: #800000">'</span><span style="color: #800000">ding_dan_zhuang_tai</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">jiaoyi_qingkuang</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">wengao_fabu</span><span style="color: #800000">'</span><span style="color: #000000">]
    model_icon </span>= <span style="color: #800000">'</span><span style="color: #800000">fa fa-pencil-square-o</span><span style="color: #800000">'</span><span style="color: #000000">
    readonly_fields </span>= [<span style="color: #800000">'</span><span style="color: #800000">nnd</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">xiadan_ren</span><span style="color: #800000">'</span><span style="color: #000000">]
    style_fields </span>= {<span style="color: #800000">'</span><span style="color: #800000">bei_zhu</span><span style="color: #800000">'</span>: <span style="color: #800000">'</span><span style="color: #800000">ueditor</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">wen_gao</span><span style="color: #800000">'</span>: <span style="color: #800000">'</span><span style="color: #800000">ueditor</span><span style="color: #800000">'</span>}           <span style="color: #008000">#</span><span style="color: #008000"> 使用富文本框插件</span>

    <span style="color: #0000ff">def</span><span style="color: #000000"> save_models(self):
        obj </span>=<span style="color: #000000"> self.new_obj
        request </span>=<span style="color: #000000"> self.request
        </span><span style="color: #008000">#</span><span style="color: #008000"> 获取添加到订单用户值</span>
        yhu =<span style="color: #000000"> obj.xiadan_ren
        </span><span style="color: #0000ff">if</span> <span style="color: #0000ff">not</span><span style="color: #000000"> yhu:
            obj.xiadan_ren </span>=<span style="color: #000000"> request.user
            obj.save()

xadmin.site.register(ding_dan_guan_li, ding_dan_guan_liAdmin)</span></pre>
</div>
<p>&nbsp;</p></div>