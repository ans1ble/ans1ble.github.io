第二百九十二节，RabbitMQ多设备消息队列-Python开发


			<div id="cnblogs_post_body" class="blogpost-body"><p><strong>RabbitMQ多设备消息队列-Python开发</strong></p>
<p><span style="color: #ff0000"><strong>首先安装<strong>Python开发连接<strong>RabbitMQ的API，pika模块</strong></strong></strong></span></p>
<p><span style="color: #ff0000"><strong><strong><strong><strong><strong><strong>pika模块为第三方模块</strong></strong></strong></strong></strong></strong></span></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong><strong><strong><strong><strong><strong>&nbsp;对于RabbitMQ来说，生产和消费不再针对内存里的一个Queue对象，而是<span style="color: #0000ff">某台服务器上的RabbitMQ Server</span>实现的消息队列。</strong></strong></strong></strong></strong></strong></span></p>
<p>&nbsp;</p>
<hr>
<p>&nbsp;</p>
<p><span style="color: #ff0000; font-size: 18pt; background-color: #ffff00"><strong>生产者消费者一对一</strong></span></p>
<p><span style="color: #ff0000; font-size: 18pt; background-color: #ffffff"><strong>不使用交换机</strong></span></p>
<p>&nbsp;<img src="https://images2015.cnblogs.com/blog/955761/201706/955761-20170622144408804-1561852360.png" alt=""></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000; background-color: #ffff00"><strong>生产者主机</strong></span></p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">pika.PlainCredentials()</span>设置RabbitMQ Server用户名和密码</strong></span><br><span style="color: #ff0000"><strong><span style="color: #0000ff">ConnectionParameters()</span>设置ip和端口</strong></span><br><span style="color: #ff0000"><strong><span style="color: #0000ff">BlockingConnection()</span>创建连接，自带了socket逻辑部分</strong></span><br><span style="color: #ff0000"><strong><span style="color: #0000ff">channel()</span>获取连接句柄</strong></span><br><span style="color: #ff0000"><strong><span style="color: #0000ff">queue_declare(queue='队列名称')</span>向RabbitMQ Server创建一个消息队列，如果此队列存在则不创建</strong></span><br><span style="color: #ff0000"><strong><span style="color: #0000ff">basic_publish(exchange='交换机状态',routing_key='队列名称',body='数据类容')</span>向指定队列里写入数据</strong></span><br><span style="color: #ff0000"><strong><span style="color: #0000ff">close()</span>关闭连接</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span>
<span style="color: #0000ff">import</span> pika  <span style="color: #008000">#</span><span style="color: #008000">导入连接操作RabbitMQ Server主机的模块</span>

<span style="color: #008000">#</span><span style="color: #008000"> ######################### 生产者 #########################</span>
<span style="color: #000000">
credentials </span>= pika.PlainCredentials(<span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>)                      <span style="color: #008000">#</span><span style="color: #008000">设置RabbitMQ Server用户名和密码</span>
parameters = pika.ConnectionParameters(<span style="color: #800000">'</span><span style="color: #800000">localhost</span><span style="color: #800000">'</span>, 5672,<span style="color: #800000">'</span><span style="color: #800000">/</span><span style="color: #800000">'</span>,credentials)  <span style="color: #008000">#</span><span style="color: #008000">设置ip和端口</span>
<span style="color: #000000">
connection </span>= pika.BlockingConnection(parameters)        <span style="color: #008000">#</span><span style="color: #008000">创建连接，自带了socket逻辑部分</span>
channel = connection.channel()                          <span style="color: #008000">#</span><span style="color: #008000">获取连接句柄</span>
<span style="color: #000000">
channel.<span style="background-color: #ff99cc">queue_declare(queue</span></span><span style="background-color: #ff99cc">=<span style="color: #800000">'</span><span style="color: #800000">hello</span><span style="color: #800000">'</span>)</span>                    <span style="color: #008000">#</span><span style="color: #008000">向RabbitMQ Server创建一个消息队列，queue='hello'设置队列名称，如果此队列存在则不创建</span>

<span style="color: #008000">#</span><span style="color: #008000">向指定队列里写入数据</span>
channel.basic_publish(<span style="background-color: #ff99cc">exchange=<span style="color: #800000">''</span></span>,                      <span style="color: #008000">#</span><span style="color: #008000">exchange路由交换机，参数为空，路由交换机不工作</span>
                      <span style="background-color: #ff99cc">routing_key=<span style="color: #800000">'</span><span style="color: #800000">hello</span><span style="color: #800000">'</span></span>,              <span style="color: #008000">#</span><span style="color: #008000">routing_key设置数据放到指定名称的消息队列里，参数是队列名称</span>
                      <span style="background-color: #ff99cc">body=<span style="color: #800000">'</span><span style="color: #800000">123</span><span style="color: #800000">'</span></span>)                       <span style="color: #008000">#</span><span style="color: #008000">body设置数据内容，参数是要写入指定队列的数据</span>
<span style="color: #000000">
connection.close()                                                  </span><span style="color: #008000">#</span><span style="color: #008000">关闭连接</span></pre>
</div>
<p><strong>生产者执行了7次，可以看到hello队列里有7条数据</strong></p>
<p><img src="https://images2015.cnblogs.com/blog/955761/201706/955761-20170622165931429-1151443746.png" alt=""></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000; background-color: #ffff00"><strong>消费者主机</strong></span></p>
<p><span style="color: #0000ff"><strong>callback(ch, method, properties, (body接收队列里的数据))</strong><span style="color: #ff0000"><strong>自定义获取队列数据后的回调函数</strong></span></span></p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">basic_consume(回调函数名称,queue='队列名称',no_ack=True)</span>在指定队列里获取数据，no_ack=True设置获取到数据后，是否删除队列里对应的数据</strong></span><br><span style="color: #ff0000"><strong><span style="color: #0000ff">start_consuming()</span>等待获取队列数据</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span>
<span style="color: #0000ff">import</span> pika  <span style="color: #008000">#</span><span style="color: #008000">导入连接操作RabbitMQ Server主机的模块</span>

<span style="color: #008000">#</span><span style="color: #008000"> ######################### 消费者 #########################</span>
<span style="color: #000000">
credentials </span>= pika.PlainCredentials(<span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>)                      <span style="color: #008000">#</span><span style="color: #008000">设置RabbitMQ Server用户名和密码</span>
parameters = pika.ConnectionParameters(<span style="color: #800000">'</span><span style="color: #800000">localhost</span><span style="color: #800000">'</span>, 5672,<span style="color: #800000">'</span><span style="color: #800000">/</span><span style="color: #800000">'</span>,credentials)  <span style="color: #008000">#</span><span style="color: #008000">设置ip和端口</span>
<span style="color: #000000">
connection </span>= pika.BlockingConnection(parameters)        <span style="color: #008000">#</span><span style="color: #008000">创建连接，自带了socket逻辑部分</span>
channel = connection.channel()                          <span style="color: #008000">#</span><span style="color: #008000">获取连接句柄</span>
<span style="color: #000000">
channel.queue_declare(<span style="background-color: #ff99cc">queue</span></span><span style="background-color: #ff99cc">=<span style="color: #800000">'</span><span style="color: #800000">hello</span><span style="color: #800000">'</span></span>)                    <span style="color: #008000">#</span><span style="color: #008000">向RabbitMQ Server创建一个消息队列，queue='hello'设置队列名称，如果此队列存在则不创建</span>


<span style="color: #0000ff">def</span> <span style="background-color: #ffff00">callback</span>(ch, method, properties, <span style="background-color: #ff99cc">body</span>):             <span style="color: #008000">#</span><span style="color: #008000">定义获取队列数据后的回调函数，body接收队列里的数据内容</span>
    <span style="color: #0000ff">print</span>(<span style="color: #800000">"</span><span style="color: #800000"> 你好 %r</span><span style="color: #800000">"</span> %<span style="color: #000000"><span style="background-color: #ff99cc"> body</span>)


</span><span style="color: #008000">#</span><span style="color: #008000">在指定队列里获取数据</span>
channel.basic_consume(<span style="background-color: #ffff00">callback</span>,                         <span style="color: #008000">#</span><span style="color: #008000">获取到数据后执行回调函数</span>
                      <span style="background-color: #ff99cc">queue=<span style="color: #800000">'</span><span style="color: #800000">hello</span><span style="color: #800000">'</span></span>,                    <span style="color: #008000">#</span><span style="color: #008000">指定获取数据的队列名称</span>
                      <span style="background-color: #ff99cc">no_ack=True</span>)                     <span style="color: #008000">#</span><span style="color: #008000">设置获取到数据后，是否删除队列里对应的数据，如果回调函数处理数据异常时会都丢失数据</span>
                                                        <span style="color: #008000">#</span><span style="color: #008000">如果要保证数据必须不丢失设置为False不删除数据,当接执行回调函数里ch.basic_ack(delivery_tag=method.delivery_tag)时才删除，但是效率不高</span>
<span style="color: #000000">

channel.start_consuming()                               </span><span style="color: #008000">#</span><span style="color: #008000">等待获取队列数据</span></pre>
</div>
<p><strong>执行后循环获取了7次，将hello队列里的7条数据拿了出来</strong></p>
<p><span style="color: #ff0000"><strong><img src="https://images2015.cnblogs.com/blog/955761/201706/955761-20170622170507851-1393266366.png" alt=""></strong></span></p>
<p><span style="color: #000000"><strong>可以看到<strong>hello队列里已经没有了数据</strong></strong></span></p>
<p><span style="color: #ff0000"><strong><img src="https://images2015.cnblogs.com/blog/955761/201706/955761-20170622172152632-2126900208.png" alt=""></strong></span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<hr>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000; font-size: 18pt; background-color: #ffff00"><strong>保证数据不丢失介绍</strong></span></p>
<p><span style="color: #ff0000; background-color: #ffff00"><strong>保证消费者数据不丢失</strong></span></p>
<p><span style="color: #ff0000"><strong>当消费者主机从队列里拿出数据时basic_consume()方法参数no_ack=True，表示拿出数据后立即删除队列里对应的数据，</strong></span></p>
<p><span style="color: #ff0000"><strong>如果消费者主机拿出数据，队列也删除了对应的数据，还没来得及处理数据，消费者主机死机了，这样数据就丢了</strong></span></p>
<p><span style="color: #ff0000"><strong>解决方法：</strong></span></p>
<p><span style="color: #ff0000"><strong><strong>当消费者主机从队列里拿出数据时<span style="color: #0000ff">basic_consume()方法参数no_ack=False</span>，表示<strong>拿出数据后不删除队列里对应的数据</strong></strong></strong></span></p>
<p><span style="color: #ff0000"><strong><strong><strong>在消费者回调函数里处理数据，当数据处理完成后写上<span style="color: #0000ff">ch.basic_ack(delivery_tag = method.delivery_tag)</span>，表示执行这串代码后才删除队列里对应的数据</strong></strong></strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf8 -*-</span>

<span style="color: #0000ff">import</span> pika  <span style="color: #008000">#</span><span style="color: #008000">导入连接操作RabbitMQ Server主机的模块</span>

<span style="color: #008000">#</span><span style="color: #008000"> ######################### 消费者 #########################</span>
<span style="color: #000000">
credentials </span>= pika.PlainCredentials(<span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>)                      <span style="color: #008000">#</span><span style="color: #008000">设置RabbitMQ Server用户名和密码</span>
parameters = pika.ConnectionParameters(<span style="color: #800000">'</span><span style="color: #800000">localhost</span><span style="color: #800000">'</span>, 5672,<span style="color: #800000">'</span><span style="color: #800000">/</span><span style="color: #800000">'</span>,credentials)  <span style="color: #008000">#</span><span style="color: #008000">设置ip和端口</span>
<span style="color: #000000">
connection </span>= pika.BlockingConnection(parameters)        <span style="color: #008000">#</span><span style="color: #008000">创建连接，自带了socket逻辑部分</span>
channel = connection.channel()                          <span style="color: #008000">#</span><span style="color: #008000">获取连接句柄</span>
<span style="color: #000000">
channel.queue_declare(queue</span>=<span style="color: #800000">'</span><span style="color: #800000">helloa</span><span style="color: #800000">'</span>,<span style="background-color: #ff99cc">durable=True</span>)         <span style="color: #008000">#</span><span style="color: #008000">向RabbitMQ Server创建一个消息队列，queue='hello'设置队列名称，如果此队列存在则不创建</span>


<span style="color: #0000ff">def</span> callback(ch, method, properties, body):             <span style="color: #008000">#</span><span style="color: #008000">定义获取队列数据后的回调函数，body接收队列里的数据内容</span>
    <span style="color: #0000ff">print</span>(<span style="color: #800000">"</span><span style="color: #800000"> 你好 %r</span><span style="color: #800000">"</span> %<span style="color: #000000"> body)
    <span style="background-color: #ff99cc">ch.basic_ack(delivery_tag</span></span><span style="background-color: #ff99cc">=method.delivery_tag)</span>      <span style="color: #008000">#</span><span style="color: #008000">执行这串代码后才删除队列里对应的数据</span>

<span style="color: #008000">#</span><span style="color: #008000">在指定队列里获取数据</span>
channel.basic_consume(callback,                         <span style="color: #008000">#</span><span style="color: #008000">获取到数据后执行回调函数</span>
                      queue=<span style="color: #800000">'</span><span style="color: #800000">helloa</span><span style="color: #800000">'</span>,                    <span style="color: #008000">#</span><span style="color: #008000">指定获取数据的队列名称</span>
                      <span style="background-color: #ff99cc">no_ack=False</span>)                     <span style="color: #008000">#</span><span style="color: #008000">设置获取到数据后，是否删除队列里对应的数据，如果回调函数处理数据异常时会都丢失数据</span>
                                                        <span style="color: #008000">#</span><span style="color: #008000">如果要保证数据必须不丢失设置为False不删除数据,当接执行回调函数里ch.basic_ack(delivery_tag=method.delivery_tag)时才删除，但是效率不高</span>
<span style="color: #000000">

channel.start_consuming()                               </span><span style="color: #008000">#</span><span style="color: #008000">等待获取队列数据</span></pre>
</div>
<p>&nbsp;</p>
<p><span style="color: #ff0000; background-color: #ffff00"><strong><strong>保证生产者数据不丢失</strong></strong></span></p>
<p><span style="color: #ff0000"><strong>如果RabbitMQ Server主机队列里有很多数据，此时RabbitMQ Server主机死机了，那么队列里的数据也就丢了</strong></span></p>
<p><span style="color: #ff0000"><strong>解决方法：</strong></span></p>
<p><span style="color: #ff0000"><strong>当生产者向RabbitMQ Server主机队列投递数据时，数据同时也在RabbitMQ Server主机硬盘保存一份，那么即使死机重启后数据也存在</strong></span></p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">basic_publish(properties=pika.BasicProperties(delivery_mode=2))</span>投递模式默认为1，修改成2表示投递的数据在RabbitMQ Server主机硬盘上保存一份，当消费者操作后删除队列数据时，也跟随删除</strong></span><br><span style="color: #ff0000"><strong><span style="color: #0000ff">queue_declare(durable=True)</span>表示队列里的数据开启硬盘保存，<span style="color: #0000ff; background-color: #ffcc99">注意：如果生产者设置了那么消费者也要设置</span></strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf8 -*-</span>

<span style="color: #0000ff">import</span> pika  <span style="color: #008000">#</span><span style="color: #008000">导入连接操作RabbitMQ Server主机的模块</span>

<span style="color: #008000">#</span><span style="color: #008000"> ######################### 生产者 #########################</span>
<span style="color: #000000">
credentials </span>= pika.PlainCredentials(<span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>)                      <span style="color: #008000">#</span><span style="color: #008000">设置RabbitMQ Server用户名和密码</span>
parameters = pika.ConnectionParameters(<span style="color: #800000">'</span><span style="color: #800000">localhost</span><span style="color: #800000">'</span>, 5672,<span style="color: #800000">'</span><span style="color: #800000">/</span><span style="color: #800000">'</span>,credentials)  <span style="color: #008000">#</span><span style="color: #008000">设置ip和端口</span>
<span style="color: #000000">
connection </span>= pika.BlockingConnection(parameters)        <span style="color: #008000">#</span><span style="color: #008000">创建连接，自带了socket逻辑部分</span>
channel = connection.channel()                          <span style="color: #008000">#</span><span style="color: #008000">获取连接句柄</span>
<span style="color: #000000">
channel.queue_declare(queue</span>=<span style="color: #800000">'</span><span style="color: #800000">helloa</span><span style="color: #800000">'</span>,<span style="background-color: #ff99cc">durable=True</span>)       <span style="color: #008000">#</span><span style="color: #008000">durable=True,表示队列里的数据开启硬盘保存</span>

<span style="color: #008000">#</span><span style="color: #008000">向指定队列里写入数据</span>
channel.basic_publish(exchange=<span style="color: #800000">''</span>,                      <span style="color: #008000">#</span><span style="color: #008000">exchange路由交换机，参数为空，路由交换机不工作</span>
                      routing_key=<span style="color: #800000">'</span><span style="color: #800000">helloa</span><span style="color: #800000">'</span>,              <span style="color: #008000">#</span><span style="color: #008000">routing_key设置数据放到指定名称的消息队列里，参数是队列名称</span>
                      body=<span style="color: #800000">'</span><span style="color: #800000">123</span><span style="color: #800000">'</span>,                       <span style="color: #008000">#</span><span style="color: #008000">body设置数据内容，参数是要写入指定队列的数据</span>
                      <span style="background-color: #ff99cc">properties=pika.BasicProperties(delivery_mode=2)</span>)   <span style="color: #008000">#</span><span style="color: #008000"> 投递模式默认为1，修改成2表示投递的数据在RabbitMQ Server主机硬盘上保存一份，当消费者操作后删除队列数据时，也跟随删除</span>
<span style="color: #000000">

connection.close()                                                  </span><span style="color: #008000">#</span><span style="color: #008000">关闭连接</span></pre>
</div>
<p>&nbsp;</p>
<hr>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000; background-color: #ffff00"><strong>消息获取顺序</strong></span></p>
<p><span style="color: #ff0000"><strong>默认消息队列里的数据是按照顺序被消费者拿走，例如：消费者1 去队列中获取 奇数 序列的任务，消费者2去队列中获取 偶数 序列的任务。</strong></span></p>
<p><span style="color: #ff0000"><strong>谁来谁取，不再按照奇偶数排列</strong></span></p>
<p><span style="color: #ff0000"><strong>在消费者获取队列数据方法<span style="color: #0000ff">basic_consume()</span>之前写一个<span style="color: #0000ff">channel.basic_qos(prefetch_count=1)</span>表示谁来谁取，不再按照奇偶数排列</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf8 -*-</span>

<span style="color: #0000ff">import</span> pika  <span style="color: #008000">#</span><span style="color: #008000">导入连接操作RabbitMQ Server主机的模块</span>

<span style="color: #008000">#</span><span style="color: #008000"> ######################### 消费者 #########################</span>
<span style="color: #000000">
credentials </span>= pika.PlainCredentials(<span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>)                      <span style="color: #008000">#</span><span style="color: #008000">设置RabbitMQ Server用户名和密码</span>
parameters = pika.ConnectionParameters(<span style="color: #800000">'</span><span style="color: #800000">localhost</span><span style="color: #800000">'</span>, 5672,<span style="color: #800000">'</span><span style="color: #800000">/</span><span style="color: #800000">'</span>,credentials)  <span style="color: #008000">#</span><span style="color: #008000">设置ip和端口</span>
<span style="color: #000000">
connection </span>= pika.BlockingConnection(parameters)        <span style="color: #008000">#</span><span style="color: #008000">创建连接，自带了socket逻辑部分</span>
channel = connection.channel()                          <span style="color: #008000">#</span><span style="color: #008000">获取连接句柄</span>
<span style="color: #000000">
channel.queue_declare(queue</span>=<span style="color: #800000">'</span><span style="color: #800000">helloa</span><span style="color: #800000">'</span>,durable=True)         <span style="color: #008000">#</span><span style="color: #008000">向RabbitMQ Server创建一个消息队列，queue='hello'设置队列名称，如果此队列存在则不创建</span>


<span style="color: #0000ff">def</span> callback(ch, method, properties, body):             <span style="color: #008000">#</span><span style="color: #008000">定义获取队列数据后的回调函数，body接收队列里的数据内容</span>
    <span style="color: #0000ff">print</span>(<span style="color: #800000">"</span><span style="color: #800000"> 你好 %r</span><span style="color: #800000">"</span> %<span style="color: #000000"> body)
    ch.basic_ack(delivery_tag</span>=method.delivery_tag)      <span style="color: #008000">#</span><span style="color: #008000">执行这串代码后才删除队列里对应的数据</span>
<span style="background-color: #ff99cc"><span style="color: #000000">
channel.basic_qos(prefetch_count</span>=1)  </span>                   <span style="color: #008000">#</span><span style="color: #008000">表示谁来谁取，不再按照奇偶数排列</span><span style="color: #008000">
#</span><span style="color: #008000">在指定队列里获取数据</span>
channel.basic_consume(callback,                         <span style="color: #008000">#</span><span style="color: #008000">获取到数据后执行回调函数</span>
                      queue=<span style="color: #800000">'</span><span style="color: #800000">helloa</span><span style="color: #800000">'</span>,                    <span style="color: #008000">#</span><span style="color: #008000">指定获取数据的队列名称</span>
                      no_ack=False)                     <span style="color: #008000">#</span><span style="color: #008000">设置获取到数据后，是否删除队列里对应的数据，如果回调函数处理数据异常时会都丢失数据</span>
                                                        <span style="color: #008000">#</span><span style="color: #008000">如果要保证数据必须不丢失设置为False不删除数据,当接执行回调函数里ch.basic_ack(delivery_tag=method.delivery_tag)时才删除，但是效率不高</span>
<span style="color: #000000">

channel.start_consuming()                               </span><span style="color: #008000">#</span><span style="color: #008000">等待获取队列数据</span></pre>
</div>
<p>&nbsp;</p>
<hr>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h4><span style="color: #ff0000; background-color: #ffff00">exchange交换机工作模型（fanout<span style="color: #0000ff">发布订阅</span>，direct<span style="color: #0000ff">关键字发送</span>，topic<span style="color: #0000ff">模糊匹配</span>）</span></h4>
<h4><span style="color: #ff0000; background-color: #ffff00"><strong>fanout交换机，发布订阅模式</strong></span></h4>
<p><span style="color: #ff0000"><strong>发布者发布数据到交换机，交换机将数据分发到所有订阅者创建的队列里，<span style="color: #0000ff; background-color: #ffffff">每个订阅者主机都获取一份数据</span></strong></span></p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff; background-color: #ffffff">列队只能由订阅者创建，订阅者创建的列队只要绑定了交换机都会获取到，交换机分发的数据</span></strong></span></p>
<p><span style="color: #000000"><strong>发布订阅和简单的消息队列区别在于，发布订阅会将消息发送给所有的订阅者，而消息队列中的数据被消费一次便消失。所以，RabbitMQ实现发布和订阅时，会为每一个订阅者创建一个队列，而发布者发布消息时，交换机会将消息放置在所有相关队列中。</strong></span></p>
<p><span style="color: #ff0000"><strong>exchange type = fanout</strong></span></p>
<p><span style="color: #ff0000"><strong><img src="https://images2015.cnblogs.com/blog/955761/201706/955761-20170623045136366-797009509.png" alt=""></strong></span></p>
<p><span style="color: #ff0000"><strong>&nbsp;发布者</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf8 -*-</span>

<span style="color: #0000ff">import</span> pika  <span style="color: #008000">#</span><span style="color: #008000">导入连接操作RabbitMQ Server主机的模块</span>
<span style="color: #0000ff">import</span><span style="color: #000000"> sys

</span><span style="color: #008000">#</span><span style="color: #008000"> ######################### 发布者 #########################</span>
<span style="color: #000000">
credentials </span>= pika.PlainCredentials(<span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>)                      <span style="color: #008000">#</span><span style="color: #008000">设置RabbitMQ Server用户名和密码</span>
parameters = pika.ConnectionParameters(<span style="color: #800000">'</span><span style="color: #800000">localhost</span><span style="color: #800000">'</span>, 5672,<span style="color: #800000">'</span><span style="color: #800000">/</span><span style="color: #800000">'</span>,credentials)  <span style="color: #008000">#</span><span style="color: #008000">设置ip和端口</span>
<span style="color: #000000">
connection </span>= pika.BlockingConnection(parameters)        <span style="color: #008000">#</span><span style="color: #008000">创建连接，自带了socket逻辑部分</span>
channel = connection.channel()                          <span style="color: #008000">#</span><span style="color: #008000">获取连接句柄</span>
<span style="color: #000000">
channel.exchange_declare(<span style="background-color: #ff99cc">exchange</span></span><span style="background-color: #ff99cc">=<span style="color: #800000">'</span><span style="color: #800000">logs</span><span style="color: #800000">'</span></span>,               <span style="color: #008000">#</span><span style="color: #008000">创建交换机，exchange='交换机名称'，type='fanout'交互机工作模式fanout为订阅模式</span>
                         <span style="background-color: #ff99cc">type=<span style="color: #800000">'</span><span style="color: #800000">fanout</span><span style="color: #800000">'</span></span><span style="color: #000000">)

message </span>= <span style="color: #800000">'</span> <span style="color: #800000">'</span>.join(sys.argv[1:]) <span style="color: #0000ff">or</span> <span style="color: #800000">"</span><span style="color: #800000">info: Hello World!</span><span style="color: #800000">"</span>    <span style="color: #008000">#</span><span style="color: #008000">设置向交换机发布的数据内容</span>

<span style="color: #008000">#</span><span style="color: #008000">向交换机发布内容</span>
channel.basic_publish(<span style="background-color: #ff99cc">exchange=<span style="color: #800000">'</span><span style="color: #800000">logs</span><span style="color: #800000">'</span></span>,     <span style="color: #008000">#</span><span style="color: #008000">设置要发布的交换机名称</span>
                      <span style="background-color: #ff99cc">routing_key=<span style="color: #800000">''</span>,</span>      <span style="color: #008000">#</span><span style="color: #008000">队列名称为空，因为数据是发布到交换机而不是队列，所以为空</span>
                      <span style="background-color: #ff99cc">body=message</span>)        <span style="color: #008000">#</span><span style="color: #008000">设置要发布的数据内容</span>
<span style="color: #0000ff">print</span>(<span style="color: #800000">"</span><span style="color: #800000">数据内容以发布到交换机</span><span style="color: #800000">"</span><span style="color: #000000">)

connection.close()                                                 </span><span style="color: #008000">#</span><span style="color: #008000">关闭连接</span></pre>
</div>
<p><span style="color: #ff0000"><strong>订阅者</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf8 -*-</span>

<span style="color: #0000ff">import</span> pika  <span style="color: #008000">#</span><span style="color: #008000">导入连接操作RabbitMQ Server主机的模块</span>

<span style="color: #008000">#</span><span style="color: #008000"> ######################### 订阅者 #########################</span>
<span style="color: #000000">
credentials </span>= pika.PlainCredentials(<span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>)                      <span style="color: #008000">#</span><span style="color: #008000">设置RabbitMQ Server用户名和密码</span>
parameters = pika.ConnectionParameters(<span style="color: #800000">'</span><span style="color: #800000">localhost</span><span style="color: #800000">'</span>, 5672,<span style="color: #800000">'</span><span style="color: #800000">/</span><span style="color: #800000">'</span>,credentials)  <span style="color: #008000">#</span><span style="color: #008000">设置ip和端口</span>
<span style="color: #000000">
connection </span>= pika.BlockingConnection(parameters)        <span style="color: #008000">#</span><span style="color: #008000">创建连接，自带了socket逻辑部分</span>
channel = connection.channel()                          <span style="color: #008000">#</span><span style="color: #008000">获取连接句柄</span>
<span style="color: #000000">

channel.exchange_declare(exchange</span>=<span style="color: #800000">'</span><span style="color: #800000">logs</span><span style="color: #800000">'</span>,               <span style="color: #008000">#</span><span style="color: #008000">创建交换机，exchange='交换机名称'，type='fanout'交互机工作模式fanout为订阅模式</span>
                         type=<span style="color: #800000">'</span><span style="color: #800000">fanout</span><span style="color: #800000">'</span><span style="color: #000000">)

result </span>= channel.queue_declare(exclusive=True)          <span style="color: #008000">#</span><span style="color: #008000">创建专一订阅消息队列，</span>
queue_name = result.method.queue                        <span style="color: #008000">#</span><span style="color: #008000">随机生成队列名称</span>

<span style="color: #008000">#</span><span style="color: #008000">将订阅队列绑定交换机</span>
channel.queue_bind(<span style="background-color: #ff99cc">exchange=<span style="color: #800000">'</span><span style="color: #800000">logs</span><span style="color: #800000">'</span></span>,                     <span style="color: #008000">#</span><span style="color: #008000">exchange='要绑定的交换机名称'</span>
                   <span style="background-color: #ff99cc">queue=queue_name</span>)                    <span style="color: #008000">#</span><span style="color: #008000">queue=要绑定交换机的队列名称</span>

<span style="color: #0000ff">def</span> <span style="background-color: #ffff99">callback</span>(ch, method, properties, body):             <span style="color: #008000">#</span><span style="color: #008000">定义获取队列数据后的回调函数，body接收队列里的数据内容</span>
    <span style="color: #0000ff">print</span>(<span style="color: #800000">"</span><span style="color: #800000">%r</span><span style="color: #800000">"</span> %<span style="color: #000000"> body)

</span><span style="color: #008000">#</span><span style="color: #008000">在指定队列里获取数据</span>
channel.basic_consume(<span style="background-color: #ffff99">callback</span>,                         <span style="color: #008000">#</span><span style="color: #008000">获取到数据后执行回调函数</span>
                      <span style="background-color: #ff99cc">queue=queue_name</span>,                 <span style="color: #008000">#</span><span style="color: #008000">指定获取数据的队列名称</span>
                      <span style="background-color: #ff99cc">no_ack=True</span>)                      <span style="color: #008000">#</span><span style="color: #008000">如果要保证数据必须不丢失设置为False不删除数据,当接执行回调函数里ch.basic_ack(delivery_tag=method.delivery_tag)时才删除，但是效率不高</span>
<span style="color: #000000">
channel.start_consuming()                               </span><span style="color: #008000">#</span><span style="color: #008000">等待获取队列数据</span>
</pre>
<hr>
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf8 -*-</span>

<span style="color: #0000ff">import</span> pika  <span style="color: #008000">#</span><span style="color: #008000">导入连接操作RabbitMQ Server主机的模块</span>

<span style="color: #008000">#</span><span style="color: #008000"> ######################### 订阅者 #########################</span>
<span style="color: #000000">
credentials </span>= pika.PlainCredentials(<span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>)                      <span style="color: #008000">#</span><span style="color: #008000">设置RabbitMQ Server用户名和密码</span>
parameters = pika.ConnectionParameters(<span style="color: #800000">'</span><span style="color: #800000">localhost</span><span style="color: #800000">'</span>, 5672,<span style="color: #800000">'</span><span style="color: #800000">/</span><span style="color: #800000">'</span>,credentials)  <span style="color: #008000">#</span><span style="color: #008000">设置ip和端口</span>
<span style="color: #000000">
connection </span>= pika.BlockingConnection(parameters)        <span style="color: #008000">#</span><span style="color: #008000">创建连接，自带了socket逻辑部分</span>
channel = connection.channel()                          <span style="color: #008000">#</span><span style="color: #008000">获取连接句柄</span>
<span style="color: #000000">

channel.exchange_declare(<span style="background-color: #ff99cc">exchange</span></span><span style="background-color: #ff99cc">=<span style="color: #800000">'</span><span style="color: #800000">logs</span><span style="color: #800000">'</span></span>,               <span style="color: #008000">#</span><span style="color: #008000">创建交换机，exchange='交换机名称'，type='fanout'交互机工作模式fanout为订阅模式</span>
                        <span style="background-color: #ff99cc"> type=<span style="color: #800000">'</span><span style="color: #800000">fanout</span><span style="color: #800000">'</span></span><span style="color: #000000">)

result </span>= channel.queue_declare(exclusive=True)          <span style="color: #008000">#</span><span style="color: #008000">创建专一订阅消息队列，</span>
queue_name = result.method.queue                        <span style="color: #008000">#</span><span style="color: #008000">随机生成队列名称</span>

<span style="color: #008000">#</span><span style="color: #008000">将订阅队列绑定交换机</span>
channel.queue_bind(<span style="background-color: #ff99cc">exchange=<span style="color: #800000">'</span><span style="color: #800000">logs</span><span style="color: #800000">'</span></span>,                     <span style="color: #008000">#</span><span style="color: #008000">exchange='要绑定的交换机名称'</span>
                   <span style="background-color: #ff99cc">queue=queue_name</span>)                    <span style="color: #008000">#</span><span style="color: #008000">queue=要绑定交换机的队列名称</span>

<span style="color: #0000ff">def</span> <span style="background-color: #ffff99">callback</span>(ch, method, properties, body):             <span style="color: #008000">#</span><span style="color: #008000">定义获取队列数据后的回调函数，body接收队列里的数据内容</span>
    <span style="color: #0000ff">print</span>(<span style="color: #800000">"</span><span style="color: #800000">%r</span><span style="color: #800000">"</span> %<span style="color: #000000"> body)

</span><span style="color: #008000">#</span><span style="color: #008000">在指定队列里获取数据</span>
channel.basic_consume(<span style="background-color: #ffff99">callback</span>,                         <span style="color: #008000">#</span><span style="color: #008000">获取到数据后执行回调函数</span>
                      <span style="background-color: #ff99cc">queue=queue_name</span>,                 <span style="color: #008000">#</span><span style="color: #008000">指定获取数据的队列名称</span>
                      <span style="background-color: #ff99cc">no_ack=True</span>)                      <span style="color: #008000">#</span><span style="color: #008000">如果要保证数据必须不丢失设置为False不删除数据,当接执行回调函数里ch.basic_ack(delivery_tag=method.delivery_tag)时才删除，但是效率不高</span>
<span style="color: #000000">
channel.start_consuming()                               </span><span style="color: #008000">#</span><span style="color: #008000">等待获取队列数据</span></pre>
</div>
<p>&nbsp;</p>
<hr>
<p>&nbsp;</p>
<h4>&nbsp;</h4>
<h4><span style="color: #ff0000; background-color: #ffff00"><strong>direct交换机，关键字发送模式</strong></span></h4>
<p><span style="color: #ff0000"><strong>exchange type = direct</strong></span></p>
<p><span style="color: #0000ff"><strong>也叫做完全匹配模式</strong></span></p>
<p><span style="color: #ff0000"><strong>RabbitMQ还支持根据关键字发送，即：队列绑定关键字，生产者设置关键字将数据发送到exchange交换机，exchange交换机根据 消费者列队设置的关键字 判定应该将数据发送至指定队列。</strong></span></p>
<p><strong><span style="color: #ff0000">也就是说消费者列队设置的关键字，和生产者发送数据设置的关键字</span>，<span style="color: #0000ff">两者只要是一样关键字的，消费者主机都会获取到一份数据</span></strong></p>
<p><span style="color: #ff0000; background-color: #ffffff"><strong>【重点】<span style="color: #0000ff">消费者可以设置多个关键字</span></strong></span></p>
<p><span style="color: #ff0000; background-color: #ffff00"><strong><img src="https://images2015.cnblogs.com/blog/955761/201706/955761-20170623175754023-1060633775.png" alt=""></strong></span></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000; background-color: #ffff00"><strong>生产者</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf8 -*-</span>

<span style="color: #0000ff">import</span> pika  <span style="color: #008000">#</span><span style="color: #008000">导入连接操作RabbitMQ Server主机的模块</span>
<span style="color: #0000ff">import</span><span style="color: #000000"> sys

</span><span style="color: #008000">#</span><span style="color: #008000"> ######################### 生产者 #########################</span>
<span style="color: #000000">
credentials </span>= pika.PlainCredentials(<span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>)                      <span style="color: #008000">#</span><span style="color: #008000">设置RabbitMQ Server用户名和密码</span>
parameters = pika.ConnectionParameters(<span style="color: #800000">'</span><span style="color: #800000">localhost</span><span style="color: #800000">'</span>, 5672,<span style="color: #800000">'</span><span style="color: #800000">/</span><span style="color: #800000">'</span>,credentials)  <span style="color: #008000">#</span><span style="color: #008000">设置ip和端口</span>
<span style="color: #000000">
connection </span>= pika.BlockingConnection(parameters)        <span style="color: #008000">#</span><span style="color: #008000">创建连接，自带了socket逻辑部分</span>
channel = connection.channel()                          <span style="color: #008000">#</span><span style="color: #008000">获取连接句柄</span>
<span style="color: #000000">
channel.exchange_declare(<span style="background-color: #ff99cc">exchange</span></span><span style="background-color: #ff99cc">=<span style="color: #800000">'</span><span style="color: #800000">logs</span><span style="color: #800000">'</span></span>,               <span style="color: #008000">#</span><span style="color: #008000">创建交换机，exchange='交换机名称'，type='direct'交互机工作模式direct为关键字发送模式</span>
                         <span style="background-color: #ff99cc">type=<span style="color: #800000">'</span><span style="color: #800000">direct</span><span style="color: #800000">'</span></span><span style="color: #000000">)

message </span>= <span style="color: #800000">'</span> <span style="color: #800000">'</span>.join(sys.argv[1:]) <span style="color: #0000ff">or</span> <span style="color: #800000">"</span><span style="color: #800000">info: Hello World!</span><span style="color: #800000">"</span>    <span style="color: #008000">#</span><span style="color: #008000">设置向交换机发布的数据内容</span>

<span style="color: #008000">#</span><span style="color: #008000">向交换机发布内容</span>
channel.basic_publish(<span style="background-color: #ff99cc">exchange=<span style="color: #800000">'</span><span style="color: #800000">logs</span><span style="color: #800000">'</span></span>,          <span style="color: #008000">#</span><span style="color: #008000">设置要发布的交换机名称</span>
                      <span style="background-color: #ffff00">routing_key=<span style="color: #800000">'</span><span style="color: #800000">severity</span><span style="color: #800000">'</span></span>,   <span style="color: #008000">#</span><span style="color: #008000; background-color: #ff99cc">设置信道关键字</span>
                      <span style="background-color: #ff99cc">body=message</span>)             <span style="color: #008000">#</span><span style="color: #008000">设置要发布的数据内容</span>
<span style="color: #0000ff">print</span>(<span style="color: #800000">"</span><span style="color: #800000">数据内容以发布到交换机</span><span style="color: #800000">"</span><span style="color: #000000">)

connection.close()                                                 </span><span style="color: #008000">#</span><span style="color: #008000">关闭连接</span></pre>
</div>
<p><span style="color: #ff0000"><strong>消费者，设置一个信道关键字</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf8 -*-</span>

<span style="color: #0000ff">import</span> pika  <span style="color: #008000">#</span><span style="color: #008000">导入连接操作RabbitMQ Server主机的模块</span>

<span style="color: #008000">#</span><span style="color: #008000"> ######################### 消费者 #########################</span>
<span style="color: #000000">
credentials </span>= pika.PlainCredentials(<span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>)                      <span style="color: #008000">#</span><span style="color: #008000">设置RabbitMQ Server用户名和密码</span>
parameters = pika.ConnectionParameters(<span style="color: #800000">'</span><span style="color: #800000">localhost</span><span style="color: #800000">'</span>, 5672,<span style="color: #800000">'</span><span style="color: #800000">/</span><span style="color: #800000">'</span>,credentials)  <span style="color: #008000">#</span><span style="color: #008000">设置ip和端口</span>
<span style="color: #000000">
connection </span>= pika.BlockingConnection(parameters)        <span style="color: #008000">#</span><span style="color: #008000">创建连接，自带了socket逻辑部分</span>
channel = connection.channel()                          <span style="color: #008000">#</span><span style="color: #008000">获取连接句柄</span>
<span style="color: #000000">

channel.exchange_declare(exchange</span>=<span style="color: #800000">'</span><span style="color: #800000">logs</span><span style="color: #800000">'</span>,               <span style="color: #008000">#</span><span style="color: #008000">创建交换机，exchange='交换机名称'，type='direct'交互机工作模式direct为关键字发送模式</span>
                         type=<span style="color: #800000">'</span><span style="color: #800000">direct</span><span style="color: #800000">'</span><span style="color: #000000">)

result </span>= channel.queue_declare(exclusive=True)          <span style="color: #008000">#</span><span style="color: #008000">创建专一消息队列，</span>
queue_name = result.method.queue                        <span style="color: #008000">#</span><span style="color: #008000">随机生成队列名称</span>

<span style="color: #008000">#</span><span style="color: #008000">将队列绑定交换机</span>
channel.queue_bind(<span style="background-color: #ff99cc">exchange=<span style="color: #800000">'</span><span style="color: #800000">logs</span><span style="color: #800000">'</span></span>,                     <span style="color: #008000">#</span><span style="color: #008000">exchange='要绑定的交换机名称'</span>
                   <span style="background-color: #ff99cc">queue=queue_name</span>,                    <span style="color: #008000">#</span><span style="color: #008000">queue=要绑定交换机的队列名称</span>
                   <span style="background-color: #ffff00">routing_key=<span style="color: #800000">'</span><span style="color: #800000">severity</span><span style="color: #800000">'</span></span>,)             <span style="color: #008000">#</span><span style="color: #008000; background-color: #ff99cc">设置信道关键字</span>

<span style="color: #0000ff">def</span> callback(ch, method, properties, body):             <span style="color: #008000">#</span><span style="color: #008000">定义获取队列数据后的回调函数，body接收队列里的数据内容</span>
    <span style="color: #0000ff">print</span>(<span style="color: #800000">"</span><span style="color: #800000">%r</span><span style="color: #800000">"</span> %<span style="color: #000000"> body)

</span><span style="color: #008000">#</span><span style="color: #008000">在指定队列里获取数据</span>
channel.basic_consume(callback,                         <span style="color: #008000">#</span><span style="color: #008000">获取到数据后执行回调函数</span>
                      queue=queue_name,                 <span style="color: #008000">#</span><span style="color: #008000">指定获取数据的队列名称</span>
                      no_ack=True)                      <span style="color: #008000">#</span><span style="color: #008000">如果要保证数据必须不丢失设置为False不删除数据,当接执行回调函数里ch.basic_ack(delivery_tag=method.delivery_tag)时才删除，但是效率不高</span>
<span style="color: #000000">
channel.start_consuming()                               </span><span style="color: #008000">#</span><span style="color: #008000">等待获取队列数据</span></pre>
</div>
<p><span style="color: #ff0000"><strong>消费者，设置多个信道关键字</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf8 -*-</span>

<span style="color: #0000ff">import</span> pika  <span style="color: #008000">#</span><span style="color: #008000">导入连接操作RabbitMQ Server主机的模块</span>

<span style="color: #008000">#</span><span style="color: #008000"> ######################### 消费者 #########################</span>
<span style="color: #000000">
credentials </span>= pika.PlainCredentials(<span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>)                      <span style="color: #008000">#</span><span style="color: #008000">设置RabbitMQ Server用户名和密码</span>
parameters = pika.ConnectionParameters(<span style="color: #800000">'</span><span style="color: #800000">localhost</span><span style="color: #800000">'</span>, 5672,<span style="color: #800000">'</span><span style="color: #800000">/</span><span style="color: #800000">'</span>,credentials)  <span style="color: #008000">#</span><span style="color: #008000">设置ip和端口</span>
<span style="color: #000000">
connection </span>= pika.BlockingConnection(parameters)        <span style="color: #008000">#</span><span style="color: #008000">创建连接，自带了socket逻辑部分</span>
channel = connection.channel()                          <span style="color: #008000">#</span><span style="color: #008000">获取连接句柄</span>
<span style="color: #000000">

channel.exchange_declare(exchange</span>=<span style="color: #800000">'</span><span style="color: #800000">logs</span><span style="color: #800000">'</span>,               <span style="color: #008000">#</span><span style="color: #008000">创建交换机，exchange='交换机名称'，type='direct'交互机工作模式direct为关键字发送模式</span>
                         type=<span style="color: #800000">'</span><span style="color: #800000">direct</span><span style="color: #800000">'</span><span style="color: #000000">)

result </span>= channel.queue_declare(exclusive=True)          <span style="color: #008000">#</span><span style="color: #008000">创建专一消息队列，</span>
queue_name = result.method.queue                        <span style="color: #008000">#</span><span style="color: #008000">随机生成队列名称</span>

<span style="color: #008000">#</span><span style="color: #008000">将队列绑定交换机</span>
<span style="background-color: #ffff99">channel.queue_bind(exchange=<span style="color: #800000">'</span><span style="color: #800000">logs</span><span style="color: #800000">'</span>,                     <span style="color: #008000">#</span><span style="color: #008000">exchange='要绑定的交换机名称'</span>
                   queue=queue_name,                    <span style="color: #008000">#</span><span style="color: #008000">queue=要绑定交换机的队列名称</span>
                   <span style="background-color: #ff99cc">routing_key=<span style="color: #800000">'</span><span style="color: #800000">severity</span><span style="color: #800000">'</span></span>,)             <span style="color: #008000">#</span><span style="color: #008000">设置信道关键字</span>
<span style="color: #000000">
channel.queue_bind(exchange</span>=<span style="color: #800000">'</span><span style="color: #800000">logs</span><span style="color: #800000">'</span>,                     <span style="color: #008000">#</span><span style="color: #008000">exchange='要绑定的交换机名称'</span>
                   queue=queue_name,                    <span style="color: #008000">#</span><span style="color: #008000">queue=要绑定交换机的队列名称</span>
                   <span style="background-color: #ff99cc">routing_key=<span style="color: #800000">'</span><span style="color: #800000">severity2</span><span style="color: #800000">'</span></span>,)             <span style="color: #008000">#</span><span style="color: #008000">设置信道关键字</span>
<span style="color: #000000">
channel.queue_bind(exchange</span>=<span style="color: #800000">'</span><span style="color: #800000">logs</span><span style="color: #800000">'</span>,                     <span style="color: #008000">#</span><span style="color: #008000">exchange='要绑定的交换机名称'</span>
                   queue=queue_name,                    <span style="color: #008000">#</span><span style="color: #008000">queue=要绑定交换机的队列名称</span>
                   <span style="background-color: #ff99cc">routing_key=<span style="color: #800000">'</span><span style="color: #800000">severity3</span><span style="color: #800000">'</span></span>,)             <span style="color: #008000">#</span><span style="color: #008000">设置信道关键字</span>

<span style="color: #0000ff">def</span> callback(ch, method, properties, body):             <span style="color: #008000">#</span><span style="color: #008000">定义获取队列数据后的回调函数，body接收队列里的数据内容</span>
    <span style="color: #0000ff">print</span>(<span style="color: #800000">"</span><span style="color: #800000">%r</span><span style="color: #800000">"</span> %<span style="color: #000000"> body)

</span></span><span style="color: #008000">#</span><span style="color: #008000">在指定队列里获取数据</span>
channel.basic_consume(callback,                         <span style="color: #008000">#</span><span style="color: #008000">获取到数据后执行回调函数</span>
                      queue=queue_name,                 <span style="color: #008000">#</span><span style="color: #008000">指定获取数据的队列名称</span>
                      no_ack=True)                      <span style="color: #008000">#</span><span style="color: #008000">如果要保证数据必须不丢失设置为False不删除数据,当接执行回调函数里ch.basic_ack(delivery_tag=method.delivery_tag)时才删除，但是效率不高</span>
<span style="color: #000000">
channel.start_consuming()                               </span><span style="color: #008000">#</span><span style="color: #008000">等待获取队列数据</span></pre>
</div>
<p>&nbsp;</p>
<hr>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h4><span style="color: #ff0000; background-color: #ffff00"><strong><strong>&nbsp;topic</strong>交换机，模糊匹配发送模式</strong></span></h4>
<p><span style="color: #ff0000"><strong>exchange type = topic</strong></span></p>
<p><span style="color: #ff0000"><strong>在topic类型下，可以让队列绑定几个模糊的关键字，之后发送者将数据发送到exchange交换机，exchange交换机将传入的”列队关键字“和 ”生产者关键字“进行匹配，匹配成功，则将数据发送到指定队列。</strong></span></p>
<ul>
<li><span style="color: #ff0000"><strong># 表示可以匹配 0 个 或 多个 单词</strong></span></li>
<li><span style="color: #ff0000"><strong>* &nbsp;表示只能匹配 一个 单词</strong></span></li>
</ul>
<p><span style="color: #0000ff"><strong>例如：</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #000000">发送者关键字               生产者匹配
old.boy.python          old.</span>*  --<span style="color: #000000"> 不匹配
old.boy.python          old.</span><span style="color: #008000">#</span><span style="color: #008000">  -- 匹配</span></pre>
</div>
<p><img src="https://images2015.cnblogs.com/blog/955761/201706/955761-20170623185315195-485322930.png" alt=""></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>生产者</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf8 -*-</span>

<span style="color: #0000ff">import</span> pika  <span style="color: #008000">#</span><span style="color: #008000">导入连接操作RabbitMQ Server主机的模块</span>
<span style="color: #0000ff">import</span><span style="color: #000000"> sys

</span><span style="color: #008000">#</span><span style="color: #008000"> ######################### 生产者 #########################</span>
<span style="color: #000000">
credentials </span>= pika.PlainCredentials(<span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>)                      <span style="color: #008000">#</span><span style="color: #008000">设置RabbitMQ Server用户名和密码</span>
parameters = pika.ConnectionParameters(<span style="color: #800000">'</span><span style="color: #800000">localhost</span><span style="color: #800000">'</span>, 5672,<span style="color: #800000">'</span><span style="color: #800000">/</span><span style="color: #800000">'</span>,credentials)  <span style="color: #008000">#</span><span style="color: #008000">设置ip和端口</span>
<span style="color: #000000">
connection </span>= pika.BlockingConnection(parameters)        <span style="color: #008000">#</span><span style="color: #008000">创建连接，自带了socket逻辑部分</span>
channel = connection.channel()                          <span style="color: #008000">#</span><span style="color: #008000">获取连接句柄</span>
<span style="color: #000000">
channel.exchange_declare(exchange</span>=<span style="color: #800000">'</span><span style="color: #800000">logs</span><span style="color: #800000">'</span>,               <span style="color: #008000">#</span><span style="color: #008000">创建交换机，exchange='交换机名称'，type='topic'交互机工作模式topic为模糊匹配发送模式</span>
                         <span style="background-color: #ff99cc">type=<span style="color: #800000">'</span><span style="color: #800000">topic</span><span style="color: #800000">'</span></span><span style="color: #000000">)

<span style="background-color: #ffff99">routing_key </span></span>= sys.argv[1] <span style="color: #0000ff">if</span> len(sys.argv) &gt; 1 <span style="color: #0000ff">else</span> <span style="background-color: #ff99cc"><span style="color: #800000">'</span><span style="color: #800000">anonymous.info</span><span style="color: #800000">'</span></span>  <span style="color: #008000">#</span><span style="color: #008000">设置发送关键字</span>
<span style="background-color: #ffff99">message</span> = <span style="color: #800000">'</span> <span style="color: #800000">'</span>.join(sys.argv[2:]) <span style="color: #0000ff">or</span> <span style="background-color: #ff99cc"><span style="color: #800000">'</span><span style="color: #800000">Hello World!</span><span style="color: #800000">'</span></span>                    <span style="color: #008000">#</span><span style="color: #008000">设置发送内容</span>

<span style="color: #008000">#</span><span style="color: #008000">向交换机发送内容</span>
channel.basic_publish(exchange=<span style="color: #800000">'</span><span style="color: #800000">logs</span><span style="color: #800000">'</span>,              <span style="color: #008000">#</span><span style="color: #008000">设置要发布的交换机名称</span>
                      <span style="background-color: #ffff99">routing_key=routing_key</span>,      <span style="color: #008000">#</span><span style="color: #008000">设置信道关键字：anonymous.info</span>
                      body=<span style="background-color: #ffff99">message</span>)                 <span style="color: #008000">#</span><span style="color: #008000">设置要发布的数据内容：Hello World!</span>

<span style="color: #0000ff">print</span>(<span style="color: #800000">"</span><span style="color: #800000"> [x] Sent %r:%r</span><span style="color: #800000">"</span> % (routing_key, message))   <span style="color: #008000">#</span><span style="color: #008000">打印出相关内容</span>
<span style="color: #000000">
connection.close()          </span><span style="color: #008000">#</span><span style="color: #008000">关闭连接</span></pre>
</div>
<p><span style="color: #ff0000"><strong>消费者</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf8 -*-</span>

<span style="color: #0000ff">import</span> pika  <span style="color: #008000">#</span><span style="color: #008000">导入连接操作RabbitMQ Server主机的模块</span>

<span style="color: #008000">#</span><span style="color: #008000"> ######################### 消费者 #########################</span>
<span style="color: #000000">
credentials </span>= pika.PlainCredentials(<span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">guest</span><span style="color: #800000">'</span>)                      <span style="color: #008000">#</span><span style="color: #008000">设置RabbitMQ Server用户名和密码</span>
parameters = pika.ConnectionParameters(<span style="color: #800000">'</span><span style="color: #800000">localhost</span><span style="color: #800000">'</span>, 5672,<span style="color: #800000">'</span><span style="color: #800000">/</span><span style="color: #800000">'</span>,credentials)  <span style="color: #008000">#</span><span style="color: #008000">设置ip和端口</span>
<span style="color: #000000">
connection </span>= pika.BlockingConnection(parameters)        <span style="color: #008000">#</span><span style="color: #008000">创建连接，自带了socket逻辑部分</span>
channel = connection.channel()                          <span style="color: #008000">#</span><span style="color: #008000">获取连接句柄</span>
<span style="color: #000000">

channel.exchange_declare(<span style="background-color: #ff99cc">exchange</span></span><span style="background-color: #ff99cc">=<span style="color: #800000">'</span><span style="color: #800000">logs</span><span style="color: #800000">'</span></span>,               <span style="color: #008000">#</span><span style="color: #008000">创建交换机，exchange='交换机名称'，type='topic'交互机工作模式topic为模糊匹配发送模式</span>
                         <span style="background-color: #ff99cc">type=<span style="color: #800000">'</span><span style="color: #800000">topic</span><span style="color: #800000">'</span></span><span style="color: #000000">)

result </span>= channel.queue_declare(exclusive=True)          <span style="color: #008000">#</span><span style="color: #008000">创建专一消息队列，</span>
<span style="background-color: #ffff99">queue_name</span> = result.method.queue                        <span style="color: #008000">#</span><span style="color: #008000">随机生成队列名称</span>

<span style="color: #008000">#</span><span style="color: #008000">将队列绑定交换机</span>
channel.queue_bind(exchange=<span style="color: #800000">'</span><span style="color: #800000">logs</span><span style="color: #800000">'</span>,                     <span style="color: #008000">#</span><span style="color: #008000">exchange='要绑定的交换机名称'</span>
                   queue=queue_name,                    <span style="color: #008000">#</span><span style="color: #008000">queue=要绑定交换机的队列名称</span>
                   <span style="background-color: #ff99cc">routing_key=<span style="color: #800000">'</span><span style="color: #800000">anonymous.*</span><span style="color: #800000">'</span>,</span>)             <span style="color: #008000">#</span><span style="color: #008000">设置信道关键字匹配</span>

<span style="color: #0000ff">def</span> <span style="background-color: #ffff99">callback</span>(ch, method, properties, body):             <span style="color: #008000">#</span><span style="color: #008000">定义获取队列数据后的回调函数，body接收队列里的数据内容</span>
    <span style="color: #0000ff">print</span>(<span style="color: #800000">"</span><span style="color: #800000">%r</span><span style="color: #800000">"</span> %<span style="color: #000000"> body)

</span><span style="color: #008000">#</span><span style="color: #008000">在指定队列里获取数据</span>
channel.basic_consume(<span style="background-color: #ffff99">callback</span>,                         <span style="color: #008000">#</span><span style="color: #008000">获取到数据后执行回调函数</span>
                      queue=<span style="background-color: #ffff99">queue_name</span>,                 <span style="color: #008000">#</span><span style="color: #008000">指定获取数据的队列名称</span>
                      no_ack=True)                      <span style="color: #008000">#</span><span style="color: #008000">如果要保证数据必须不丢失设置为False不删除数据,当接执行回调函数里ch.basic_ack(delivery_tag=method.delivery_tag)时才删除，但是效率不高</span>
<span style="color: #000000">
channel.start_consuming()                               </span><span style="color: #008000">#</span><span style="color: #008000">等待获取队列数据</span></pre>
</div>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>更多教程，可以查看官方教程</strong></span></p>
<p><strong>http://www.rabbitmq.com/getstarted.html</strong></p>
<p><strong><img src="https://images2015.cnblogs.com/blog/955761/201706/955761-20170623201235991-2064759703.png" alt=""></strong></p>
<p>&nbsp;</p></div>