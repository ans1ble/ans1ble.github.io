第三百二十五节，web爬虫，scrapy模块标签选择器下载图片，以及正则匹配标签


			<div id="cnblogs_post_body" class="blogpost-body"><p><strong>第三百二十五节，web爬虫，scrapy模块标签选择器下载图片，以及正则匹配标签</strong></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000; background-color: #ffff00"><strong>标签选择器对象</strong></span></p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">HtmlXPathSelector()</span>创建标签选择器对象，参数接收response回调的html对象</strong></span><br><span style="color: #0000ff"><strong>需要导入模块：from scrapy.selector import HtmlXPathSelector</strong></span></p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">select()</span>标签选择器方法，是HtmlXPathSelector里的一个方法，参数接收选择器规则，返回列表元素是一个标签对象</strong></span></p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">extract()</span>获取到选择器过滤后的内容，返回列表元素是内容</strong></span></p>
<p><span style="background-color: #ffff00; color: #ff0000"><strong>选择器规则</strong></span></p>
<p><span style="color: #ff0000"><strong>　　<span style="color: #0000ff">//x</span> 表示向下查找n层指定标签，如：//div 表示查找所有div标签</strong></span><br><span style="color: #ff0000"><strong>　　<span style="color: #0000ff">/x</span> 表示向下查找一层指定的标签</strong></span><br><span style="color: #ff0000"><strong>　　<span style="color: #0000ff">/@x</span> 表示查找指定属性,可以连缀如：@id @src</strong></span><br><span style="color: #ff0000"><strong>　　<span style="color: #0000ff">[@class="class名称"]</span> 表示查找指定属性等于指定值的标签,可以连缀 ，查找class名称等于指定名称的标签</strong></span><br><span style="color: #ff0000"><strong>　　<span style="color: #0000ff">/text()</span> 获取标签文本类容</strong></span><br><span style="color: #ff0000"><strong>　　<span style="color: #0000ff">[x]</span> 通过索引获取集合里的指定一个元素</strong></span></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>获取指定的标签对象</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000"> -*- coding: utf-8 -*-</span>
<span style="color: #0000ff">import</span> scrapy       <span style="color: #008000">#</span><span style="color: #008000">导入爬虫模块</span>
<span style="color: #0000ff">from</span> scrapy.selector <span style="color: #0000ff">import</span> <span style="background-color: #ff99cc">HtmlXPathSelector</span>  <span style="color: #008000">#</span><span style="color: #008000">导入HtmlXPathSelector模块</span>
<span style="color: #0000ff">from</span> urllib <span style="color: #0000ff">import</span> request                     <span style="color: #008000">#</span><span style="color: #008000">导入request模块</span>
<span style="color: #0000ff">import</span><span style="color: #000000"> os


</span><span style="color: #0000ff">class</span><span style="color: #000000"> AdcSpider(scrapy.Spider):
    name </span>= <span style="color: #800000">'</span><span style="color: #800000">adc</span><span style="color: #800000">'</span>                                        <span style="color: #008000">#</span><span style="color: #008000">设置爬虫名称</span>
    allowed_domains = [<span style="color: #800000">'</span><span style="color: #800000">www.shaimn.com</span><span style="color: #800000">'</span><span style="color: #000000">]
    start_urls </span>= [<span style="color: #800000">'</span><span style="color: #800000">http://www.shaimn.com/xinggan/</span><span style="color: #800000">'</span><span style="color: #000000">]

    </span><span style="color: #0000ff">def</span><span style="color: #000000"> parse(self, response):
        <span style="background-color: #ff99cc">hxs </span></span><span style="background-color: #ff99cc">= HtmlXPathSelector(response)</span>               <span style="color: #008000">#</span><span style="color: #008000">创建HtmlXPathSelector对象，将页面返回对象传进去</span>
<span style="background-color: #ff99cc"><span style="color: #000000">
        items </span>= hxs.select(<span style="color: #800000">'</span><span style="color: #800000">//div[@class="showlist"]/li</span><span style="color: #800000">'</span>)</span>  <span style="color: #008000">#</span><span style="color: #008000">标签选择器，表示获取所有class等于showlist的div，下面的li标签</span>
        <span style="background-color: #ff99cc"><span style="color: #0000ff">print</span>(items)</span>                                       <span style="color: #008000">#</span><span style="color: #008000">返回标签对象</span></pre>
</div>
<p><img src="https://images2015.cnblogs.com/blog/955761/201707/955761-20170724214010246-121774391.png" alt=""></p>
<p><img src="https://images2015.cnblogs.com/blog/955761/201707/955761-20170724214101418-1739507610.png" alt=""></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>循环获取到每个<span style="color: #0000ff">li标签</span>里的子标签，以及各种属性或者文本</strong></span></p>
<p><img src="https://images2015.cnblogs.com/blog/955761/201707/955761-20170724214631653-1399534656.png" alt=""></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000"> -*- coding: utf-8 -*-</span>
<span style="color: #0000ff">import</span> scrapy       <span style="color: #008000">#</span><span style="color: #008000">导入爬虫模块</span>
<span style="color: #0000ff">from</span> scrapy.selector <span style="color: #0000ff">import</span> <span style="background-color: #ff99cc">HtmlXPathSelector</span>  <span style="color: #008000">#</span><span style="color: #008000">导入HtmlXPathSelector模块</span>
<span style="color: #0000ff">from</span> urllib <span style="color: #0000ff">import</span> request                     <span style="color: #008000">#</span><span style="color: #008000">导入request模块</span>
<span style="color: #0000ff">import</span><span style="color: #000000"> os


</span><span style="color: #0000ff">class</span><span style="color: #000000"> AdcSpider(scrapy.Spider):
    name </span>= <span style="color: #800000">'</span><span style="color: #800000">adc</span><span style="color: #800000">'</span>                                        <span style="color: #008000">#</span><span style="color: #008000">设置爬虫名称</span>
    allowed_domains = [<span style="color: #800000">'</span><span style="color: #800000">www.shaimn.com</span><span style="color: #800000">'</span><span style="color: #000000">]
    start_urls </span>= [<span style="color: #800000">'</span><span style="color: #800000">http://www.shaimn.com/xinggan/</span><span style="color: #800000">'</span><span style="color: #000000">]

    </span><span style="color: #0000ff">def</span><span style="color: #000000"> parse(self, response):
       <span style="background-color: #ff99cc"> hxs </span></span><span style="background-color: #ff99cc">= HtmlXPathSelector(response)</span>               <span style="color: #008000">#</span><span style="color: #008000">创建HtmlXPathSelector对象，将页面返回对象传进去</span>
<span style="background-color: #ff99cc"><span style="color: #000000">
        items </span>= hxs.select(<span style="color: #800000">'</span><span style="color: #800000">//div[@class="showlist"]/li</span><span style="color: #800000">'</span>)</span>  <span style="color: #008000">#</span><span style="color: #008000">标签选择器，表示获取所有class等于showlist的div，下面的li标签</span>
        <span style="color: #008000">#</span><span style="color: #008000"> print(items)                                     #返回标签对象</span>
<span style="background-color: #ff99cc">        <span style="color: #0000ff">for</span> i <span style="color: #0000ff">in</span> range(len(items)):                        <span style="color: #008000">#</span><span style="color: #008000">根据li标签的长度循环次数</span>
            title = hxs.select(<span style="color: #800000">'</span><span style="color: #800000">//div[@class="showlist"]/li[%d]//img/@alt</span><span style="color: #800000">'</span> % i).extract()   <span style="color: #008000">#</span><span style="color: #008000">根据循环的次数作为下标获取到当前li标签，下的img标签的alt属性内容</span>
            src = hxs.select(<span style="color: #800000">'</span><span style="color: #800000">//div[@class="showlist"]/li[%d]//img/@src</span><span style="color: #800000">'</span> % i).extract()     <span style="color: #008000">#</span><span style="color: #008000">根据循环的次数作为下标获取到当前li标签，下的img标签的src属性内容</span>
            <span style="color: #0000ff">if</span> title <span style="color: #0000ff">and</span><span style="color: #000000"> src:
                </span><span style="color: #0000ff">print</span>(title,src)  <span style="color: #008000">#</span><span style="color: #008000">返回类容列表</span></span></pre>
</div>
<p><img src="https://images2015.cnblogs.com/blog/955761/201707/955761-20170724215613746-1268949963.png" alt=""></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>将获取到的图片下载到本地</strong></span></p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">urlretrieve()</span>将文件保存到本地，参数1要保存文件的src，参数2保存路径</strong></span><br><span style="color: #000000"><strong>urlretrieve是urllib下request模块的一个方法，需要导入<span style="color: #0000ff">from urllib import request</span></strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000"> -*- coding: utf-8 -*-</span>
<span style="color: #0000ff">import</span> scrapy       <span style="color: #008000">#</span><span style="color: #008000">导入爬虫模块</span>
<span style="color: #0000ff">from</span> scrapy.selector <span style="color: #0000ff">import</span> <span style="background-color: #ff99cc">HtmlXPathSelector</span>  <span style="color: #008000">#</span><span style="color: #008000">导入HtmlXPathSelector模块</span>
<span style="color: #0000ff">from</span> urllib <span style="color: #0000ff">import</span> request                     <span style="color: #008000">#</span><span style="color: #008000">导入request模块</span>
<span style="color: #0000ff">import</span><span style="color: #000000"> os


</span><span style="color: #0000ff">class</span><span style="color: #000000"> AdcSpider(scrapy.Spider):
    name </span>= <span style="color: #800000">'</span><span style="color: #800000">adc</span><span style="color: #800000">'</span>                                        <span style="color: #008000">#</span><span style="color: #008000">设置爬虫名称</span>
    allowed_domains = [<span style="color: #800000">'</span><span style="color: #800000">www.shaimn.com</span><span style="color: #800000">'</span><span style="color: #000000">]
    start_urls </span>= [<span style="color: #800000">'</span><span style="color: #800000">http://www.shaimn.com/xinggan/</span><span style="color: #800000">'</span><span style="color: #000000">]

    </span><span style="color: #0000ff">def</span><span style="color: #000000"> parse(self, response):
        <span style="background-color: #ff99cc">hxs </span></span><span style="background-color: #ff99cc">= HtmlXPathSelector(response)</span>               <span style="color: #008000">#</span><span style="color: #008000">创建HtmlXPathSelector对象，将页面返回对象传进去</span>
<span style="background-color: #ff99cc"><span style="color: #000000">
        items </span>= hxs.select(<span style="color: #800000">'</span><span style="color: #800000">//div[@class="showlist"]/li</span><span style="color: #800000">'</span>)</span>  <span style="color: #008000">#</span><span style="color: #008000">标签选择器，表示获取所有class等于showlist的div，下面的li标签</span>
        <span style="color: #008000">#</span><span style="color: #008000"> print(items)                                     #返回标签对象</span>
        <span style="color: #0000ff">for</span> <span style="background-color: #ff99cc">i</span> <span style="color: #0000ff">in</span> range(len(items)):                        <span style="color: #008000">#</span><span style="color: #008000">根据li标签的长度循环次数</span>
            <span style="background-color: #ff99cc">title</span> = hxs.select(<span style="color: #800000">'</span><span style="color: #800000">//div[@class="showlist"]/li<span style="background-color: #ff99cc">[%d]</span>//img/@alt</span><span style="color: #800000">'</span> % <span style="background-color: #ff99cc">i</span>).extract()   <span style="color: #008000">#</span><span style="color: #008000">根据循环的次数作为下标获取到当前li标签，下的img标签的alt属性内容</span>
            <span style="background-color: #ff99cc">src</span> = hxs.select(<span style="color: #800000">'</span><span style="color: #800000">//div[@class="showlist"]/li<span style="background-color: #ff99cc">[%d]</span>//img/@src</span><span style="color: #800000">'</span> % <span style="background-color: #ff99cc">i</span>).extract()     <span style="color: #008000">#</span><span style="color: #008000">根据循环的次数作为下标获取到当前li标签，下的img标签的src属性内容</span>
            <span style="color: #0000ff">if</span> title <span style="color: #0000ff">and</span><span style="color: #000000"> src:
                </span><span style="color: #008000">#</span><span style="color: #008000"> print(title[0],src[0])                                                    #通过下标获取到字符串内容</span>
                file_path = os.path.join(os.getcwd() + <span style="color: #800000">'</span><span style="color: #800000">/img/</span><span style="color: #800000">'</span>, <span style="background-color: #ff99cc">title[0]</span> + <span style="color: #800000">'</span><span style="color: #800000">.jpg</span><span style="color: #800000">'</span>)          <span style="color: #008000">#</span><span style="color: #008000">拼接图片保存路径</span>
                request.<span style="background-color: #ff99cc">urlretrieve</span>(<span style="background-color: #ff99cc">src[0]</span>, file_path)                          <span style="color: #008000">#</span><span style="color: #008000">将图片保存到本地，参数1获取到的src，参数2保存路径</span></pre>
</div>
<p><img src="https://images2015.cnblogs.com/blog/955761/201707/955761-20170724221403403-1887726194.png" alt=""></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">xpath()</span>标签选择器，是Selector类里的一个方法，参数是选择规则【推荐】</strong></span></p>
<p><span style="color: #000000"><strong>选择器规则同上</strong></span></p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">selector()</span>创建选择器类，需要接受html对象</strong></span><br><strong>需要导入：<span style="color: #0000ff">from scrapy.selector import Selector</span></strong></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000"> -*- coding: utf-8 -*-</span>
<span style="color: #0000ff">import</span> scrapy       <span style="color: #008000">#</span><span style="color: #008000">导入爬虫模块</span>
<span style="color: #0000ff">from</span> scrapy.selector <span style="color: #0000ff">import</span> HtmlXPathSelector  <span style="color: #008000">#</span><span style="color: #008000">导入HtmlXPathSelector模块</span>
<span style="background-color: #ff99cc"><span style="color: #0000ff">from</span> scrapy.selector <span style="color: #0000ff">import</span><span style="color: #000000"> Selector


</span></span><span style="color: #0000ff">class</span><span style="color: #000000"> AdcSpider(scrapy.Spider):
    name </span>= <span style="color: #800000">'</span><span style="color: #800000">adc</span><span style="color: #800000">'</span>                                        <span style="color: #008000">#</span><span style="color: #008000">设置爬虫名称</span>
    allowed_domains = [<span style="color: #800000">'</span><span style="color: #800000">www.shaimn.com</span><span style="color: #800000">'</span><span style="color: #000000">]
    start_urls </span>= [<span style="color: #800000">'</span><span style="color: #800000">http://www.shaimn.com/xinggan/</span><span style="color: #800000">'</span><span style="color: #000000">]

    </span><span style="color: #0000ff">def</span><span style="color: #000000"> parse(self, response):
        <span style="background-color: #ff99cc">items </span></span><span style="background-color: #ff99cc">= Selector(response=response).xpath(<span style="color: #800000">'</span><span style="color: #800000">//div[@class="showlist"]/li</span><span style="color: #800000">'</span><span style="color: #000000">).extract()
        </span></span><span style="color: #008000">#</span><span style="color: #008000"> print(items)                                     #返回标签对象</span>
        <span style="color: #0000ff">for</span> i <span style="color: #0000ff">in</span><span style="color: #000000"> range(len(items)):
            <span style="background-color: #ff99cc">title </span></span><span style="background-color: #ff99cc">= Selector(response=response).xpath(<span style="color: #800000">'</span><span style="color: #800000">//div[@class="showlist"]/li[%d]//img/@alt</span><span style="color: #800000">'</span> %</span><span style="color: #000000"><span style="background-color: #ff99cc"> i).extract()</span>
            <span style="background-color: #ff99cc">src </span></span><span style="background-color: #ff99cc">= Selector(response=response).xpath(<span style="color: #800000">'</span><span style="color: #800000">//div[@class="showlist"]/li[%d]//img/@src</span><span style="color: #800000">'</span> %<span style="color: #000000"> i).extract()
            </span></span><span style="color: #0000ff">print</span>(title,src)</pre>
</div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>正则表达式的应用</strong></span></p>
<p><strong>正则表达式是弥补，选择器规则无法满足过滤情况时使用的，</strong></p>
<p><strong>分为两种正则使用方式</strong></p>
<p><strong>　　1、将选择器规则过滤出来的结果进行正则匹配</strong></p>
<p><strong>　　2、在选择器规则里应用正则进行过滤</strong></p>
<p><span style="color: #ff0000"><strong>1、将选择器规则过滤出来的结果进行正则匹配，用正则取最终内容</strong></span></p>
<p><span style="color: #0000ff"><strong>最后.re('正则')</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000"> -*- coding: utf-8 -*-</span>
<span style="color: #0000ff">import</span> scrapy       <span style="color: #008000">#</span><span style="color: #008000">导入爬虫模块</span>
<span style="color: #0000ff">from</span> scrapy.selector <span style="color: #0000ff">import</span> HtmlXPathSelector  <span style="color: #008000">#</span><span style="color: #008000">导入HtmlXPathSelector模块</span>
<span style="background-color: #ffff00"><span style="color: #0000ff">from</span> scrapy.selector <span style="color: #0000ff">import</span><span style="color: #000000"> Selector


</span></span><span style="color: #0000ff">class</span><span style="color: #000000"> AdcSpider(scrapy.Spider):
    name </span>= <span style="color: #800000">'</span><span style="color: #800000">adc</span><span style="color: #800000">'</span>                                        <span style="color: #008000">#</span><span style="color: #008000">设置爬虫名称</span>
    allowed_domains = [<span style="color: #800000">'</span><span style="color: #800000">www.shaimn.com</span><span style="color: #800000">'</span><span style="color: #000000">]
    start_urls </span>= [<span style="color: #800000">'</span><span style="color: #800000">http://www.shaimn.com/xinggan/</span><span style="color: #800000">'</span><span style="color: #000000">]

    </span><span style="color: #0000ff">def</span><span style="color: #000000"> parse(self, response):
        <span style="background-color: #ffff00">items </span></span><span style="background-color: #ffff00">= Selector(response=response).xpath(<span style="color: #800000">'</span><span style="color: #800000">//div[@class="showlist"]/li//img</span><span style="color: #800000">'</span><span style="color: #000000">)[0].extract()
        </span></span><span style="color: #0000ff">print</span>(items)                                     <span style="color: #008000">#</span><span style="color: #008000">返回标签对象</span>
        <span style="background-color: #ffff00">items2 = Selector(response=response).xpath(<span style="color: #800000">'</span><span style="color: #800000">//div[@class="showlist"]/li//img</span><span style="color: #800000">'</span>)[0].<span style="background-color: #ff99cc">re(<span style="color: #800000">'</span><span style="color: #800000"><span style="background-color: #33cccc">alt="</span>(\w+)</span><span style="color: #800000">'</span><span style="color: #000000">)
        </span></span></span><span style="color: #0000ff">print</span><span style="color: #000000">(items2)
        
</span><span style="color: #008000">#</span><span style="color: #008000"> &lt;img src="http://www.shaimn.com/uploads/170724/1-1FH4221056141.jpg" <span style="background-color: #33cccc">alt="</span><span style="background-color: #ff99cc">人体艺术mmSunny前凸后翘性感诱惑写真</span>"&gt;</span><span style="color: #008000">
#</span><span style="color: #008000"> ['人体艺术mmSunny前凸后翘性感诱惑写真']</span></pre>
</div>
<p><span style="color: #ff0000"><strong>2、在选择器规则里应用正则进行过滤</strong></span></p>
<p><span style="color: #0000ff"><strong>[re:正则规则]</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000"> -*- coding: utf-8 -*-</span>
<span style="color: #0000ff">import</span> scrapy       <span style="color: #008000">#</span><span style="color: #008000">导入爬虫模块</span>
<span style="color: #0000ff">from</span> scrapy.selector <span style="color: #0000ff">import</span> HtmlXPathSelector  <span style="color: #008000">#</span><span style="color: #008000">导入HtmlXPathSelector模块</span>
<span style="color: #0000ff">from</span> scrapy.selector <span style="color: #0000ff">import</span><span style="color: #000000"> Selector


</span><span style="color: #0000ff">class</span><span style="color: #000000"> AdcSpider(scrapy.Spider):
    name </span>= <span style="color: #800000">'</span><span style="color: #800000">adc</span><span style="color: #800000">'</span>                                        <span style="color: #008000">#</span><span style="color: #008000">设置爬虫名称</span>
    allowed_domains = [<span style="color: #800000">'</span><span style="color: #800000">www.shaimn.com</span><span style="color: #800000">'</span><span style="color: #000000">]
    start_urls </span>= [<span style="color: #800000">'</span><span style="color: #800000">http://www.shaimn.com/xinggan/</span><span style="color: #800000">'</span><span style="color: #000000">]

    </span><span style="color: #0000ff">def</span><span style="color: #000000"> parse(self, response):
        <span style="background-color: #ff99cc">items </span></span><span style="background-color: #ff99cc">= Selector(response=response).xpath(<span style="color: #800000">'</span><span style="color: #800000">//div</span><span style="color: #800000">'</span><span style="color: #000000">).extract()
        </span></span><span style="color: #008000">#</span><span style="color: #008000"> print(items)                                     #返回标签对象</span>
        items2 = Selector(response=response).xpath(<span style="color: #800000">'</span><span style="color: #800000">//div<span style="background-color: #ff99cc">[re:test(@class, "showlist")]</span></span><span style="color: #800000">'</span>).extract()  <span style="color: #008000">#</span><span style="color: #008000">正则找到div的class等于showlist的元素</span>
        <span style="color: #0000ff">print</span>(items2)</pre>
</div>
<p>&nbsp;</p></div>