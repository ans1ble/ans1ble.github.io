第三百五十一节，Python分布式爬虫打造搜索引擎Scrapy精讲—将selenium操作谷歌浏览器集成到scrapy中


			<div id="cnblogs_post_body" class="blogpost-body"><p><strong>第三百五十一节，Python分布式爬虫打造搜索引擎Scrapy精讲—将selenium操作谷歌浏览器集成到scrapy中</strong></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>1、爬虫文件</strong></span></p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">dispatcher.connect()</span>信号分发器，第一个参数信号触发函数，第二个参数是触发信号，</strong></span><br><span style="color: #ff0000"><strong><span style="color: #0000ff">signals.spider_closed</span>是爬虫结束信号</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000"> -*- coding: utf-8 -*-</span>
<span style="color: #0000ff">import</span><span style="color: #000000"> scrapy
</span><span style="color: #0000ff">from</span> scrapy.http <span style="color: #0000ff">import</span><span style="color: #000000"> Request,FormRequest
</span><span style="background-color: #ff99cc"><span style="color: #0000ff">from</span> selenium <span style="color: #0000ff">import</span> webdriver                  <span style="color: #008000">#</span><span style="color: #008000"> 导入selenium模块来操作浏览器软件</span>
<span style="color: #0000ff">from</span> scrapy.xlib.pydispatch <span style="color: #0000ff">import</span> dispatcher   <span style="color: #008000">#</span><span style="color: #008000"> 信号分发器</span>
<span style="color: #0000ff">from</span> scrapy <span style="color: #0000ff">import</span> signals  </span>                    <span style="color: #008000">#</span><span style="color: #008000"> 信号</span>

<span style="color: #0000ff">class</span> PachSpider(scrapy.Spider):                            <span style="color: #008000">#</span><span style="color: #008000">定义爬虫类，必须继承scrapy.Spider</span>
    name = <span style="color: #800000">'</span><span style="color: #800000">pach</span><span style="color: #800000">'</span>                                           <span style="color: #008000">#</span><span style="color: #008000">设置爬虫名称</span>
    allowed_domains = [<span style="color: #800000">'</span><span style="color: #800000">www.taobao.com</span><span style="color: #800000">'</span>]                    <span style="color: #008000">#</span><span style="color: #008000">爬取域名</span>

<span style="background-color: #ff99cc">    <span style="color: #0000ff">def</span> <span style="color: #800080">__init__</span>(self):                                                                                 <span style="color: #008000">#</span><span style="color: #008000">初始化</span>
        self.browser = webdriver.Chrome(executable_path=<span style="color: #800000">'</span><span style="color: #800000">H:/py/16/adc/adc/Firefox/chromedriver.exe</span><span style="color: #800000">'</span>)    <span style="color: #008000">#</span><span style="color: #008000">创建谷歌浏览器对象</span>
        super(PachSpider, self).<span style="color: #800080">__init__</span>()                                                              <span style="color: #008000">#</span><span style="color: #008000">设置可以获取上一级父类基类的，__init__方法里的对象封装值</span>
        dispatcher.connect(self.spider_closed, signals.spider_closed)       <span style="color: #008000">#</span><span style="color: #008000">dispatcher.connect()信号分发器，第一个参数信号触发函数，第二个参数是触发信号，signals.spider_closed是爬虫结束信号</span></span>

        <span style="color: #008000">#</span><span style="color: #008000">运行到此处时，就会去中间件执行，RequestsChrometmiddware中间件了</span>

<span style="background-color: #ff99cc">    <span style="color: #0000ff">def</span> spider_closed(self, spider):                                        <span style="color: #008000">#</span><span style="color: #008000">信号触发函数</span>
        <span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">爬虫结束 停止爬虫</span><span style="color: #800000">'</span><span style="color: #000000">)
        self.browser.quit()                                                 </span><span style="color: #008000">#</span><span style="color: #008000">关闭浏览器</span></span>

    <span style="color: #0000ff">def</span> start_requests(self):    <span style="color: #008000">#</span><span style="color: #008000">起始url函数，会替换start_urls</span>
        <span style="color: #0000ff">return</span><span style="color: #000000"> [Request(
            url</span>=<span style="color: #800000">'</span><span style="color: #800000">https://www.taobao.com/</span><span style="color: #800000">'</span><span style="color: #000000">,
            callback</span>=<span style="color: #000000">self.parse
        )]


    </span><span style="color: #0000ff">def</span><span style="color: #000000"> parse(self, response):
        title </span>= response.css(<span style="color: #800000">'</span><span style="color: #800000">title::text</span><span style="color: #800000">'</span><span style="color: #000000">).extract()
        </span><span style="color: #0000ff">print</span>(title)</pre>
</div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>2、middlewares.py中间件文件</strong></span></p>
<div class="cnblogs_code">
<pre><span style="background-color: #ff99cc"><span style="color: #0000ff">from</span> scrapy.http <span style="color: #0000ff">import</span><span style="color: #000000"> HtmlResponse


</span><span style="color: #0000ff">class</span> RequestsChrometmiddware(object):              <span style="color: #008000">#</span><span style="color: #008000"> 浏览器访问中间件</span>

    <span style="color: #0000ff">def</span> process_request(self, request, spider):     <span style="color: #008000">#</span><span style="color: #008000"> 重写process_request请求方法</span>
        <span style="color: #0000ff">if</span> spider.name == <span style="color: #800000">'</span><span style="color: #800000">pach</span><span style="color: #800000">'</span>:                   <span style="color: #008000">#</span><span style="color: #008000"> 判断爬虫名称为pach时执行</span>
            spider.browser.get(request.url)         <span style="color: #008000">#</span><span style="color: #008000">用谷歌浏览器访问url</span>
            <span style="color: #0000ff">import</span><span style="color: #000000"> time
            time.sleep(</span>3<span style="color: #000000">)
            </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">访问：{0}</span><span style="color: #800000">'</span>.format(request.url))  <span style="color: #008000">#</span><span style="color: #008000"> 打印访问网址</span>
            <span style="color: #008000">#</span><span style="color: #008000">设置响应信息，由浏览器响应信息返回</span>
            <span style="color: #0000ff">return</span> HtmlResponse(url=spider.browser.current_url, body=spider.browser.page_source, encoding=<span style="color: #800000">'</span><span style="color: #800000">utf-8</span><span style="color: #800000">'</span>, request=request)</span></pre>
</div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>3、settings.py配置文件注册中间件</strong></span></p>
<div class="cnblogs_code">
<pre>DOWNLOADER_MIDDLEWARES = {              <span style="color: #008000">#</span><span style="color: #008000">开启注册中间件</span>
   <span style="color: #800000">'</span><span style="color: #800000">adc.middlewares.RequestsUserAgentmiddware</span><span style="color: #800000">'</span>: 543<span style="color: #000000">,
   </span><span style="background-color: #ff99cc"><span style="color: #800000">'</span><span style="color: #800000">adc.middlewares.RequestsChrometmiddware</span><span style="color: #800000">'</span>: 542<span style="color: #000000">,
   </span></span><span style="color: #800000">'</span><span style="color: #800000">scrapy.downloadermiddlewares.useragent.UserAgentMiddleware</span><span style="color: #800000">'</span>: None, <span style="color: #008000">#</span><span style="color: #008000">将默认的UserAgentMiddleware设置为None</span>
}</pre>
</div>
<p>&nbsp;</p></div>