第三百九十七节，Django+Xadmin打造上线标准的在线教育平台—其他插件使用说，主题本地化设置


			<div id="cnblogs_post_body" class="blogpost-body"><p><strong>第三百九十七节，Django+Xadmin打造上线标准的在线教育平台—其他插件使用说，主题本地化设置</strong></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>主题设置是在xadmin\plugins\themes.py这个文件</strong></span></p>
<p><span style="color: #000000"><strong>默认xadmin是通过下面这个json文件来动态加载的。所以我们可以到它加载的<strong>json文件里下载好主题</strong></strong></span></p>
<p><span style="color: #ff0000"><strong><strong><strong>themes.py</strong>修改方式</strong></strong></span></p>
<p>&nbsp;</p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">coding:utf-8</span>
<span style="color: #0000ff">from</span> <span style="color: #800080">__future__</span> <span style="color: #0000ff">import</span><span style="color: #000000"> print_function
</span><span style="color: #0000ff">import</span><span style="color: #000000"> httplib2
</span><span style="color: #0000ff">from</span> django.template <span style="color: #0000ff">import</span><span style="color: #000000"> loader
</span><span style="color: #0000ff">from</span> django.core.cache <span style="color: #0000ff">import</span><span style="color: #000000"> cache
</span><span style="color: #0000ff">from</span> django.utils <span style="color: #0000ff">import</span><span style="color: #000000"> six
</span><span style="color: #0000ff">from</span> django.utils.translation <span style="color: #0000ff">import</span><span style="color: #000000"> ugettext as _
</span><span style="color: #0000ff">from</span> xadmin.sites <span style="color: #0000ff">import</span><span style="color: #000000"> site
</span><span style="color: #0000ff">from</span> xadmin.models <span style="color: #0000ff">import</span><span style="color: #000000"> UserSettings
</span><span style="color: #0000ff">from</span> xadmin.views <span style="color: #0000ff">import</span><span style="color: #000000"> BaseAdminPlugin, BaseAdminView
</span><span style="color: #0000ff">from</span> xadmin.util <span style="color: #0000ff">import</span><span style="color: #000000"> static, json
</span><span style="color: #0000ff">import</span><span style="color: #000000"> six
</span><span style="color: #0000ff">if</span><span style="color: #000000"> six.PY2:
    </span><span style="color: #0000ff">import</span><span style="color: #000000"> urllib
</span><span style="color: #0000ff">else</span><span style="color: #000000">:
    </span><span style="color: #0000ff">import</span><span style="color: #000000"> urllib.parse

THEME_CACHE_KEY </span>= <span style="color: #800000">'</span><span style="color: #800000">xadmin_themes</span><span style="color: #800000">'</span>


<span style="color: #0000ff">class</span><span style="color: #000000"> ThemePlugin(BaseAdminPlugin):

    enable_themes </span>=<span style="color: #000000"> False
    </span><span style="color: #008000">#</span><span style="color: #008000"> {'name': 'Blank Theme', 'description': '...', 'css': 'http://...', 'thumbnail': '...'}</span>
    user_themes =<span style="color: #000000"> None
    use_bootswatch </span>=<span style="color: #000000"> False
    default_theme </span>= static(<span style="color: #800000">'</span><span style="color: #800000">xadmin/css/themes/bootstrap-xadmin.css</span><span style="color: #800000">'</span><span style="color: #000000">)
    bootstrap2_theme </span>= static(<span style="color: #800000">'</span><span style="color: #800000">xadmin/css/themes/bootstrap-theme.css</span><span style="color: #800000">'</span><span style="color: #000000">)

    </span><span style="background-color: #ccffff"><span style="color: #008000">#</span><span style="color: #008000"> 将主题本地化，下载好主题设置下载好的主题样式文件</span>
    Solar_theme = static(<span style="color: #800000">"</span><span style="color: #800000">xadmin/css/themes/Solar_theme.css</span><span style="color: #800000">"</span><span style="color: #000000">)
    Cerulean_theme </span>= static(<span style="color: #800000">"</span><span style="color: #800000">xadmin/css/themes/Cerulean_theme.css</span><span style="color: #800000">"</span><span style="color: #000000">)
    Cosmo_theme </span>= static(<span style="color: #800000">"</span><span style="color: #800000">xadmin/css/themes/Cosmo_theme.css</span><span style="color: #800000">"</span><span style="color: #000000">)
    Cyborg_theme </span>= static(<span style="color: #800000">"</span><span style="color: #800000">xadmin/css/themes/Cyborg_theme.css</span><span style="color: #800000">"</span><span style="color: #000000">)
    Darkly_theme </span>= static(<span style="color: #800000">"</span><span style="color: #800000">xadmin/css/themes/Darkly_theme.css</span><span style="color: #800000">"</span><span style="color: #000000">)
    Flatly_theme </span>= static(<span style="color: #800000">"</span><span style="color: #800000">xadmin/css/themes/Flatly_theme.css</span><span style="color: #800000">"</span><span style="color: #000000">)
    Journal_theme </span>= static(<span style="color: #800000">"</span><span style="color: #800000">xadmin/css/themes/Journal_theme.css</span><span style="color: #800000">"</span><span style="color: #000000">)
    Lumen_theme </span>= static(<span style="color: #800000">"</span><span style="color: #800000">xadmin/css/themes/Lumen_theme.css</span><span style="color: #800000">"</span><span style="color: #000000">)
    Paper_theme </span>= static(<span style="color: #800000">"</span><span style="color: #800000">xadmin/css/themes/Paper_theme.css</span><span style="color: #800000">"</span><span style="color: #000000">)
    Readable_theme </span>= static(<span style="color: #800000">"</span><span style="color: #800000">xadmin/css/themes/Readable_theme.css</span><span style="color: #800000">"</span><span style="color: #000000">)
    Sandstone_theme </span>= static(<span style="color: #800000">"</span><span style="color: #800000">xadmin/css/themes/Sandstone_theme.css</span><span style="color: #800000">"</span><span style="color: #000000">)
    Simplex_theme </span>= static(<span style="color: #800000">"</span><span style="color: #800000">xadmin/css/themes/Simplex_theme.css</span><span style="color: #800000">"</span><span style="color: #000000">)
    Slate_theme </span>= static(<span style="color: #800000">"</span><span style="color: #800000">xadmin/css/themes/Slate_theme.css</span><span style="color: #800000">"</span><span style="color: #000000">)
    Spacelab_theme </span>= static(<span style="color: #800000">"</span><span style="color: #800000">xadmin/css/themes/Spacelab_theme.css</span><span style="color: #800000">"</span><span style="color: #000000">)
    Superhero_theme </span>= static(<span style="color: #800000">"</span><span style="color: #800000">xadmin/css/themes/Superhero_theme.css</span><span style="color: #800000">"</span><span style="color: #000000">)
    United_theme </span>= static(<span style="color: #800000">"</span><span style="color: #800000">xadmin/css/themes/United_theme.css</span><span style="color: #800000">"</span><span style="color: #000000">)


    </span></span><span style="color: #0000ff">def</span> init_request(self, *args, **<span style="color: #000000">kwargs):
        </span><span style="color: #0000ff">return</span><span style="color: #000000"> self.enable_themes

    </span><span style="color: #0000ff">def</span><span style="color: #000000"> _get_theme(self):
        </span><span style="color: #0000ff">if</span><span style="color: #000000"> self.user:
            </span><span style="color: #0000ff">try</span><span style="color: #000000">:
                </span><span style="color: #0000ff">return</span> UserSettings.objects.get(user=self.user, key=<span style="color: #800000">"</span><span style="color: #800000">site-theme</span><span style="color: #800000">"</span><span style="color: #000000">).value
            </span><span style="color: #0000ff">except</span><span style="color: #000000"> Exception:
                </span><span style="color: #0000ff">pass</span>
        <span style="color: #0000ff">if</span> <span style="color: #800000">'</span><span style="color: #800000">_theme</span><span style="color: #800000">'</span> <span style="color: #0000ff">in</span><span style="color: #000000"> self.request.COOKIES:
            </span><span style="color: #0000ff">if</span><span style="color: #000000"> six.PY2:
                func </span>=<span style="color: #000000"> urllib.unquote
            </span><span style="color: #0000ff">else</span><span style="color: #000000">:
                func </span>=<span style="color: #000000"> urllib.parse.unquote
            </span><span style="color: #0000ff">return</span> func(self.request.COOKIES[<span style="color: #800000">'</span><span style="color: #800000">_theme</span><span style="color: #800000">'</span><span style="color: #000000">])
        </span><span style="color: #0000ff">return</span><span style="color: #000000"> self.default_theme

    </span><span style="color: #0000ff">def</span><span style="color: #000000"> get_context(self, context):
        context[</span><span style="color: #800000">'</span><span style="color: #800000">site_theme</span><span style="color: #800000">'</span>] =<span style="color: #000000"> self._get_theme()
        </span><span style="color: #0000ff">return</span><span style="color: #000000"> context

    </span><span style="color: #008000">#</span><span style="color: #008000"> Media</span>
    <span style="color: #0000ff">def</span><span style="color: #000000"> get_media(self, media):
        </span><span style="color: #0000ff">return</span> media + self.vendor(<span style="color: #800000">'</span><span style="color: #800000">jquery-ui-effect.js</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">xadmin.plugin.themes.js</span><span style="color: #800000">'</span><span style="color: #000000">)

    </span><span style="color: #008000">#</span><span style="color: #008000"> Block Views</span>
    <span style="color: #0000ff">def</span><span style="color: #000000"> block_top_navmenu(self, context, nodes):

        themes </span>=<span style="color: #000000"> [
            {</span><span style="color: #800000">'</span><span style="color: #800000">name</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">Default</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">description</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">Default bootstrap theme</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">css</span><span style="color: #800000">'</span><span style="color: #000000">: self.default_theme},
            </span><span style="color: #008000">#</span><span style="color: #008000"> {'name': _(u"Bootstrap2"), 'description': _(u"Bootstrap 2.x theme"), 'css': self.bootstrap2_theme},</span>

            <span style="color: #008000">#</span><span style="color: #008000"> 设置主题静态加载样式</span>
<span style="background-color: #ccffff">            {<span style="color: #800000">'</span><span style="color: #800000">name</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">深绿</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">description</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">深绿</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">css</span><span style="color: #800000">'</span><span style="color: #000000">: self.Solar_theme},
            {</span><span style="color: #800000">'</span><span style="color: #800000">name</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">天蓝</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">description</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">天蓝</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">css</span><span style="color: #800000">'</span><span style="color: #000000">: self.Cerulean_theme},
            {</span><span style="color: #800000">'</span><span style="color: #800000">name</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">蓝黑</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">description</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">蓝黑</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">css</span><span style="color: #800000">'</span><span style="color: #000000">: self.Cosmo_theme},
            {</span><span style="color: #800000">'</span><span style="color: #800000">name</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">黑色</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">description</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">黑色</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">css</span><span style="color: #800000">'</span><span style="color: #000000">: self.Cyborg_theme},
            {</span><span style="color: #800000">'</span><span style="color: #800000">name</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">绿黑</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">description</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">绿黑</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">css</span><span style="color: #800000">'</span><span style="color: #000000">: self.Darkly_theme},
            {</span><span style="color: #800000">'</span><span style="color: #800000">name</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">绿蓝</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">description</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">绿蓝</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">css</span><span style="color: #800000">'</span><span style="color: #000000">: self.Flatly_theme},
            {</span><span style="color: #800000">'</span><span style="color: #800000">name</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">粉红</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">description</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">粉红</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">css</span><span style="color: #800000">'</span><span style="color: #000000">: self.Journal_theme},
            {</span><span style="color: #800000">'</span><span style="color: #800000">name</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">白色</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">description</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">白色</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">css</span><span style="color: #800000">'</span><span style="color: #000000">: self.Lumen_theme},
            {</span><span style="color: #800000">'</span><span style="color: #800000">name</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">深蓝</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">description</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">深蓝</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">css</span><span style="color: #800000">'</span><span style="color: #000000">: self.Paper_theme},
            {</span><span style="color: #800000">'</span><span style="color: #800000">name</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">白蓝</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">description</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">白蓝</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">css</span><span style="color: #800000">'</span><span style="color: #000000">: self.Readable_theme},
            {</span><span style="color: #800000">'</span><span style="color: #800000">name</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">草绿</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">description</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">草绿</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">css</span><span style="color: #800000">'</span><span style="color: #000000">: self.Sandstone_theme},
            {</span><span style="color: #800000">'</span><span style="color: #800000">name</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">红色</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">description</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">红色</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">css</span><span style="color: #800000">'</span><span style="color: #000000">: self.Simplex_theme},
            {</span><span style="color: #800000">'</span><span style="color: #800000">name</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">灰黑</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">description</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">灰黑</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">css</span><span style="color: #800000">'</span><span style="color: #000000">: self.Slate_theme},
            {</span><span style="color: #800000">'</span><span style="color: #800000">name</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">灰蓝</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">description</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">灰蓝</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">css</span><span style="color: #800000">'</span><span style="color: #000000">: self.Spacelab_theme},
            {</span><span style="color: #800000">'</span><span style="color: #800000">name</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">深灰</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">description</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">深灰</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">css</span><span style="color: #800000">'</span><span style="color: #000000">: self.Superhero_theme},
            {</span><span style="color: #800000">'</span><span style="color: #800000">name</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">橙色</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">description</span><span style="color: #800000">'</span>: _(u<span style="color: #800000">"</span><span style="color: #800000">橙色</span><span style="color: #800000">"</span>), <span style="color: #800000">'</span><span style="color: #800000">css</span><span style="color: #800000">'</span></span><span style="color: #000000"><span style="background-color: #ccffff">: self.United_theme},</span>
            ]

        select_css </span>= context.get(<span style="color: #800000">'</span><span style="color: #800000">site_theme</span><span style="color: #800000">'</span><span style="color: #000000">, self.default_theme)

        </span><span style="color: #0000ff">if</span><span style="color: #000000"> self.user_themes:
            themes.extend(self.user_themes)

        </span><span style="color: #0000ff">if</span><span style="color: #000000"> self.use_bootswatch:
            ex_themes </span>=<span style="color: #000000"> cache.get(THEME_CACHE_KEY)
            </span><span style="color: #0000ff">if</span><span style="color: #000000"> ex_themes:
                themes.extend(json.loads(ex_themes))
            </span><span style="color: #0000ff">else</span><span style="color: #000000">:
                ex_themes </span>=<span style="color: #000000"> []
                </span><span style="color: #0000ff">try</span><span style="color: #000000">:
                    </span><span style="color: #0000ff">pass</span>

<span style="background-color: #ccffff">                    <span style="color: #008000">#</span><span style="color: #008000"> 默认xadmin是通过下面这个json文件来动态加载的,将它注释掉将不会动态加载主题</span>

                    <span style="color: #008000">#</span><span style="color: #008000"> h = httplib2.Http()</span>
                    <span style="color: #008000">#</span><span style="color: #008000"> resp, content = h.request("https://bootswatch.com/api/3.json", 'GET', '',</span>
                    <span style="color: #008000">#</span><span style="color: #008000">     headers={"Accept": "application/json", "User-Agent": self.request.META['HTTP_USER_AGENT']})</span>
                    <span style="color: #008000">#</span><span style="color: #008000"> if six.PY3:</span>
                    <span style="color: #008000">#</span><span style="color: #008000">     content = content.decode()</span>
                    <span style="color: #008000">#</span><span style="color: #008000"> watch_themes = json.loads(content)['themes']</span>
                    <span style="color: #008000">#</span><span style="color: #008000"> ex_themes.extend([</span>
                    <span style="color: #008000">#</span><span style="color: #008000">     {'name': t['name'], 'description': t['description'],</span>
                    <span style="color: #008000">#</span><span style="color: #008000">         'css': t['cssMin'], 'thumbnail': t['thumbnail']}</span>
                    <span style="color: #008000">#</span><span style="color: #008000">     for t in watch_themes])</span></span>
                <span style="color: #0000ff">except</span><span style="color: #000000"> Exception as e:
                    </span><span style="color: #0000ff">print</span><span style="color: #000000">(e)

                cache.set(THEME_CACHE_KEY, json.dumps(ex_themes), </span>24 * 3600<span style="color: #000000">)
                themes.extend(ex_themes)

        nodes.append(loader.render_to_string(</span><span style="color: #800000">'</span><span style="color: #800000">xadmin/blocks/comm.top.theme.html</span><span style="color: #800000">'</span>, {<span style="color: #800000">'</span><span style="color: #800000">themes</span><span style="color: #800000">'</span>: themes, <span style="color: #800000">'</span><span style="color: #800000">select_css</span><span style="color: #800000">'</span><span style="color: #000000">: select_css}))


site.register_plugin(ThemePlugin, BaseAdminView)</span></pre>
</div>
<p>&nbsp;</p></div>