第四百零三节，python网站在线支付，支付宝接口集成与远程调试，


			<div id="cnblogs_post_body" class="blogpost-body"><p><strong>第四百零三节，python网站在线支付，支付宝接口集成与远程调试，</strong></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>windows系统安装Python虚拟环境</strong></span></p>
<p><strong>首先保证你的系统已经安装好了<strong>Python</strong></strong></p>
<p><span style="color: #ff0000"><strong><strong><strong>安装virtualenv</strong></strong></strong></span></p>
<div class="cnblogs_code">
<pre>C:\WINDOWS\system32&gt;<span style="color: #000000"><span style="background-color: #ffff00">pip3 install virtualenv</span>
Collecting virtualenv
  Downloading virtualenv</span>-15.1.0-py2.py3-none-any.whl (1<span style="color: #000000">.8MB)
    </span>100% |████████████████████████████████| 1.8MB 110kB/<span style="color: #000000">s
Installing collected packages: virtualenv
Successfully installed virtualenv</span>-15.1<span style="color: #000000">.0

C:\WINDOWS\system32</span>&gt;</pre>
</div>
<p><span style="color: #ff0000"><strong>安装virtualenvwrapper</strong></span></p>
<p><strong><strong>virtualenvwrapper是<strong>virtualenv的一个方便管理虚拟环境的管理器</strong></strong></strong></p>
<div class="cnblogs_code">
<pre>pip3 install virtualenvwrapper</pre>
</div>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>指定虚拟环境，保存路径</strong></span></p>
<p><strong>首先在要保存虚拟环境的地方创建一个Evns目录，然后将这个目录添加到系统环境变量，以后创建的虚拟环境就会保存在这个目录，重启系统后生效</strong></p>
<p><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171012151210902-761937680.png" alt=""></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>创建虚拟环境，创建后会自动进入虚拟环境</strong></span></p>
<p><strong>mkvirtualenv 虚拟环境名称</strong></p>
<div class="cnblogs_code">
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a title="复制代码"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
<pre>[root@192 xu_ni_huan_jing]# mkvirtualenv jxiou
Using base prefix '/usr/local'
New python executable in /usr/xu_ni_huan_jing/jxiou/bin/python3.5
Also creating executable in /usr/xu_ni_huan_jing/jxiou/bin/python
Installing setuptools, pip, wheel...done.
virtualenvwrapper.user_scripts creating /usr/xu_ni_huan_jing/jxiou/bin/predeactivate
virtualenvwrapper.user_scripts creating /usr/xu_ni_huan_jing/jxiou/bin/postdeactivate
virtualenvwrapper.user_scripts creating /usr/xu_ni_huan_jing/jxiou/bin/preactivate
virtualenvwrapper.user_scripts creating /usr/xu_ni_huan_jing/jxiou/bin/postactivate
virtualenvwrapper.user_scripts creating /usr/xu_ni_huan_jing/jxiou/bin/get_env_details
(jxiou) [root@192 xu_ni_huan_jing]# </pre>
<div class="cnblogs_code_toolbar"><span class="cnblogs_code_copy"><a title="复制代码"><img src="https://common.cnblogs.com/images/copycode.gif" alt="复制代码"></a></span></div>
</div>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>5.退出虚拟环境</strong></span></p>
<p><strong>deactivate</strong></p>
<div class="cnblogs_code">
<pre>(jxiou) [root@192 xu_ni_huan_jing]# deactivate
[root@192 xu_ni_huan_jing]# </pre>
</div>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>6.查看有哪些虚拟环境</strong></span></p>
<p><strong>workon</strong></p>
<div class="cnblogs_code">
<pre>[root@192 /]# workon
jxiou2
jxiou
[root@192 /]# </pre>
</div>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>7.进入一个指定的虚拟环境</strong></span></p>
<p><strong>workon jxiou(虚拟环境名称)</strong></p>
<div class="cnblogs_code">
<pre>[root@192 /]# workon jxiou
(jxiou) [root@192 /]#</pre>
</div>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>8.虚拟环境创建好后，创建Django项目，创建好数据库，开始本地调试支付请求</strong></span></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000; font-size: 18px; background-color: #ffff00"><strong>支付宝接口集成</strong>&nbsp;,本地环境调试支付请求</span></p>
<p><span style="color: #ff0000"><strong>1。首先登录 蚂蚁金服网站，也就是支付宝开发者平台</strong></span></p>
<p><strong>登录<strong>蚂蚁金服开发者平台后，创建沙箱应用</strong></strong></p>
<p><strong><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171011185228449-34949789.png" alt=""></strong></p>
<p>&nbsp;</p>
<p><strong>也就是支付宝给开发者提供的调试环境应用</strong></p>
<p><strong><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171011185425902-949100952.png" alt=""></strong></p>
<p>&nbsp;</p>
<p><strong>注意这里我们一定选择RSA2(SHA256)密钥(推荐)，这个是比较安全的方式，</strong></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>2.我们设置应用公钥</strong></span></p>
<p><span style="color: #000000"><strong>设置<strong>公钥，访问<span style="color: #0000ff">https://docs.open.alipay.com/291/105971/ </span>这个网址</strong></strong></span></p>
<p><span style="color: #000000"><strong>下载生成<strong>公钥的工具</strong></strong></span></p>
<p><span style="color: #ff0000"><strong><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171011185942840-952838317.png" alt=""></strong></span></p>
<p>&nbsp;</p>
<p><strong>下载解压后</strong></p>
<p><strong><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171011190033871-746147685.png" alt=""></strong></p>
<p><strong>生成<strong>公钥</strong></strong></p>
<p><strong><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171011190139543-453685450.png" alt=""></strong></p>
<p><strong>生成<strong>公钥后会得到两个文件</strong></strong></p>
<p><strong><strong><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171011190254184-978256601.png" alt=""></strong></strong></p>
<p><span style="color: #ff0000"><strong><strong>注意：这两个文件很重要一定要保存好</strong></strong></span></p>
<p>&nbsp;</p>
<p><strong><strong>生成<strong>公钥后，将<strong>公钥填写到信息配置里</strong></strong></strong></strong></p>
<p><strong><strong><strong><strong><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171011190808684-756340009.png" alt=""></strong></strong></strong></strong></p>
<p>&nbsp;</p>
<p><strong><strong><strong><strong><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171011190907730-1097240677.png" alt=""></strong></strong></strong></strong></p>
<p><strong><strong><strong><strong><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171011191008965-232221245.png" alt=""></strong></strong></strong></strong></p>
<p>&nbsp;</p>
<p><strong>当我们填写好公钥保存后，会自动给我们生成支付宝公钥</strong></p>
<p><strong><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171011191303402-271039325.png" alt=""></strong></p>
<p>&nbsp;</p>
<p><strong>将<strong>生成的支付宝公钥，复制下载写在一个TXT文件里</strong></strong></p>
<p><strong><strong>这样我们就有了3个秘钥</strong></strong></p>
<p><strong><strong><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171011192011855-891653960.png" alt=""></strong></strong></p>
<p><strong>&nbsp;将3个秘钥修改成英文或者拼音名称后，放到网站项目中</strong></p>
<p><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171011193028574-529171240.png" alt=""></p>
<p>&nbsp;</p>
<p><strong>在秘钥txt文件里，秘钥内容的头部和结尾加上两行字符串，注意所有秘钥都要加</strong></p>
<p>&nbsp;</p>
<div class="cnblogs_code">
<pre>-----BEGIN PRIVATE KEY-----<span style="color: #000000">
秘钥内容....
</span>-----END PRIVATE KEY-----</pre>
</div>
<p><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171011195551762-310258848.png" alt=""></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>3.支付宝，支付集成代码</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf8 -*-</span>

<span style="color: #008000">#</span><span style="color: #008000"> pip install pycryptodome   需要模块加密方面的模块</span>
<span style="color: #800080">__author__</span> = <span style="color: #800000">'</span><span style="color: #800000">bobby</span><span style="color: #800000">'</span>

<span style="color: #0000ff">from</span> datetime <span style="color: #0000ff">import</span><span style="color: #000000"> datetime
</span><span style="color: #0000ff">from</span> Crypto.PublicKey <span style="color: #0000ff">import</span><span style="color: #000000"> RSA
</span><span style="color: #0000ff">from</span> Crypto.Signature <span style="color: #0000ff">import</span><span style="color: #000000"> PKCS1_v1_5
</span><span style="color: #0000ff">from</span> Crypto.Hash <span style="color: #0000ff">import</span><span style="color: #000000"> SHA256
</span><span style="color: #0000ff">from</span> base64 <span style="color: #0000ff">import</span><span style="color: #000000"> b64encode, b64decode
</span><span style="color: #0000ff">from</span> urllib.parse <span style="color: #0000ff">import</span><span style="color: #000000"> quote_plus
</span><span style="color: #0000ff">from</span> urllib.parse <span style="color: #0000ff">import</span><span style="color: #000000"> urlparse, parse_qs
</span><span style="color: #0000ff">from</span> urllib.request <span style="color: #0000ff">import</span><span style="color: #000000"> urlopen
</span><span style="color: #0000ff">from</span> base64 <span style="color: #0000ff">import</span><span style="color: #000000"> decodebytes, encodebytes

</span><span style="color: #0000ff">import</span><span style="color: #000000"> json


</span><span style="color: #0000ff">class</span><span style="color: #000000"> AliPay(object):
    </span><span style="color: #800000">"""</span><span style="color: #800000">
    支付宝支付接口
    </span><span style="color: #800000">"""</span>
    <span style="color: #0000ff">def</span> <span style="color: #800080">__init__</span><span style="color: #000000">(self, appid, app_notify_url, app_private_key_path,
                 alipay_public_key_path, return_url, debug</span>=<span style="color: #000000">False):
        self.appid </span>=<span style="color: #000000"> appid
        self.app_notify_url </span>=<span style="color: #000000"> app_notify_url
        self.app_private_key_path </span>=<span style="color: #000000"> app_private_key_path
        self.app_private_key </span>=<span style="color: #000000"> None
        self.return_url </span>=<span style="color: #000000"> return_url
        with open(self.app_private_key_path) as fp:
            self.app_private_key </span>=<span style="color: #000000"> RSA.importKey(fp.read())

        self.alipay_public_key_path </span>=<span style="color: #000000"> alipay_public_key_path
        with open(self.alipay_public_key_path) as fp:
            self.alipay_public_key </span>=<span style="color: #000000"> RSA.import_key(fp.read())


        </span><span style="color: #0000ff">if</span> debug <span style="color: #0000ff">is</span><span style="color: #000000"> True:
            self.</span><span style="color: #800080">__gateway</span> = <span style="color: #800000">"</span><span style="color: #800000">https://openapi.alipaydev.com/gateway.do</span><span style="color: #800000">"</span>
        <span style="color: #0000ff">else</span><span style="color: #000000">:
            self.</span><span style="color: #800080">__gateway</span> = <span style="color: #800000">"</span><span style="color: #800000">https://openapi.alipay.com/gateway.do</span><span style="color: #800000">"</span>

    <span style="color: #0000ff">def</span> direct_pay(self, subject, out_trade_no, total_amount, return_url=None, **<span style="color: #000000">kwargs):
        biz_content </span>=<span style="color: #000000"> {
            </span><span style="color: #800000">"</span><span style="color: #800000">subject</span><span style="color: #800000">"</span><span style="color: #000000">: subject,
            </span><span style="color: #800000">"</span><span style="color: #800000">out_trade_no</span><span style="color: #800000">"</span><span style="color: #000000">: out_trade_no,
            </span><span style="color: #800000">"</span><span style="color: #800000">total_amount</span><span style="color: #800000">"</span><span style="color: #000000">: total_amount,
            </span><span style="color: #800000">"</span><span style="color: #800000">product_code</span><span style="color: #800000">"</span>: <span style="color: #800000">"</span><span style="color: #800000">FAST_INSTANT_TRADE_PAY</span><span style="color: #800000">"</span><span style="color: #000000">,
            </span><span style="color: #008000">#</span><span style="color: #008000"> "qr_pay_mode":4</span>
<span style="color: #000000">        }

        biz_content.update(kwargs)
        data </span>= self.build_body(<span style="color: #800000">"</span><span style="color: #800000">alipay.trade.page.pay</span><span style="color: #800000">"</span><span style="color: #000000">, biz_content, self.return_url)
        </span><span style="color: #0000ff">return</span><span style="color: #000000"> self.sign_data(data)

    </span><span style="color: #0000ff">def</span> build_body(self, method, biz_content, return_url=<span style="color: #000000">None):
        data </span>=<span style="color: #000000"> {
            </span><span style="color: #800000">"</span><span style="color: #800000">app_id</span><span style="color: #800000">"</span><span style="color: #000000">: self.appid,
            </span><span style="color: #800000">"</span><span style="color: #800000">method</span><span style="color: #800000">"</span><span style="color: #000000">: method,
            </span><span style="color: #800000">"</span><span style="color: #800000">charset</span><span style="color: #800000">"</span>: <span style="color: #800000">"</span><span style="color: #800000">utf-8</span><span style="color: #800000">"</span><span style="color: #000000">,
            </span><span style="color: #800000">"</span><span style="color: #800000">sign_type</span><span style="color: #800000">"</span>: <span style="color: #800000">"</span><span style="color: #800000">RSA2</span><span style="color: #800000">"</span><span style="color: #000000">,
            </span><span style="color: #800000">"</span><span style="color: #800000">timestamp</span><span style="color: #800000">"</span>: datetime.now().strftime(<span style="color: #800000">"</span><span style="color: #800000">%Y-%m-%d %H:%M:%S</span><span style="color: #800000">"</span><span style="color: #000000">),
            </span><span style="color: #800000">"</span><span style="color: #800000">version</span><span style="color: #800000">"</span>: <span style="color: #800000">"</span><span style="color: #800000">1.0</span><span style="color: #800000">"</span><span style="color: #000000">,
            </span><span style="color: #800000">"</span><span style="color: #800000">biz_content</span><span style="color: #800000">"</span><span style="color: #000000">: biz_content
        }

        </span><span style="color: #0000ff">if</span> return_url <span style="color: #0000ff">is</span> <span style="color: #0000ff">not</span><span style="color: #000000"> None:
            data[</span><span style="color: #800000">"</span><span style="color: #800000">notify_url</span><span style="color: #800000">"</span>] =<span style="color: #000000"> self.app_notify_url
            data[</span><span style="color: #800000">"</span><span style="color: #800000">return_url</span><span style="color: #800000">"</span>] =<span style="color: #000000"> self.return_url

        </span><span style="color: #0000ff">return</span><span style="color: #000000"> data

    </span><span style="color: #0000ff">def</span><span style="color: #000000"> sign_data(self, data):
        data.pop(</span><span style="color: #800000">"</span><span style="color: #800000">sign</span><span style="color: #800000">"</span><span style="color: #000000">, None)
        </span><span style="color: #008000">#</span><span style="color: #008000"> 排序后的字符串</span>
        unsigned_items =<span style="color: #000000"> self.ordered_data(data)
        unsigned_string </span>= <span style="color: #800000">"</span><span style="color: #800000">&amp;</span><span style="color: #800000">"</span>.join(<span style="color: #800000">"</span><span style="color: #800000">{0}={1}</span><span style="color: #800000">"</span>.format(k, v) <span style="color: #0000ff">for</span> k, v <span style="color: #0000ff">in</span><span style="color: #000000"> unsigned_items)
        sign </span>= self.sign(unsigned_string.encode(<span style="color: #800000">"</span><span style="color: #800000">utf-8</span><span style="color: #800000">"</span><span style="color: #000000">))
        ordered_items </span>=<span style="color: #000000"> self.ordered_data(data)
        quoted_string </span>= <span style="color: #800000">"</span><span style="color: #800000">&amp;</span><span style="color: #800000">"</span>.join(<span style="color: #800000">"</span><span style="color: #800000">{0}={1}</span><span style="color: #800000">"</span>.format(k, quote_plus(v)) <span style="color: #0000ff">for</span> k, v <span style="color: #0000ff">in</span><span style="color: #000000"> ordered_items)

        </span><span style="color: #008000">#</span><span style="color: #008000"> 获得最终的订单信息字符串</span>
        signed_string = quoted_string + <span style="color: #800000">"</span><span style="color: #800000">&amp;sign=</span><span style="color: #800000">"</span> +<span style="color: #000000"> quote_plus(sign)
        </span><span style="color: #0000ff">return</span><span style="color: #000000"> signed_string

    </span><span style="color: #0000ff">def</span><span style="color: #000000"> ordered_data(self, data):
        complex_keys </span>=<span style="color: #000000"> []
        </span><span style="color: #0000ff">for</span> key, value <span style="color: #0000ff">in</span><span style="color: #000000"> data.items():
            </span><span style="color: #0000ff">if</span><span style="color: #000000"> isinstance(value, dict):
                complex_keys.append(key)

        </span><span style="color: #008000">#</span><span style="color: #008000"> 将字典类型的数据dump出来</span>
        <span style="color: #0000ff">for</span> key <span style="color: #0000ff">in</span><span style="color: #000000"> complex_keys:
            data[key] </span>= json.dumps(data[key], separators=(<span style="color: #800000">'</span><span style="color: #800000">,</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">:</span><span style="color: #800000">'</span><span style="color: #000000">))

        </span><span style="color: #0000ff">return</span> sorted([(k, v) <span style="color: #0000ff">for</span> k, v <span style="color: #0000ff">in</span><span style="color: #000000"> data.items()])

    </span><span style="color: #0000ff">def</span><span style="color: #000000"> sign(self, unsigned_string):
        </span><span style="color: #008000">#</span><span style="color: #008000"> 开始计算签名</span>
        key =<span style="color: #000000"> self.app_private_key
        signer </span>=<span style="color: #000000"> PKCS1_v1_5.new(key)
        signature </span>=<span style="color: #000000"> signer.sign(SHA256.new(unsigned_string))
        </span><span style="color: #008000">#</span><span style="color: #008000"> base64 编码，转换为unicode表示并移除回车</span>
        sign = encodebytes(signature).decode(<span style="color: #800000">"</span><span style="color: #800000">utf8</span><span style="color: #800000">"</span>).replace(<span style="color: #800000">"</span><span style="color: #800000">\n</span><span style="color: #800000">"</span>, <span style="color: #800000">""</span><span style="color: #000000">)
        </span><span style="color: #0000ff">return</span><span style="color: #000000"> sign

    </span><span style="color: #0000ff">def</span><span style="color: #000000"> _verify(self, raw_content, signature):
        </span><span style="color: #008000">#</span><span style="color: #008000"> 开始计算签名</span>
        key =<span style="color: #000000"> self.alipay_public_key
        signer </span>=<span style="color: #000000"> PKCS1_v1_5.new(key)
        digest </span>=<span style="color: #000000"> SHA256.new()
        digest.update(raw_content.encode(</span><span style="color: #800000">"</span><span style="color: #800000">utf8</span><span style="color: #800000">"</span><span style="color: #000000">))
        </span><span style="color: #0000ff">if</span> signer.verify(digest, decodebytes(signature.encode(<span style="color: #800000">"</span><span style="color: #800000">utf8</span><span style="color: #800000">"</span><span style="color: #000000">))):
            </span><span style="color: #0000ff">return</span><span style="color: #000000"> True
        </span><span style="color: #0000ff">return</span><span style="color: #000000"> False

    </span><span style="color: #0000ff">def</span><span style="color: #000000"> verify(self, data, signature):
        </span><span style="color: #0000ff">if</span> <span style="color: #800000">"</span><span style="color: #800000">sign_type</span><span style="color: #800000">"</span> <span style="color: #0000ff">in</span><span style="color: #000000"> data:
            sign_type </span>= data.pop(<span style="color: #800000">"</span><span style="color: #800000">sign_type</span><span style="color: #800000">"</span><span style="color: #000000">)
        </span><span style="color: #008000">#</span><span style="color: #008000"> 排序后的字符串</span>
        unsigned_items =<span style="color: #000000"> self.ordered_data(data)
        message </span>= <span style="color: #800000">"</span><span style="color: #800000">&amp;</span><span style="color: #800000">"</span>.join(u<span style="color: #800000">"</span><span style="color: #800000">{}={}</span><span style="color: #800000">"</span>.format(k, v) <span style="color: #0000ff">for</span> k, v <span style="color: #0000ff">in</span><span style="color: #000000"> unsigned_items)
        </span><span style="color: #0000ff">return</span><span style="color: #000000"> self._verify(message, signature)


</span><span style="background-color: #ffff99"><span style="color: #0000ff">if</span> <span style="color: #800080">__name__</span> == <span style="color: #800000">"</span><span style="color: #800000">__main__</span><span style="color: #800000">"</span><span style="color: #000000">:
    </span><span style="color: #800000">"""</span><span style="color: #800000">支付请求过程</span><span style="color: #800000">"""</span>
    <span style="color: #008000">#</span><span style="color: #008000"> 传递参数初始化支付类</span>
    alipay =<span style="color: #000000"> AliPay(
        appid</span>=<span style="color: #800000">"</span><span style="color: #800000">2016080800192023</span><span style="color: #800000">"</span>,                                   <span style="color: #008000">#</span><span style="color: #008000"> 设置签约的appid</span>
        app_notify_url=<span style="color: #800000">"</span><span style="color: #800000">http://projectsedus.com/</span><span style="color: #800000">"</span>,                  <span style="color: #008000">#</span><span style="color: #008000"> 异步支付通知url</span>
        app_private_key_path=u<span style="color: #800000">"</span><span style="color: #800000">ying_yong_si_yao.txt</span><span style="color: #800000">"</span>,               <span style="color: #008000">#</span><span style="color: #008000"> 设置应用私钥</span>
        alipay_public_key_path=<span style="color: #800000">"</span><span style="color: #800000">zhi_fu_bao_gong_yao.txt</span><span style="color: #800000">"</span>,           <span style="color: #008000">#</span><span style="color: #008000"> 支付宝的公钥，验证支付宝回传消息使用，不是你自己的公钥,</span>
        debug=True,  <span style="color: #008000">#</span><span style="color: #008000"> 默认False,                                   # 设置是否是沙箱环境，True是沙箱环境</span>
        return_url=<span style="color: #800000">"</span><span style="color: #800000">http://47.92.87.172:8000/</span><span style="color: #800000">"</span>                      <span style="color: #008000">#</span><span style="color: #008000"> 同步支付通知url</span>
<span style="color: #000000">    )

    </span><span style="color: #008000">#</span><span style="color: #008000"> 传递参数执行支付类里的direct_pay方法，返回签名后的支付参数，</span>
    url =<span style="color: #000000"> alipay.direct_pay(
        subject</span>=<span style="color: #800000">"</span><span style="color: #800000">测试订单</span><span style="color: #800000">"</span>,                              <span style="color: #008000">#</span><span style="color: #008000"> 订单名称</span>
        <span style="color: #008000">#</span><span style="color: #008000"> 订单号生成，一般是当前时间(精确到秒)+用户ID+随机数</span>
        out_trade_no=<span style="color: #800000">"</span><span style="color: #800000">201702021225</span><span style="color: #800000">"</span>,                    <span style="color: #008000">#</span><span style="color: #008000"> 订单号</span>
        total_amount=100,                               <span style="color: #008000">#</span><span style="color: #008000"> 支付金额</span>
        return_url=<span style="color: #800000">"</span><span style="color: #800000">http://47.92.87.172:8000/</span><span style="color: #800000">"</span>          <span style="color: #008000">#</span><span style="color: #008000"> 支付成功后，跳转url</span>
<span style="color: #000000">    )
    
    </span><span style="color: #008000">#</span><span style="color: #008000"> 将前面后的支付参数，拼接到支付网关</span>
    <span style="color: #008000">#</span><span style="color: #008000"> 注意：下面支付网关是沙箱环境，</span>
    re_url = <span style="color: #800000">"</span><span style="color: #800000">https://openapi.alipaydev.com/gateway.do?{data}</span><span style="color: #800000">"</span>.format(data=<span style="color: #000000">url)
    </span><span style="color: #0000ff">print</span><span style="color: #000000">(re_url)
    </span><span style="color: #008000">#</span><span style="color: #008000"> 最终进行签名后组合成支付宝的url请求</span></span></pre>
</div>
<p><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171011223027090-1232135894.png" alt=""></p>
<p>&nbsp;</p>
<p><strong>4.生成支付URL后，我们用这个URL模拟支付一下</strong></p>
<p><strong>注意：沙箱环境，支付的时候要用沙箱账号里提供的支付账号才可以支付</strong></p>
<p><strong><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171011223209902-1157391849.png" alt=""></strong></p>
<p>&nbsp;</p>
<p><strong>支付成功后已经，跳转到我们设置的同步处理页面</strong></p>
<p><strong><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171011223937168-1528458329.png" alt=""></strong></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>5.支付宝支付成功后通知接口验证</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf8 -*-</span>

<span style="color: #008000">#</span><span style="color: #008000"> pip install pycryptodome   需要模块加密方面的模块</span>
<span style="color: #800080">__author__</span> = <span style="color: #800000">'</span><span style="color: #800000">bobby</span><span style="color: #800000">'</span>

<span style="color: #0000ff">from</span> datetime <span style="color: #0000ff">import</span><span style="color: #000000"> datetime
</span><span style="color: #0000ff">from</span> Crypto.PublicKey <span style="color: #0000ff">import</span><span style="color: #000000"> RSA
</span><span style="color: #0000ff">from</span> Crypto.Signature <span style="color: #0000ff">import</span><span style="color: #000000"> PKCS1_v1_5
</span><span style="color: #0000ff">from</span> Crypto.Hash <span style="color: #0000ff">import</span><span style="color: #000000"> SHA256
</span><span style="color: #0000ff">from</span> base64 <span style="color: #0000ff">import</span><span style="color: #000000"> b64encode, b64decode
</span><span style="color: #0000ff">from</span> urllib.parse <span style="color: #0000ff">import</span><span style="color: #000000"> quote_plus
</span><span style="color: #0000ff">from</span> urllib.parse <span style="color: #0000ff">import</span><span style="color: #000000"> urlparse, parse_qs
</span><span style="color: #0000ff">from</span> urllib.request <span style="color: #0000ff">import</span><span style="color: #000000"> urlopen
</span><span style="color: #0000ff">from</span> base64 <span style="color: #0000ff">import</span><span style="color: #000000"> decodebytes, encodebytes

</span><span style="color: #0000ff">import</span><span style="color: #000000"> json


</span><span style="color: #0000ff">class</span><span style="color: #000000"> AliPay(object):
    </span><span style="color: #800000">"""</span><span style="color: #800000">
    支付宝支付接口
    </span><span style="color: #800000">"""</span>
    <span style="color: #0000ff">def</span> <span style="color: #800080">__init__</span><span style="color: #000000">(self, appid, app_notify_url, app_private_key_path,
                 alipay_public_key_path, return_url, debug</span>=<span style="color: #000000">False):
        self.appid </span>=<span style="color: #000000"> appid
        self.app_notify_url </span>=<span style="color: #000000"> app_notify_url
        self.app_private_key_path </span>=<span style="color: #000000"> app_private_key_path
        self.app_private_key </span>=<span style="color: #000000"> None
        self.return_url </span>=<span style="color: #000000"> return_url
        with open(self.app_private_key_path) as fp:
            self.app_private_key </span>=<span style="color: #000000"> RSA.importKey(fp.read())

        self.alipay_public_key_path </span>=<span style="color: #000000"> alipay_public_key_path
        with open(self.alipay_public_key_path) as fp:
            self.alipay_public_key </span>=<span style="color: #000000"> RSA.import_key(fp.read())


        </span><span style="color: #0000ff">if</span> debug <span style="color: #0000ff">is</span><span style="color: #000000"> True:
            self.</span><span style="color: #800080">__gateway</span> = <span style="color: #800000">"</span><span style="color: #800000">https://openapi.alipaydev.com/gateway.do</span><span style="color: #800000">"</span>
        <span style="color: #0000ff">else</span><span style="color: #000000">:
            self.</span><span style="color: #800080">__gateway</span> = <span style="color: #800000">"</span><span style="color: #800000">https://openapi.alipay.com/gateway.do</span><span style="color: #800000">"</span>

    <span style="color: #0000ff">def</span> direct_pay(self, subject, out_trade_no, total_amount, return_url=None, **<span style="color: #000000">kwargs):
        biz_content </span>=<span style="color: #000000"> {
            </span><span style="color: #800000">"</span><span style="color: #800000">subject</span><span style="color: #800000">"</span><span style="color: #000000">: subject,
            </span><span style="color: #800000">"</span><span style="color: #800000">out_trade_no</span><span style="color: #800000">"</span><span style="color: #000000">: out_trade_no,
            </span><span style="color: #800000">"</span><span style="color: #800000">total_amount</span><span style="color: #800000">"</span><span style="color: #000000">: total_amount,
            </span><span style="color: #800000">"</span><span style="color: #800000">product_code</span><span style="color: #800000">"</span>: <span style="color: #800000">"</span><span style="color: #800000">FAST_INSTANT_TRADE_PAY</span><span style="color: #800000">"</span><span style="color: #000000">,
            </span><span style="color: #008000">#</span><span style="color: #008000"> "qr_pay_mode":4</span>
<span style="color: #000000">        }

        biz_content.update(kwargs)
        data </span>= self.build_body(<span style="color: #800000">"</span><span style="color: #800000">alipay.trade.page.pay</span><span style="color: #800000">"</span><span style="color: #000000">, biz_content, self.return_url)
        </span><span style="color: #0000ff">return</span><span style="color: #000000"> self.sign_data(data)

    </span><span style="color: #0000ff">def</span> build_body(self, method, biz_content, return_url=<span style="color: #000000">None):
        data </span>=<span style="color: #000000"> {
            </span><span style="color: #800000">"</span><span style="color: #800000">app_id</span><span style="color: #800000">"</span><span style="color: #000000">: self.appid,
            </span><span style="color: #800000">"</span><span style="color: #800000">method</span><span style="color: #800000">"</span><span style="color: #000000">: method,
            </span><span style="color: #800000">"</span><span style="color: #800000">charset</span><span style="color: #800000">"</span>: <span style="color: #800000">"</span><span style="color: #800000">utf-8</span><span style="color: #800000">"</span><span style="color: #000000">,
            </span><span style="color: #800000">"</span><span style="color: #800000">sign_type</span><span style="color: #800000">"</span>: <span style="color: #800000">"</span><span style="color: #800000">RSA2</span><span style="color: #800000">"</span><span style="color: #000000">,
            </span><span style="color: #800000">"</span><span style="color: #800000">timestamp</span><span style="color: #800000">"</span>: datetime.now().strftime(<span style="color: #800000">"</span><span style="color: #800000">%Y-%m-%d %H:%M:%S</span><span style="color: #800000">"</span><span style="color: #000000">),
            </span><span style="color: #800000">"</span><span style="color: #800000">version</span><span style="color: #800000">"</span>: <span style="color: #800000">"</span><span style="color: #800000">1.0</span><span style="color: #800000">"</span><span style="color: #000000">,
            </span><span style="color: #800000">"</span><span style="color: #800000">biz_content</span><span style="color: #800000">"</span><span style="color: #000000">: biz_content
        }

        </span><span style="color: #0000ff">if</span> return_url <span style="color: #0000ff">is</span> <span style="color: #0000ff">not</span><span style="color: #000000"> None:
            data[</span><span style="color: #800000">"</span><span style="color: #800000">notify_url</span><span style="color: #800000">"</span>] =<span style="color: #000000"> self.app_notify_url
            data[</span><span style="color: #800000">"</span><span style="color: #800000">return_url</span><span style="color: #800000">"</span>] =<span style="color: #000000"> self.return_url

        </span><span style="color: #0000ff">return</span><span style="color: #000000"> data

    </span><span style="color: #0000ff">def</span><span style="color: #000000"> sign_data(self, data):
        data.pop(</span><span style="color: #800000">"</span><span style="color: #800000">sign</span><span style="color: #800000">"</span><span style="color: #000000">, None)
        </span><span style="color: #008000">#</span><span style="color: #008000"> 排序后的字符串</span>
        unsigned_items =<span style="color: #000000"> self.ordered_data(data)
        unsigned_string </span>= <span style="color: #800000">"</span><span style="color: #800000">&amp;</span><span style="color: #800000">"</span>.join(<span style="color: #800000">"</span><span style="color: #800000">{0}={1}</span><span style="color: #800000">"</span>.format(k, v) <span style="color: #0000ff">for</span> k, v <span style="color: #0000ff">in</span><span style="color: #000000"> unsigned_items)
        sign </span>= self.sign(unsigned_string.encode(<span style="color: #800000">"</span><span style="color: #800000">utf-8</span><span style="color: #800000">"</span><span style="color: #000000">))
        ordered_items </span>=<span style="color: #000000"> self.ordered_data(data)
        quoted_string </span>= <span style="color: #800000">"</span><span style="color: #800000">&amp;</span><span style="color: #800000">"</span>.join(<span style="color: #800000">"</span><span style="color: #800000">{0}={1}</span><span style="color: #800000">"</span>.format(k, quote_plus(v)) <span style="color: #0000ff">for</span> k, v <span style="color: #0000ff">in</span><span style="color: #000000"> ordered_items)

        </span><span style="color: #008000">#</span><span style="color: #008000"> 获得最终的订单信息字符串</span>
        signed_string = quoted_string + <span style="color: #800000">"</span><span style="color: #800000">&amp;sign=</span><span style="color: #800000">"</span> +<span style="color: #000000"> quote_plus(sign)
        </span><span style="color: #0000ff">return</span><span style="color: #000000"> signed_string

    </span><span style="color: #0000ff">def</span><span style="color: #000000"> ordered_data(self, data):
        complex_keys </span>=<span style="color: #000000"> []
        </span><span style="color: #0000ff">for</span> key, value <span style="color: #0000ff">in</span><span style="color: #000000"> data.items():
            </span><span style="color: #0000ff">if</span><span style="color: #000000"> isinstance(value, dict):
                complex_keys.append(key)

        </span><span style="color: #008000">#</span><span style="color: #008000"> 将字典类型的数据dump出来</span>
        <span style="color: #0000ff">for</span> key <span style="color: #0000ff">in</span><span style="color: #000000"> complex_keys:
            data[key] </span>= json.dumps(data[key], separators=(<span style="color: #800000">'</span><span style="color: #800000">,</span><span style="color: #800000">'</span>, <span style="color: #800000">'</span><span style="color: #800000">:</span><span style="color: #800000">'</span><span style="color: #000000">))

        </span><span style="color: #0000ff">return</span> sorted([(k, v) <span style="color: #0000ff">for</span> k, v <span style="color: #0000ff">in</span><span style="color: #000000"> data.items()])

    </span><span style="color: #0000ff">def</span><span style="color: #000000"> sign(self, unsigned_string):
        </span><span style="color: #008000">#</span><span style="color: #008000"> 开始计算签名</span>
        key =<span style="color: #000000"> self.app_private_key
        signer </span>=<span style="color: #000000"> PKCS1_v1_5.new(key)
        signature </span>=<span style="color: #000000"> signer.sign(SHA256.new(unsigned_string))
        </span><span style="color: #008000">#</span><span style="color: #008000"> base64 编码，转换为unicode表示并移除回车</span>
        sign = encodebytes(signature).decode(<span style="color: #800000">"</span><span style="color: #800000">utf8</span><span style="color: #800000">"</span>).replace(<span style="color: #800000">"</span><span style="color: #800000">\n</span><span style="color: #800000">"</span>, <span style="color: #800000">""</span><span style="color: #000000">)
        </span><span style="color: #0000ff">return</span><span style="color: #000000"> sign

    </span><span style="color: #0000ff">def</span><span style="color: #000000"> _verify(self, raw_content, signature):
        </span><span style="color: #008000">#</span><span style="color: #008000"> 开始计算签名</span>
        key =<span style="color: #000000"> self.alipay_public_key
        signer </span>=<span style="color: #000000"> PKCS1_v1_5.new(key)
        digest </span>=<span style="color: #000000"> SHA256.new()
        digest.update(raw_content.encode(</span><span style="color: #800000">"</span><span style="color: #800000">utf8</span><span style="color: #800000">"</span><span style="color: #000000">))
        </span><span style="color: #0000ff">if</span> signer.verify(digest, decodebytes(signature.encode(<span style="color: #800000">"</span><span style="color: #800000">utf8</span><span style="color: #800000">"</span><span style="color: #000000">))):
            </span><span style="color: #0000ff">return</span><span style="color: #000000"> True
        </span><span style="color: #0000ff">return</span><span style="color: #000000"> False

    </span><span style="color: #0000ff">def</span><span style="color: #000000"> verify(self, data, signature):
        </span><span style="color: #0000ff">if</span> <span style="color: #800000">"</span><span style="color: #800000">sign_type</span><span style="color: #800000">"</span> <span style="color: #0000ff">in</span><span style="color: #000000"> data:
            sign_type </span>= data.pop(<span style="color: #800000">"</span><span style="color: #800000">sign_type</span><span style="color: #800000">"</span><span style="color: #000000">)
        </span><span style="color: #008000">#</span><span style="color: #008000"> 排序后的字符串</span>
        unsigned_items =<span style="color: #000000"> self.ordered_data(data)
        message </span>= <span style="color: #800000">"</span><span style="color: #800000">&amp;</span><span style="color: #800000">"</span>.join(u<span style="color: #800000">"</span><span style="color: #800000">{}={}</span><span style="color: #800000">"</span>.format(k, v) <span style="color: #0000ff">for</span> k, v <span style="color: #0000ff">in</span><span style="color: #000000"> unsigned_items)
        </span><span style="color: #0000ff">return</span><span style="color: #000000"> self._verify(message, signature)


</span><span style="background-color: #ffff99"><span style="color: #0000ff">if</span> <span style="color: #800080">__name__</span> == <span style="color: #800000">"</span><span style="color: #800000">__main__</span><span style="color: #800000">"</span><span style="color: #000000">:
    </span><span style="color: #800000">"""</span><span style="color: #800000">支付宝支付成功后通知接口验证</span><span style="color: #800000">"""</span>

    <span style="color: #008000">#</span><span style="color: #008000"> 接收支付宝支付成功后，向我们设置的同步支付通知url，请求的参数</span>
    return_url = <span style="color: #800000">'</span><span style="color: #800000">http://47.92.87.172:8000/?total_amount=100.00&amp;timestamp=2017-10-11+22%3A44%3A17&amp;sign=dHW%2F25EDd%2BYKqkU5krhseDNIOEyDpdJzSAaoqhTC0nlv8%2FEmrQVd0WqgGK0CS8Pax8sK4jIOdGLFa6lQEbIfzvH3Na2W949yCAYX04JL1Bi02wog7a8L7vfW9Kj%2BjfTQxumGH%2B1Drbezdg9gKOx3tX0cb1yBBdfifK6l1%2BE5UjggGbY60F6SD8A8XI06NMWb4ViU%2FLYtBhwAwU2koy1IK2%2BtBJM1xYFuBRlcWF61xCxexHwO0WEA3AwVRW1miuJjOpGiBTOwPI9Huj0WhkyRebIjBhSxReJdZIdTfAgwj4oqo4jAJCHDa6DKBM0H3wjKKXSyMeMBGKQB0Uv2rNdyng%3D%3D&amp;trade_no=2017101121001004320200174640&amp;sign_type=RSA2&amp;auth_app_id=2016080800192023&amp;charset=utf-8&amp;seller_id=2088102170418468&amp;method=alipay.trade.page.pay.return&amp;app_id=2016080800192023&amp;out_trade_no=201702021227&amp;version=1.0</span><span style="color: #800000">'</span>

    <span style="color: #008000">#</span><span style="color: #008000"> 将同步支付通知url,传到urlparse</span>
    o =<span style="color: #000000"> urlparse(return_url)
    </span><span style="color: #008000">#</span><span style="color: #008000"> 获取到URL的各种参数</span>
    query =<span style="color: #000000"> parse_qs(o.query)
    </span><span style="color: #008000">#</span><span style="color: #008000"> 定义一个字典来存放，循环获取到的URL参数</span>
    processed_query =<span style="color: #000000"> {}
    </span><span style="color: #008000">#</span><span style="color: #008000"> 将URL参数里的sign字段拿出来</span>
    ali_sign = query.pop(<span style="color: #800000">"</span><span style="color: #800000">sign</span><span style="color: #800000">"</span><span style="color: #000000">)[0]

    </span><span style="color: #008000">#</span><span style="color: #008000"> 传递参数初始化支付类</span>
    alipay =<span style="color: #000000"> AliPay(
        appid</span>=<span style="color: #800000">"</span><span style="color: #800000">2016080800192023</span><span style="color: #800000">"</span>,                                   <span style="color: #008000">#</span><span style="color: #008000"> 设置签约的appid</span>
        app_notify_url=<span style="color: #800000">"</span><span style="color: #800000">http://projectsedus.com/</span><span style="color: #800000">"</span>,                  <span style="color: #008000">#</span><span style="color: #008000"> 异步支付通知url</span>
        app_private_key_path=u<span style="color: #800000">"</span><span style="color: #800000">ying_yong_si_yao.txt</span><span style="color: #800000">"</span>,               <span style="color: #008000">#</span><span style="color: #008000"> 设置应用私钥</span>
        alipay_public_key_path=<span style="color: #800000">"</span><span style="color: #800000">zhi_fu_bao_gong_yao.txt</span><span style="color: #800000">"</span>,           <span style="color: #008000">#</span><span style="color: #008000"> 支付宝的公钥，验证支付宝回传消息使用，不是你自己的公钥,</span>
        debug=True,  <span style="color: #008000">#</span><span style="color: #008000"> 默认False,                                   # 设置是否是沙箱环境，True是沙箱环境</span>
        return_url=<span style="color: #800000">"</span><span style="color: #800000">http://47.92.87.172:8000/</span><span style="color: #800000">"</span>                      <span style="color: #008000">#</span><span style="color: #008000"> 同步支付通知url</span>
<span style="color: #000000">    )

    </span><span style="color: #008000">#</span><span style="color: #008000"> 循环出URL里的参数</span>
    <span style="color: #0000ff">for</span> key, value <span style="color: #0000ff">in</span><span style="color: #000000"> query.items():
        </span><span style="color: #008000">#</span><span style="color: #008000"> 将循环到的参数，以键值对形式追加到processed_query字典</span>
        processed_query[key] =<span style="color: #000000"> value[0]
    </span><span style="color: #008000">#</span><span style="color: #008000"> 将循环组合的参数字典，以及拿出来的sign字段，传进支付类里的verify方法，返回验证合法性，返回布尔值，True为合法，表示支付确实成功了，这就是验证是否是伪造支付成功请求</span>
    <span style="color: #0000ff">print</span><span style="color: #000000">(alipay.verify(processed_query, ali_sign))

</span><span style="color: #008000">#</span><span style="color: #008000"> 如果别人伪造支付成功请求，它不知道我们的支付宝公钥，伪造的就无法通过验证，测试可以将支付宝公钥更改一下，在验证就会失败，别忘了改回来</span></span></pre>
</div>
<p><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171011232137715-439213706.png" alt=""></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>远程测试支付成功后返回服务器验证</strong></span></p>
<p><strong>首先准备一台服务器，将开发环境和项目同步到服务器上，并且在服务器上配置好python虚拟环境和所需python插件包</strong></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong><strong>项目同步到服务器上，也就是将本地项目，上传到服务器进行同步</strong></strong></span></p>
<p><strong><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171012235536152-778991206.png" alt=""></strong></p>
<p><span style="color: #ff0000"><strong>配置服务器信息</strong></span></p>
<p><span style="color: #ff0000"><strong><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171013000635809-628510766.png" alt=""></strong></span></p>
<p><strong>2</strong></p>
<p><strong><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171013000647777-644735933.png" alt=""></strong></p>
<p><strong>上传项目</strong></p>
<p><strong><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171013000813574-1060201089.png" alt=""></strong></p>
<p><strong>数据上传后，在服务器配置数据库访问权限，和配置python环境</strong></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>配置远程调试</strong></span></p>
<p><span style="color: #ff0000"><strong>1，在阿里云后台，开放8000端口</strong></span></p>
<p><strong><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171013001342465-571255247.png" alt=""></strong></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>2，在服务器开发8000端口</strong></span></p>
<div class="cnblogs_code">
<pre>vim /etc/sysconfig/iptables</pre>
</div>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000"> Firewall configuration written by system-config-firewall</span><span style="color: #008000">
#</span><span style="color: #008000"> Manual customization of this file is not recommended.</span>
*<span style="color: #000000">filter
:INPUT ACCEPT [0:0]
:FORWARD ACCEPT [0:0]
:OUTPUT ACCEPT [0:0]
</span>-A INPUT -m state --state ESTABLISHED,RELATED -<span style="color: #000000">j ACCEPT
</span>-A INPUT -p icmp -<span style="color: #000000">j ACCEPT
</span>-A INPUT -i lo -<span style="color: #000000">j ACCEPT
</span>-A INPUT -m state --state NEW -m tcp -p tcp --dport 22 -<span style="color: #000000">j ACCEPT
</span><span style="color: #008000">#</span><span style="color: #008000">添加配置项</span>
-A INPUT -m state --state NEW -m tcp -p tcp --dport 80 -<span style="color: #000000">j ACCEPT
</span><span style="background-color: #ff99cc">-A INPUT -m state --state NEW -m tcp -p tcp --dport 8000 -<span style="color: #000000">j ACCEPT
</span></span>-A INPUT -m state --state NEW -m tcp -p tcp --dport 3306 -<span style="color: #000000">j ACCEPT
</span>-A INPUT -j REJECT --reject-with icmp-host-<span style="color: #000000">prohibited
</span>-A FORWARD -j REJECT --reject-with icmp-host-<span style="color: #000000">prohibited
COMMIT</span></pre>
</div>
<p><strong>重启防火墙</strong></p>
<div class="cnblogs_code">
<pre>service iptables restart</pre>
</div>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>设置当前，使用的数据库用户，可以任意ip访问</strong></span></p>
<p><strong>让数据库用户可以从外部登陆和本地登陆</strong></p>
<p><strong>1</strong></p>
<p><strong>grant&nbsp;all privileges(除授权外的所有权限)&nbsp;on&nbsp;*.*(表示所有数据库的所有表)&nbsp;to 'test_user(授权的用户名)'@'localhost(授权ip)' identified by 'test_user(用户密码)';</strong></p>
<div class="cnblogs_code">
<pre>grant all privileges on *.* to 'test_user'@'localhost' identified by 'test_user';</pre>
</div>
<p>2</p>
<pre>grant all privileges(<strong>除授权外的所有权限</strong>) on *.*(<strong>表示所有数据库的所有表</strong>) to 'test_user(<strong>授权的用户名</strong>)'@'%(所有ip)' identified by 'test_user(用户密码)';</pre>
<div class="cnblogs_code">
<pre>grant all privileges on *.* to 'test_user'@'%' identified by 'test_user';</pre>
</div>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>配置项目的settings.py文件</strong></span></p>
<div class="cnblogs_code">
<pre>DATABASES =<span style="color: #000000"> {
    </span><span style="color: #800000">'</span><span style="color: #800000">default</span><span style="color: #800000">'</span><span style="color: #000000">: {
        </span><span style="color: #800000">'</span><span style="color: #800000">ENGINE</span><span style="color: #800000">'</span>: <span style="color: #800000">'</span><span style="color: #800000">django.db.backends.mysql</span><span style="color: #800000">'</span>,       <span style="color: #008000">#</span><span style="color: #008000">配置数据库引擎名称</span>
        <span style="color: #800000">'</span><span style="color: #800000">NAME</span><span style="color: #800000">'</span>: <span style="color: #800000">'</span><span style="color: #800000">jxiou</span><span style="color: #800000">'</span>,                            <span style="color: #008000">#</span><span style="color: #008000">数据库名称</span>
        <span style="color: #800000">'</span><span style="color: #800000">USER</span><span style="color: #800000">'</span>: <span style="color: #800000">'</span><span style="color: #800000">test_user</span><span style="color: #800000">'</span>,                             <span style="color: #008000">#</span><span style="color: #008000">数据库用户名</span>
        <span style="color: #800000">'</span><span style="color: #800000">PASSWORD</span><span style="color: #800000">'</span>: <span style="color: #800000">'</span><span style="color: #800000">test_user</span><span style="color: #800000">'</span>,                       <span style="color: #008000">#</span><span style="color: #008000">数据库密码</span>
        <span style="background-color: #ff99cc"><span style="color: #800000">'</span><span style="color: #800000">HOST</span><span style="color: #800000">'</span>: <span style="color: #800000">'</span><span style="color: #800000">47.52.39.160</span><span style="color: #800000">'</span>,                        <span style="color: #008000">#</span><span style="color: #008000">数据库链接地址,为服务器ip</span></span>
        <span style="color: #800000">'</span><span style="color: #800000">PORT</span><span style="color: #800000">'</span>: <span style="color: #800000">'</span><span style="color: #800000">3306</span><span style="color: #800000">'</span>,                             <span style="color: #008000">#</span><span style="color: #008000">数据库端口</span>
<span style="color: #000000">    }
}</span></pre>
</div>
<p>2</p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000"> SECURITY WARNING: don't run with debug turned on in production!</span>
DEBUG =<span style="color: #000000"> True

<span style="background-color: #ff99cc">ALLOWED_HOSTS </span></span><span style="background-color: #ff99cc">= [<span style="color: #800000">'</span><span style="color: #800000">*</span><span style="color: #800000">'</span>]   <span style="color: #008000">#</span><span style="color: #008000"> 允许任意ip访问项目</span></span></pre>
</div>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>开始远程调试</strong></span></p>
<p><span style="color: #ff0000"><strong><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171013002431480-465061811.png" alt=""></strong></span></p>
<p><span style="color: #ff0000"><strong>2</strong></span></p>
<p><span style="color: #ff0000"><strong><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171013002644199-669547678.png" alt=""></strong></span></p>
<p><span style="color: #ff0000"><strong>3</strong></span></p>
<p><span style="color: #ff0000"><strong><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171013002735871-1398485305.png" alt=""></strong></span></p>
<p><span style="color: #ff0000"><strong>4</strong></span></p>
<p><span style="color: #ff0000"><strong><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171013003011965-551730648.png" alt=""></strong></span></p>
<p><span style="color: #ff0000"><strong>5</strong></span></p>
<p><span style="color: #ff0000"><strong><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171013003147762-551951066.png" alt=""></strong></span></p>
<p><span style="color: #ff0000"><strong>此时，就可以用服务器ip加8000端口，访问服务器网站了</strong></span></p>
<p><span style="color: #ff0000"><strong><img src="https://images2017.cnblogs.com/blog/955761/201710/955761-20171013003352074-161328171.png" alt=""></strong></span></p>
<p><span style="color: #ff0000"><strong>前面，我们在本地调试了支付宝支付请求，这下我们要调试，支付宝支付成功后向我们服务器返回请求我们要验证返回的请求，，所以需要将远程服务器启动来，接收支付宝的返回</strong></span></p>
<p><span style="color: #ff0000"><strong>settings.py</strong></span></p>
<p>&nbsp;</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff">import</span><span style="color: #000000"> os

</span><span style="color: #008000">#</span><span style="color: #008000"> Build paths inside the project like this: os.path.join(BASE_DIR, ...)</span>
BASE_DIR = os.path.dirname(os.path.dirname(os.path.abspath(<span style="color: #800080">__file__</span><span style="color: #000000">)))

</span><span style="color: #008000">#</span><span style="color: #008000"> 支付宝目录路径设置</span>
<span style="background-color: #ffcc99">ying_yong_si_yao = os.path.join(BASE_DIR, <span style="color: #800000">'</span><span style="color: #800000">app1/alipay/ying_yong_si_yao.txt</span><span style="color: #800000">'</span><span style="color: #000000">)
zhi_fu_bao_gong_yao </span>= os.path.join(BASE_DIR, <span style="color: #800000">'</span><span style="color: #800000">app1/alipay/zhi_fu_bao_gong_yao.txt</span><span style="color: #800000">'</span>)</span></pre>
</div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>urls.py</strong></span></p>
<p>&nbsp;</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff">from</span> django.conf.urls <span style="color: #0000ff">import</span><span style="color: #000000"> url
</span><span style="color: #0000ff">from</span> django.contrib <span style="color: #0000ff">import</span><span style="color: #000000"> admin
</span><span style="color: #0000ff">from</span> app1.views <span style="color: #0000ff">import</span><span style="color: #000000"> alipaview

urlpatterns </span>=<span style="color: #000000"> [
    url(r</span><span style="color: #800000">'</span><span style="color: #800000">^admin/</span><span style="color: #800000">'</span><span style="color: #000000">, admin.site.urls),
    </span><span style="color: #008000">#</span><span style="color: #008000"> 支付宝返回url</span>
    <span style="background-color: #ffcc99">url(r<span style="color: #800000">'</span><span style="color: #800000">^alipa/</span><span style="color: #800000">'</span>, alipaview, name=<span style="color: #800000">'</span><span style="color: #800000">alipa</span><span style="color: #800000">'</span></span><span style="color: #000000"><span style="background-color: #ffcc99">),</span>
]</span></pre>
</div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>views.py</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf8 -*-</span>
<span style="color: #0000ff">from</span> django.shortcuts <span style="color: #0000ff">import</span><span style="color: #000000"> render

</span><span style="color: #008000">#</span><span style="color: #008000"> Create your views here.</span>
<span style="color: #0000ff">from</span> django.shortcuts <span style="color: #0000ff">import</span><span style="color: #000000"> render,HttpResponse
</span><span style="background-color: #ff99cc"><span style="color: #0000ff">from</span> django.views.decorators.csrf <span style="color: #0000ff">import</span><span style="color: #000000"> csrf_exempt,csrf_protect

</span><span style="color: #0000ff">from</span> app1.alipay.alipay <span style="color: #0000ff">import</span><span style="color: #000000"> AliPay
</span></span><span style="color: #0000ff">from</span> jxiou.settings <span style="color: #0000ff">import</span><span style="color: #000000"> ying_yong_si_yao, zhi_fu_bao_gong_yao

<span style="background-color: #ff99cc">@csrf_exempt
</span></span><span style="color: #0000ff">def</span><span style="color: #000000"> alipaview(request):
    </span><span style="background-color: #ccffcc"><span style="color: #0000ff">if</span> request.method == <span style="color: #800000">"</span><span style="color: #800000">GET</span><span style="color: #800000">"</span><span style="color: #000000">:
        processed_dict </span>= {}  <span style="color: #008000">#</span><span style="color: #008000"> 接收支付宝传递参数</span>
        <span style="color: #0000ff">for</span> key, value <span style="color: #0000ff">in</span> request.GET.items():  <span style="color: #008000">#</span><span style="color: #008000"> 循环参数</span>
            processed_dict[key] = value  <span style="color: #008000">#</span><span style="color: #008000"> 将参数添加到字典</span>
        sign = processed_dict.pop(<span style="color: #800000">'</span><span style="color: #800000">sign</span><span style="color: #800000">'</span>, None)  <span style="color: #008000">#</span><span style="color: #008000"> 单独拿出sign字段</span>

        <span style="color: #008000">#</span><span style="color: #008000"> 传递参数初始化支付类</span>
        alipay =<span style="color: #000000"><span style="background-color: #ff99cc"> AliPay</span>(
            appid</span>=<span style="color: #800000">"</span><span style="color: #800000">2016080800192023</span><span style="color: #800000">"</span>,  <span style="color: #008000">#</span><span style="color: #008000"> 设置签约的appid</span>
            app_notify_url=<span style="color: #800000">"</span><span style="color: #800000">http://47.52.39.160:8000/alipa/</span><span style="color: #800000">"</span>,  <span style="color: #008000">#</span><span style="color: #008000"> 异步支付通知url</span>
            app_private_key_path=ying_yong_si_yao,  <span style="color: #008000">#</span><span style="color: #008000"> 设置应用私钥</span>
            alipay_public_key_path=zhi_fu_bao_gong_yao,  <span style="color: #008000">#</span><span style="color: #008000"> 支付宝的公钥，验证支付宝回传消息使用，不是你自己的公钥,</span>
            debug=True,  <span style="color: #008000">#</span><span style="color: #008000"> 默认False,                                   # 设置是否是沙箱环境，True是沙箱环境</span>
            return_url=<span style="color: #800000">"</span><span style="color: #800000">http://47.52.39.160:8000/alipa/</span><span style="color: #800000">"</span>  <span style="color: #008000">#</span><span style="color: #008000"> 同步支付通知url，跳转地址</span>
<span style="color: #000000">        )

        </span><span style="color: #008000">#</span><span style="color: #008000"> 验证支付宝返回的合法性</span>
        yan_zhen =<span style="color: #000000"> alipay.verify(processed_dict, sign)
        </span><span style="color: #0000ff">if</span> yan_zhen <span style="color: #0000ff">is</span> True:  <span style="color: #008000">#</span><span style="color: #008000"> 判断如果合法</span>
            out_trade_no = processed_dict.get(<span style="color: #800000">'</span><span style="color: #800000">out_trade_no</span><span style="color: #800000">'</span>, None)  <span style="color: #008000">#</span><span style="color: #008000"> 商户订单号</span>
            trade_no = processed_dict.get(<span style="color: #800000">'</span><span style="color: #800000">trade_no</span><span style="color: #800000">'</span>, None)  <span style="color: #008000">#</span><span style="color: #008000"> 支付宝交易号</span>
            buyer_id = processed_dict.get(<span style="color: #800000">'</span><span style="color: #800000">buyer_id</span><span style="color: #800000">'</span>, None)  <span style="color: #008000">#</span><span style="color: #008000"> 买家支付宝用户号</span>
            trade_status = processed_dict.get(<span style="color: #800000">'</span><span style="color: #800000">trade_status</span><span style="color: #800000">'</span>, None)  <span style="color: #008000">#</span><span style="color: #008000"> 交易状态</span>
            total_amount = processed_dict.get(<span style="color: #800000">'</span><span style="color: #800000">total_amount</span><span style="color: #800000">'</span>, None)  <span style="color: #008000">#</span><span style="color: #008000"> 订单金额</span>
            receipt_amount = processed_dict.get(<span style="color: #800000">'</span><span style="color: #800000">receipt_amount</span><span style="color: #800000">'</span>, None)  <span style="color: #008000">#</span><span style="color: #008000"> 实收金额</span>
            subject = processed_dict.get(<span style="color: #800000">'</span><span style="color: #800000">subject</span><span style="color: #800000">'</span>, None)  <span style="color: #008000">#</span><span style="color: #008000"> 订单标题</span>
            gmt_payment = processed_dict.get(<span style="color: #800000">'</span><span style="color: #800000">gmt_payment</span><span style="color: #800000">'</span>, None)  <span style="color: #008000">#</span><span style="color: #008000"> 交易付款时间</span>

            <span style="color: #008000">#</span><span style="color: #008000"> 数据库操作</span>
            <span style="color: #0000ff">print</span><span style="color: #000000">(out_trade_no)
            </span><span style="color: #0000ff">print</span><span style="color: #000000">(trade_no)
            </span><span style="color: #0000ff">print</span><span style="color: #000000">(buyer_id)
            </span><span style="color: #0000ff">print</span><span style="color: #000000">(trade_status)
            </span><span style="color: #0000ff">print</span><span style="color: #000000">(total_amount)
            </span><span style="color: #0000ff">print</span><span style="color: #000000">(receipt_amount)
            </span><span style="color: #0000ff">print</span><span style="color: #000000">(subject)
            </span><span style="color: #0000ff">print</span><span style="color: #000000">(gmt_payment)

            </span><span style="color: #008000">#</span><span style="color: #008000"> 向支付宝返回success，告诉他我们已经处理，不然他会不停的通知</span>
            <span style="color: #0000ff">return</span> HttpResponse(<span style="color: #800000">'</span><span style="color: #800000">success</span><span style="color: #800000">'</span><span style="color: #000000">)

    </span></span><span style="background-color: #ffcc99"><span style="color: #0000ff">if</span> request.method == <span style="color: #800000">"</span><span style="color: #800000">POST</span><span style="color: #800000">"</span>:                        <span style="color: #008000">#</span><span style="color: #008000"> post请求支付宝异步通知</span>
        processed_dict = {}                             <span style="color: #008000">#</span><span style="color: #008000"> 接收支付宝传递参数</span>
        <span style="color: #0000ff">for</span> key, value <span style="color: #0000ff">in</span> request.POST.items():         <span style="color: #008000">#</span><span style="color: #008000"> 循环参数</span>
            processed_dict[key] = value                 <span style="color: #008000">#</span><span style="color: #008000"> 将参数添加到字典</span>
        sign = processed_dict.pop(<span style="color: #800000">'</span><span style="color: #800000">sign</span><span style="color: #800000">'</span>, None)         <span style="color: #008000">#</span><span style="color: #008000"> 单独拿出sign字段</span>

        <span style="color: #008000">#</span><span style="color: #008000"> 传递参数初始化支付类</span>
        alipay =<span style="color: #000000"><span style="background-color: #ff99cc"> AliPay</span>(
            appid</span>=<span style="color: #800000">"</span><span style="color: #800000">2016080800192023</span><span style="color: #800000">"</span>,                                   <span style="color: #008000">#</span><span style="color: #008000"> 设置签约的appid</span>
            app_notify_url=<span style="color: #800000">"</span><span style="color: #800000">http://47.52.39.160:8000/alipa/</span><span style="color: #800000">"</span>,           <span style="color: #008000">#</span><span style="color: #008000"> 异步支付通知url</span>
            app_private_key_path=ying_yong_si_yao,                      <span style="color: #008000">#</span><span style="color: #008000"> 设置应用私钥</span>
            alipay_public_key_path=zhi_fu_bao_gong_yao,                 <span style="color: #008000">#</span><span style="color: #008000"> 支付宝的公钥，验证支付宝回传消息使用，不是你自己的公钥,</span>
            debug=True,  <span style="color: #008000">#</span><span style="color: #008000"> 默认False,                                   # 设置是否是沙箱环境，True是沙箱环境</span>
            return_url=<span style="color: #800000">"</span><span style="color: #800000">http://47.52.39.160:8000/alipa/</span><span style="color: #800000">"</span>                <span style="color: #008000">#</span><span style="color: #008000"> 同步支付通知url</span>
<span style="color: #000000">        )

        </span><span style="color: #008000">#</span><span style="color: #008000"> 验证支付宝返回的合法性</span>
        yan_zhen =<span style="color: #000000"> alipay.verify(processed_dict, sign)
        </span><span style="color: #0000ff">if</span> yan_zhen <span style="color: #0000ff">is</span> True:                                                <span style="color: #008000">#</span><span style="color: #008000"> 判断如果合法</span>
            out_trade_no = processed_dict.get(<span style="color: #800000">'</span><span style="color: #800000">out_trade_no</span><span style="color: #800000">'</span>, None)         <span style="color: #008000">#</span><span style="color: #008000"> 商户订单号</span>
            trade_no = processed_dict.get(<span style="color: #800000">'</span><span style="color: #800000">trade_no</span><span style="color: #800000">'</span>, None)                 <span style="color: #008000">#</span><span style="color: #008000"> 支付宝交易号</span>
            buyer_id = processed_dict.get(<span style="color: #800000">'</span><span style="color: #800000">buyer_id</span><span style="color: #800000">'</span>, None)                 <span style="color: #008000">#</span><span style="color: #008000"> 买家支付宝用户号</span>
            trade_status = processed_dict.get(<span style="color: #800000">'</span><span style="color: #800000">trade_status</span><span style="color: #800000">'</span>, None)         <span style="color: #008000">#</span><span style="color: #008000"> 交易状态</span>
            total_amount = processed_dict.get(<span style="color: #800000">'</span><span style="color: #800000">total_amount</span><span style="color: #800000">'</span>, None)         <span style="color: #008000">#</span><span style="color: #008000"> 订单金额</span>
            receipt_amount = processed_dict.get(<span style="color: #800000">'</span><span style="color: #800000">receipt_amount</span><span style="color: #800000">'</span>, None)     <span style="color: #008000">#</span><span style="color: #008000"> 实收金额</span>
            subject = processed_dict.get(<span style="color: #800000">'</span><span style="color: #800000">subject</span><span style="color: #800000">'</span>, None)                   <span style="color: #008000">#</span><span style="color: #008000"> 订单标题</span>
            gmt_payment = processed_dict.get(<span style="color: #800000">'</span><span style="color: #800000">gmt_payment</span><span style="color: #800000">'</span>, None)           <span style="color: #008000">#</span><span style="color: #008000"> 交易付款时间</span>

            <span style="color: #008000">#</span><span style="color: #008000"> 数据库操作</span>
            <span style="color: #0000ff">print</span><span style="color: #000000">(out_trade_no)
            </span><span style="color: #0000ff">print</span><span style="color: #000000">(trade_no)
            </span><span style="color: #0000ff">print</span><span style="color: #000000">(buyer_id)
            </span><span style="color: #0000ff">print</span><span style="color: #000000">(trade_status)
            </span><span style="color: #0000ff">print</span><span style="color: #000000">(total_amount)
            </span><span style="color: #0000ff">print</span><span style="color: #000000">(receipt_amount)
            </span><span style="color: #0000ff">print</span><span style="color: #000000">(subject)
            </span><span style="color: #0000ff">print</span><span style="color: #000000">(gmt_payment)

            </span><span style="color: #008000">#</span><span style="color: #008000"> 向支付宝返回success，告诉他我们已经处理，不然他会不停的通知</span>
            <span style="color: #0000ff">return</span> HttpResponse(<span style="color: #800000">'</span><span style="color: #800000">success</span><span style="color: #800000">'</span>)</span></pre>
</div>
<p>&nbsp;</p>
<p>WAIT_BUYER_PAY 交易创建，等待买家付款<br>TRADE_CLOSED	未付款交易超时关闭，或支付完成后全额退款<br>TRADE_SUCCESS	交易支付成功<br>TRADE_FINISHED	交易结束，不可退款</p></div>