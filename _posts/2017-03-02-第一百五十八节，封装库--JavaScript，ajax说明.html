第一百五十八节，封装库--JavaScript，ajax说明


			<div id="cnblogs_post_body" class="blogpost-body"><p><span style="color: #0000ff"><strong>封装库--JavaScript，ajax说明</strong></span></p>
<p><span style="color: #0000ff"><strong><strong>封装库</strong>ajax()方法，ajax通讯方法，跨页面向动态页面发送或获取数据</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">/*</span><span style="color: #008000">* ajax()方法，ajax通讯方法，跨页面向动态页面发送或获取数据
 *  参数是一个对象{}，如下
 *  $().ajax({
            method:'post',                  【method】属性，通讯模式，post为post模式，get为get模式
            url:'hj.php',                   【url】属性，发送数据或请求数据的url地址
            data:{                          【data】属性，是发送内容，是一个对象，里面是键值对形式的发送数据对象
                'name':'lee',
                'age':100
            },
            success:function (text) {       【success】属性，是一个回调函数，函数参数是text，会接收到发送或者获取到的数据
                alert(text);
            },
            async:true                      【async】属性，请求方式，true异步方式，false同步方式
        });
 *</span><span style="color: #008000">*/</span><span style="color: #000000">
feng_zhuang_ku.prototype.ajax </span>= <span style="color: #0000ff">function</span><span style="color: #000000"> (obj) {
    </span><span style="color: #008000">//</span><span style="color: #008000">创建XHR对象</span>
    <span style="color: #0000ff">var</span> xhr = (<span style="color: #0000ff">function</span><span style="color: #000000"> () {
        </span><span style="color: #0000ff">if</span> (<span style="color: #0000ff">typeof</span> XMLHttpRequest != 'undefined') {           <span style="color: #008000">//</span><span style="color: #008000">判断是否可以直接创建XHR对象，w3c</span>
            <span style="color: #0000ff">return</span> <span style="color: #0000ff">new</span> XMLHttpRequest();                      <span style="color: #008000">//</span><span style="color: #008000">如果可以就直接创建XHR对象</span>
        } <span style="color: #0000ff">else</span> <span style="color: #0000ff">if</span> (<span style="color: #0000ff">typeof</span> ActiveXObject != 'undefined') {     <span style="color: #008000">//</span><span style="color: #008000">判断IE低版本的3种模式是否支持</span>
            <span style="color: #0000ff">var</span> version =<span style="color: #000000"> [
                </span>'MSXML2.XMLHttp.6.0'<span style="color: #000000">,
                </span>'MSXML2.XMLHttp.3.0'<span style="color: #000000">,
                </span>'MSXML2.XMLHttp'<span style="color: #000000">
            ];
            </span><span style="color: #0000ff">for</span> (<span style="color: #0000ff">var</span> i = 0; version.length; i++<span style="color: #000000">) {
                </span><span style="color: #0000ff">try</span><span style="color: #000000"> {
                    </span><span style="color: #0000ff">return</span> <span style="color: #0000ff">new</span><span style="color: #000000"> ActiveXObject(version[i]);
                } </span><span style="color: #0000ff">catch</span><span style="color: #000000"> (e) {
                    </span><span style="color: #008000">//</span><span style="color: #008000">跳过</span>
<span style="color: #000000">                }
            }
        } </span><span style="color: #0000ff">else</span><span style="color: #000000"> {
            </span><span style="color: #0000ff">throw</span> <span style="color: #0000ff">new</span> Error('您的系统或浏览器不支持XHR对象！');   <span style="color: #008000">//</span><span style="color: #008000">如果都不支持报错</span>
<span style="color: #000000">        }
    })();  </span><span style="color: #008000">//</span><span style="color: #008000">自我执行闭包里的函数,创建XHR对象</span>

    <span style="color: #008000">//</span><span style="color: #008000">接收对象url地址</span>
    obj.url = obj.url + '?rand=' + Math.random();                 <span style="color: #008000">//</span><span style="color: #008000">组合对象传进来的通讯url地址</span>

    <span style="color: #008000">//</span><span style="color: #008000">接收对象传来的内容，进行名值对编码</span>
    obj.data = (<span style="color: #0000ff">function</span><span style="color: #000000"> (data) {
        </span><span style="color: #0000ff">var</span> arr =<span style="color: #000000"> [];
        </span><span style="color: #0000ff">for</span> (<span style="color: #0000ff">var</span> i <span style="color: #0000ff">in</span><span style="color: #000000"> data) {
            arr.push(encodeURIComponent(i) </span>+ '=' +<span style="color: #000000"> encodeURIComponent(data[i]));
        }
        </span><span style="color: #0000ff">return</span> arr.join('&amp;');  <span style="color: #008000">//</span><span style="color: #008000">将数组格式化分隔符后返回</span>
    })(obj.data);  <span style="color: #008000">//</span><span style="color: #008000">自我执行闭包里的函数</span>

    <span style="color: #008000">//</span><span style="color: #008000">判断请求方式来</span>
    <span style="color: #0000ff">if</span> (obj.method === 'get') obj.url += obj.url.indexOf('?') == -1 ? '?' + obj.data : '&amp;' +<span style="color: #000000"> obj.data;

    </span><span style="color: #008000">//</span><span style="color: #008000">判断发送模式如果是异步</span>
    <span style="color: #0000ff">if</span> (obj.async === <span style="color: #0000ff">true</span><span style="color: #000000">) {
        </span><span style="color: #008000">//</span><span style="color: #008000">添加一个加载事件</span>
        xhr.onreadystatechange = <span style="color: #0000ff">function</span><span style="color: #000000"> () {
            </span><span style="color: #008000">//</span><span style="color: #008000">判断已经接受到全部响应数据，而且可以使用</span>
            <span style="color: #0000ff">if</span> (xhr.readyState == 4<span style="color: #000000">) {
                callback();
            }
        };
    }
    xhr.open(obj.method, obj.url, obj.async);
    </span><span style="color: #0000ff">if</span> (obj.method === 'post'<span style="color: #000000">) {
        xhr.setRequestHeader(</span>'Content-Type', 'application/x-www-form-urlencoded'<span style="color: #000000">);
        xhr.send(obj.data);
    } </span><span style="color: #0000ff">else</span><span style="color: #000000"> {
        xhr.send(</span><span style="color: #0000ff">null</span><span style="color: #000000">);
    }
    </span><span style="color: #0000ff">if</span> (obj.async === <span style="color: #0000ff">false</span><span style="color: #000000">) {
        callback();
    }
    </span><span style="color: #0000ff">function</span><span style="color: #000000"> callback() {
        </span><span style="color: #0000ff">if</span> (xhr.status == 200<span style="color: #000000">) {
            obj.success(xhr.responseText);            </span><span style="color: #008000">//</span><span style="color: #008000">回调传递参数</span>
        } <span style="color: #0000ff">else</span><span style="color: #000000"> {
            alert(</span>'获取数据错误！错误代号：' + xhr.status + '，错误信息：' +<span style="color: #000000"> xhr.statusText);
        }
    }
    </span><span style="color: #0000ff">return</span> <span style="color: #0000ff">this</span><span style="color: #000000">;
};</span></pre>
</div>
<p>前台js</p>
<div class="cnblogs_code">
<pre><span style="color: #008000">//</span><span style="color: #008000">调用ajax</span>
    $(document).on_click(<span style="color: #0000ff">function</span><span style="color: #000000"> () {
        $().ajax({
            method:</span>'post'<span style="color: #000000">,
            url:</span>'hj.php'<span style="color: #000000">,
            data:{
                </span>'name':'lee'<span style="color: #000000">,
                </span>'age':100<span style="color: #000000">
            },
            success:</span><span style="color: #0000ff">function</span><span style="color: #000000"> (text) {
                alert(text);
            },
            async:</span><span style="color: #0000ff">true</span><span style="color: #000000">
        });
    });</span></pre>
</div>
<p>通讯数据url地址hj.php</p>
<div class="cnblogs_code">
<pre>&lt;?<span style="color: #000000">php
  </span><span style="color: #0000ff">echo</span> 'www.jxiou.com'<span style="color: #000000">;
  </span><span style="color: #008080">print_r</span>(<span style="color: #800080">$_POST</span><span style="color: #000000">);
</span>?&gt;</pre>
</div>
<p>最终回调显示</p>
<p><img src="https://images2015.cnblogs.com/blog/955761/201703/955761-20170302220215235-348005853.png" alt=""></p></div>