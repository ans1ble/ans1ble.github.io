第三百三十五节，web爬虫讲解2—Scrapy框架爬虫—豆瓣登录与利用打码接口实现自动识别验证码


			<div id="cnblogs_post_body" class="blogpost-body"><p><strong>第三百三十五节，web爬虫讲解2—Scrapy框架爬虫—豆瓣登录与利用打码接口实现自动识别验证码</strong></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>打码接口文件</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000"> -*- coding: cp936 -*-</span>

<span style="color: #0000ff">import</span><span style="color: #000000"> sys
</span><span style="color: #0000ff">import</span><span style="color: #000000"> os
</span><span style="color: #0000ff">from</span> ctypes <span style="color: #0000ff">import</span> *

<span style="color: #008000">#</span><span style="color: #008000"> 下载接口放目录 http://www.yundama.com/apidoc/YDM_SDK.html</span><span style="color: #008000">
#</span><span style="color: #008000"> 错误代码请查询 http://www.yundama.com/apidoc/YDM_ErrorCode.html</span><span style="color: #008000">
#</span><span style="color: #008000"> 所有函数请查询 http://www.yundama.com/apidoc</span>

<span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">&gt;&gt;&gt;正在初始化...</span><span style="color: #800000">'</span><span style="color: #000000">)

YDMApi </span>= windll.LoadLibrary(<span style="color: #800000">'</span><span style="color: #800000">H:/py/16/adc/adc/yamzhm/yundamaAPI-x64</span><span style="color: #800000">'</span><span style="color: #000000">)

</span><span style="color: #008000">#</span><span style="color: #008000"> 1. http://www.yundama.com/index/reg/developer 注册开发者账号</span><span style="color: #008000">
#</span><span style="color: #008000"> 2. http://www.yundama.com/developer/myapp 添加新软件</span><span style="color: #008000">
#</span><span style="color: #008000"> 3. 使用添加的软件ID和密钥进行开发，享受丰厚分成</span>
<span style="background-color: #ff99cc"><span style="color: #000000">
appId </span>= 3818   <span style="color: #008000">#</span><span style="color: #008000"> 软件ＩＤ，开发者分成必要参数。登录开发者后台【我的软件】获得！</span>
appKey = b<span style="color: #800000">'</span><span style="color: #800000">6ff56e09e89fffe45c14abe624af9456</span><span style="color: #800000">'</span>     <span style="color: #008000">#</span><span style="color: #008000"> 软件密钥，开发者分成必要参数。登录开发者后台【我的软件】获得！</span></span>

<span style="color: #008000">#</span><span style="color: #008000"> print('软件ＩＤ：%d\r\n软件密钥：%s' % (appId, appKey))</span>

<span style="color: #008000">#</span><span style="color: #008000"> 注意这里是普通会员账号，不是开发者账号，注册地址 http://www.yundama.com/index/reg/user</span><span style="color: #008000">
#</span><span style="color: #008000"> 开发者可以联系客服领取免费调试题分</span>
<span style="background-color: #ff99cc"><span style="color: #000000">
username </span>= b<span style="color: #800000">'</span><span style="color: #800000">adc8868</span><span style="color: #800000">'</span><span style="color: #000000">
password </span>= b<span style="color: #800000">'</span><span style="color: #800000">adc279819</span><span style="color: #800000">'</span></span>

<span style="color: #0000ff">if</span> username == b<span style="color: #800000">'</span><span style="color: #800000">test</span><span style="color: #800000">'</span><span style="color: #000000">:
    exit(</span><span style="color: #800000">'</span><span style="color: #800000">\r\n&gt;&gt;&gt;请先设置用户名密码</span><span style="color: #800000">'</span><span style="color: #000000">)
    
</span><span style="color: #008000">#</span><span style="color: #008000">###################### 一键识别函数 YDM_EasyDecodeByPath #######################</span>

<span style="color: #008000">#</span><span style="color: #008000"> print('\r\n&gt;&gt;&gt;正在一键识别...')</span><span style="color: #008000">
#
#</span><span style="color: #008000"> # 例：1004表示4位字母数字，不同类型收费不同。请准确填写，否则影响识别率。在此查询所有类型 http://www.yundama.com/price.html</span><span style="color: #008000">
#</span><span style="color: #008000"> codetype = 1004</span><span style="color: #008000">
#
#</span><span style="color: #008000"> # 分配30个字节存放识别结果</span><span style="color: #008000">
#</span><span style="color: #008000"> result = c_char_p(b"                              ")</span><span style="color: #008000">
#
#</span><span style="color: #008000"> # 识别超时时间 单位：秒</span><span style="color: #008000">
#</span><span style="color: #008000"> timeout = 60</span><span style="color: #008000">
#
#</span><span style="color: #008000"> # 验证码文件路径</span><span style="color: #008000">
#</span><span style="color: #008000"> filename = b'H:/py/16/adc/adc/yamzhm/yan_zhe_nma.jpg'</span><span style="color: #008000">
#
#</span><span style="color: #008000"> # 一键识别函数，无需调用 YDM_SetAppInfo 和 YDM_Login，适合脚本调用</span><span style="color: #008000">
#</span><span style="color: #008000"> captchaId = YDMApi.YDM_EasyDecodeByPath(username, password, appId, appKey, filename, codetype, timeout, result)</span><span style="color: #008000">
#
#</span><span style="color: #008000"> print("一键识别：验证码ID：%d，识别结果：%s" % (captchaId, result.value))</span>

<span style="color: #008000">#</span><span style="color: #008000">###############################################################################</span>


<span style="color: #008000">#</span><span style="color: #008000">######################### 普通识别函数 YDM_DecodeByPath #########################</span>



<span style="background-color: #ff99cc"><span style="color: #008000">#</span><span style="color: #008000"> print('\r\n&gt;&gt;&gt;正在登陆...')</span>

<span style="color: #008000">#</span><span style="color: #008000"> 第一步：初始化云打码，只需调用一次即可</span>
<span style="color: #000000">YDMApi.YDM_SetAppInfo(appId, appKey)

</span><span style="color: #008000">#</span><span style="color: #008000"> 第二步：登陆云打码账号，只需调用一次即可</span>
uid =<span style="color: #000000"> YDMApi.YDM_Login(username, password)

</span><span style="color: #0000ff">if</span> uid &gt;<span style="color: #000000"> 0:

    </span><span style="color: #008000">#</span><span style="color: #008000"> print('&gt;&gt;&gt;正在获取余额...')</span>
    
    <span style="color: #008000">#</span><span style="color: #008000"> 查询账号余额，按需要调用</span>
    balance =<span style="color: #000000"> YDMApi.YDM_GetBalance(username, password)

    </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">登陆成功，用户名：%s，剩余题分：%d</span><span style="color: #800000">'</span> %<span style="color: #000000"> (username, balance))

    </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">\r\n&gt;&gt;&gt;正在普通识别...</span><span style="color: #800000">'</span><span style="color: #000000">)

    </span><span style="color: #008000">#</span><span style="color: #008000"> 第三步：开始识别</span>

    <span style="color: #008000">#</span><span style="color: #008000"> 例：1004表示4位字母数字，不同类型收费不同。请准确填写，否则影响识别率。在此查询所有类型 http://www.yundama.com/price.html</span>
    codetype = 3000

    <span style="color: #008000">#</span><span style="color: #008000"> 分配30个字节存放识别结果</span>
    result = c_char_p(b<span style="color: #800000">"</span>                              <span style="color: #800000">"</span><span style="color: #000000">)

    </span><span style="color: #008000">#</span><span style="color: #008000"> 验证码文件路径</span>
    filename = b<span style="color: #800000">'</span><span style="color: #800000">H:/py/16/adc/adc/yamzhm/yan_zhe_nma.jpg</span><span style="color: #800000">'</span>

    <span style="color: #008000">#</span><span style="color: #008000"> 普通识别函数，需先调用 YDM_SetAppInfo 和 YDM_Login 初始化</span>
    captchaId =<span style="color: #000000"> YDMApi.YDM_DecodeByPath(filename, codetype, result)

    </span><span style="color: #0000ff">print</span>(<span style="color: #800000">"</span><span style="color: #800000">普通识别：验证码ID：%d，识别结果：%s</span><span style="color: #800000">"</span> %<span style="color: #000000"> (<span style="background-color: #ffff00">captchaId, result.value</span>))

</span><span style="color: #0000ff">else</span><span style="color: #000000">:
    </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">登陆失败，错误代码：%d</span><span style="color: #800000">'</span> %<span style="color: #000000"> uid)

</span></span><span style="color: #008000">#</span><span style="color: #008000">###############################################################################</span>

<span style="color: #008000">#</span><span style="color: #008000"> print('\r\n&gt;&gt;&gt;错误代码请查询 http://www.yundama.com/apidoc/YDM_ErrorCode.html')</span>

<span style="color: #008000">#</span><span style="color: #008000"> input('\r\n测试完成，按回车键结束...')</span></pre>
</div>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>实现文件</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000"> -*- coding: utf-8 -*-</span>
<span style="color: #0000ff">import</span><span style="color: #000000"> os
</span><span style="color: #0000ff">from</span> urllib <span style="color: #0000ff">import</span> request                     <span style="color: #008000">#</span><span style="color: #008000">导入request模块</span>

<span style="color: #0000ff">import</span><span style="color: #000000"> scrapy
</span><span style="color: #0000ff">from</span> scrapy.http <span style="color: #0000ff">import</span><span style="color: #000000"> Request,FormRequest


</span><span style="color: #0000ff">class</span> PachSpider(scrapy.Spider):                            <span style="color: #008000">#</span><span style="color: #008000">定义爬虫类，必须继承scrapy.Spider</span>
    name = <span style="color: #800000">'</span><span style="color: #800000">pach</span><span style="color: #800000">'</span>                                           <span style="color: #008000">#</span><span style="color: #008000">设置爬虫名称</span>
    allowed_domains = [<span style="color: #800000">'</span><span style="color: #800000">douban.com</span><span style="color: #800000">'</span>]                    <span style="color: #008000">#</span><span style="color: #008000">爬取域名</span>
    <span style="color: #008000">#</span><span style="color: #008000"> start_urls = ['']                                     #爬取网址,只适于不需要登录的请求，因为没法设置cookie等信息</span>
<span style="color: #000000">
    header </span>= {<span style="color: #800000">'</span><span style="color: #800000">User-Agent</span><span style="color: #800000">'</span>:<span style="color: #800000">'</span><span style="color: #800000">Mozilla/5.0 (Windows NT 10.0; WOW64; rv:54.0) Gecko/20100101 Firefox/54.0</span><span style="color: #800000">'</span>}  <span style="color: #008000">#</span><span style="color: #008000">设置浏览器用户代理</span>

    <span style="color: #0000ff">def</span><span style="color: #000000"> start_requests(self):
        </span><span style="color: #800000">"""</span><span style="color: #800000">第一次请求一下登录页面，设置开启cookie使其得到cookie，设置回调函数</span><span style="color: #800000">"""</span>
        <span style="color: #0000ff">print</span>(<span style="color: #800000">"</span><span style="color: #800000">第一次请求页面获取Cookies.........!</span><span style="color: #800000">"</span><span style="color: #000000">)
        </span><span style="color: #0000ff">return</span> [Request(<span style="color: #800000">'</span><span style="color: #800000">https://accounts.douban.com/login</span><span style="color: #800000">'</span>,meta={<span style="color: #800000">'</span><span style="color: #800000">cookiejar</span><span style="color: #800000">'</span>:1},callback=self.parse,headers=<span style="color: #000000">self.header)]


    </span><span style="color: #0000ff">def</span><span style="color: #000000"> parse(self, response):
        </span><span style="color: #008000">#</span><span style="color: #008000"> 响应Cookies</span>
        Cookie1 = response.headers.getlist(<span style="color: #800000">'</span><span style="color: #800000">Set-Cookie</span><span style="color: #800000">'</span>)                            <span style="color: #008000">#</span><span style="color: #008000">查看一下响应Cookie，也就是第一次访问注册页面时后台写入浏览器的Cookie</span>
        <span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">后台首次写入的响应Cookies：</span><span style="color: #800000">'</span><span style="color: #000000">,Cookie1)

        </span><span style="color: #008000">#</span><span style="color: #008000">判断是否出现验证码</span>
<span style="background-color: #ff99cc">        yzhm = response.xpath(<span style="color: #800000">'</span><span style="color: #800000">//img[@id="captcha_image"]/@src</span><span style="color: #800000">'</span><span style="color: #000000">).extract()
        </span><span style="background-color: #ffff00"><span style="color: #0000ff">if</span> len(yzhm) &gt;<span style="color: #000000"> 0:
            </span><span style="color: #0000ff">print</span>(<span style="color: #800000">"</span><span style="color: #800000">出现验证码，请输入验证码</span><span style="color: #800000">"</span><span style="color: #000000">)
            </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">验证码图片地址：</span><span style="color: #800000">'</span><span style="color: #000000">,yzhm)
            </span><span style="color: #008000">#</span><span style="color: #008000">将验证码图片保存到本地</span>
            file_path = os.path.join(os.getcwd() + <span style="color: #800000">'</span><span style="color: #800000">/adc/yamzhm/yan_zhe_nma.jpg</span><span style="color: #800000">'</span>)   <span style="color: #008000">#</span><span style="color: #008000"> 拼接图片保存路径</span>
            <span style="color: #0000ff">print</span><span style="color: #000000">(file_path)
            request.urlretrieve(yzhm[0], file_path)                             </span><span style="color: #008000">#</span><span style="color: #008000"> 将图片保存到本地，参数1获取到的src，参数2保存路径</span>

            <span style="color: #008000">#</span><span style="color: #008000">使用在线打码，自动识别验证码</span>
<span style="background-color: #ccffcc">            <span style="color: #0000ff">from</span> adc.yamzhm <span style="color: #0000ff">import</span> YDMPython3                                   <span style="color: #008000">#</span><span style="color: #008000">导入打码模块</span>
            yan_zhen_ma = str(YDMPython3.result.value,encoding=<span style="color: #800000">'</span><span style="color: #800000">utf-8</span><span style="color: #800000">'</span>)         <span style="color: #008000">#</span><span style="color: #008000">接收打码结果</span>
            <span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">写入验证码</span><span style="color: #800000">'</span></span><span style="color: #000000"><span style="background-color: #ccffcc">,yan_zhen_ma)</span>

            data </span>= {                                                            <span style="color: #008000">#</span><span style="color: #008000"> 设置用户登录信息，对应抓包得到字段</span>
                <span style="color: #800000">'</span><span style="color: #800000">source</span><span style="color: #800000">'</span>: <span style="color: #800000">'</span><span style="color: #800000">None</span><span style="color: #800000">'</span><span style="color: #000000">,
                </span><span style="color: #800000">'</span><span style="color: #800000">redir</span><span style="color: #800000">'</span>: <span style="color: #800000">'</span><span style="color: #800000">https://www.douban.com/people/81309370/</span><span style="color: #800000">'</span><span style="color: #000000">,
                </span><span style="color: #800000">'</span><span style="color: #800000">form_email</span><span style="color: #800000">'</span>: <span style="color: #800000">'</span><span style="color: #800000">729088188@qq.com</span><span style="color: #800000">'</span><span style="color: #000000">,
                </span><span style="color: #800000">'</span><span style="color: #800000">form_password</span><span style="color: #800000">'</span>: <span style="color: #800000">'</span><span style="color: #800000">adc279819</span><span style="color: #800000">'</span><span style="color: #000000">,
                </span><span style="color: #800000">'</span><span style="color: #800000">login</span><span style="color: #800000">'</span>: <span style="color: #800000">'</span><span style="color: #800000">登录</span><span style="color: #800000">'</span><span style="color: #000000">,
                </span><span style="color: #800000">'</span><span style="color: #800000">captcha-solution</span><span style="color: #800000">'</span><span style="color: #000000">: yan_zhen_ma
            }

            </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">第二次post请求携带Cookies授权，登录中........!</span><span style="color: #800000">'</span><span style="color: #000000">)

            </span><span style="color: #800000">"""</span><span style="color: #800000">第二次用表单post请求，携带Cookie、浏览器代理、用户登录信息，进行登录给Cookie授权</span><span style="color: #800000">"""</span>
            <span style="color: #0000ff">return</span><span style="color: #000000"> [FormRequest.from_response(response,
                                              url</span>=<span style="color: #800000">'</span><span style="color: #800000">https://accounts.douban.com/login</span><span style="color: #800000">'</span>,                        <span style="color: #008000">#</span><span style="color: #008000">真实post地址</span>
                                              meta={<span style="color: #800000">'</span><span style="color: #800000">cookiejar</span><span style="color: #800000">'</span>:response.meta[<span style="color: #800000">'</span><span style="color: #800000">cookiejar</span><span style="color: #800000">'</span><span style="color: #000000">]},
                                              headers</span>=<span style="color: #000000">self.header,
                                              formdata</span>=<span style="color: #000000">data,
                                              callback</span>=<span style="color: #000000">self.next,
                                              )]
        </span></span><span style="color: #0000ff">else</span><span style="color: #000000">:
<span style="background-color: #ccffff">            data </span></span><span style="background-color: #ccffff">= {  <span style="color: #008000">#</span><span style="color: #008000"> 设置用户登录信息，对应抓包得到字段</span>
                <span style="color: #800000">'</span><span style="color: #800000">source</span><span style="color: #800000">'</span>: <span style="color: #800000">'</span><span style="color: #800000">None</span><span style="color: #800000">'</span><span style="color: #000000">,
                </span><span style="color: #800000">'</span><span style="color: #800000">redir</span><span style="color: #800000">'</span>: <span style="color: #800000">'</span><span style="color: #800000">https://www.douban.com/people/81309370/</span><span style="color: #800000">'</span><span style="color: #000000">,
                </span><span style="color: #800000">'</span><span style="color: #800000">form_email</span><span style="color: #800000">'</span>: <span style="color: #800000">'</span><span style="color: #800000">729088188@qq.com</span><span style="color: #800000">'</span><span style="color: #000000">,
                </span><span style="color: #800000">'</span><span style="color: #800000">form_password</span><span style="color: #800000">'</span>: <span style="color: #800000">'</span><span style="color: #800000">adc279819</span><span style="color: #800000">'</span><span style="color: #000000">,
                </span><span style="color: #800000">'</span><span style="color: #800000">login</span><span style="color: #800000">'</span>: <span style="color: #800000">'</span><span style="color: #800000">登录</span><span style="color: #800000">'</span><span style="color: #000000">,
            }

            </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">第二次post请求携带Cookies授权，登录中........!</span><span style="color: #800000">'</span><span style="color: #000000">)

            </span><span style="color: #800000">"""</span><span style="color: #800000">第二次用表单post请求，携带Cookie、浏览器代理、用户登录信息，进行登录给Cookie授权</span><span style="color: #800000">"""</span>
            <span style="color: #0000ff">return</span><span style="color: #000000"> [FormRequest.from_response(response,
                                              url</span>=<span style="color: #800000">'</span><span style="color: #800000">https://accounts.douban.com/login</span><span style="color: #800000">'</span>,  <span style="color: #008000">#</span><span style="color: #008000"> 真实post地址</span>
                                              meta={<span style="color: #800000">'</span><span style="color: #800000">cookiejar</span><span style="color: #800000">'</span>: response.meta[<span style="color: #800000">'</span><span style="color: #800000">cookiejar</span><span style="color: #800000">'</span><span style="color: #000000">]},
                                              headers</span>=<span style="color: #000000">self.header,
                                              formdata</span>=<span style="color: #000000">data,
                                              callback</span>=<span style="color: #000000">self.next,
                                              )]



    </span></span></span><span style="color: #0000ff">def</span><span style="color: #000000"> next(self,response):
        </span><span style="color: #008000">#</span><span style="color: #008000"> 请求Cookie</span>
        Cookie2 = response.request.headers.getlist(<span style="color: #800000">'</span><span style="color: #800000">Cookie</span><span style="color: #800000">'</span><span style="color: #000000">)
        </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">登录时携带请求的Cookies：</span><span style="color: #800000">'</span><span style="color: #000000">,Cookie2)

        dlujieg </span>= response.xpath(<span style="color: #800000">'</span><span style="color: #800000">/html/head/title/text()</span><span style="color: #800000">'</span><span style="color: #000000">).extract()
        </span><span style="color: #0000ff">if</span><span style="color: #000000"> dlujieg:
            </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">登录响应结果：</span><span style="color: #800000">'</span><span style="color: #000000">,dlujieg)
        </span><span style="color: #0000ff">else</span><span style="color: #000000">:
            jieg </span>= response.body.decode(<span style="color: #800000">"</span><span style="color: #800000">utf-8</span><span style="color: #800000">"</span>)   <span style="color: #008000">#</span><span style="color: #008000">登录后可以查看一下登录响应信息</span>
            <span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">登录响应结果：</span><span style="color: #800000">'</span><span style="color: #000000">,jieg)

        </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">第三次请求携带授权Cookie，请求需要登录才能查看的页面.........!</span><span style="color: #800000">'</span><span style="color: #000000">)
        </span><span style="color: #0000ff">yield</span> Request(<span style="color: #800000">'</span><span style="color: #800000">https://www.douban.com/people/81309370/</span><span style="color: #800000">'</span>,meta={<span style="color: #800000">'</span><span style="color: #800000">cookiejar</span><span style="color: #800000">'</span>:True},headers=self.header,callback=<span style="color: #000000">self.next2)


    </span><span style="color: #0000ff">def</span><span style="color: #000000"> next2(self,response):
        </span><span style="color: #008000">#</span><span style="color: #008000"> 请求Cookie</span>
        Cookie3 = response.request.headers.getlist(<span style="color: #800000">'</span><span style="color: #800000">Cookie</span><span style="color: #800000">'</span><span style="color: #000000">)
        </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">查看需要登录才可以访问的页面携带Cookies：</span><span style="color: #800000">'</span><span style="color: #000000">,Cookie3)

        leir </span>= response.xpath(<span style="color: #800000">'</span><span style="color: #800000">/html/head/title/text()</span><span style="color: #800000">'</span>).extract()  <span style="color: #008000">#</span><span style="color: #008000">得到个人中心页面</span>
        <span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">最终内容</span><span style="color: #800000">'</span><span style="color: #000000">,leir)
        </span><span style="color: #008000">#</span><span style="color: #008000"> leir2 = response.xpath('//div[@class="set-tags"]/a/text()').extract()  # 得到个人中心页面</span>
        <span style="color: #008000">#</span><span style="color: #008000"> print(leir2)</span></pre>
</div>
<p>&nbsp;</p></div>