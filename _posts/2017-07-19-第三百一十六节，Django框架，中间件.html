第三百一十六节，Django框架，中间件


			<div id="cnblogs_post_body" class="blogpost-body"><p><strong>第三百一十六节，Django框架，中间件</strong></p>
<p><strong>django 中的中间件（middleware），在django中，中间件其实就是一个类，在请求到来和结束后，django会根据自己的规则在合适的时机执行中间件中相应的方法。</strong></p>
<p><strong>在django项目的settings模块中，有一个 MIDDLEWARE变量，其中每一个元素就是一个中间件（<span style="color: #0000ff">也就是一个中间件模块的一个类</span>），如下。</strong></p>
<p><span style="color: #ff0000"><strong><strong>settings模块中</strong></strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">中间件</span>
MIDDLEWARE =<span style="color: #000000"> [
    </span><span style="color: #800000">'</span><span style="color: #800000">django.middleware.security.SecurityMiddleware</span><span style="color: #800000">'</span><span style="color: #000000">,
    </span><span style="color: #800000">'</span><span style="color: #800000">django.contrib.sessions.middleware.SessionMiddleware</span><span style="color: #800000">'</span><span style="color: #000000">,
    </span><span style="color: #800000">'</span><span style="color: #800000">django.middleware.common.CommonMiddleware</span><span style="color: #800000">'</span><span style="color: #000000">,
    </span><span style="color: #008000">#</span><span style="color: #008000"> 'django.middleware.csrf.CsrfViewMiddleware',   #</span>
    <span style="color: #800000">'</span><span style="color: #800000">django.contrib.auth.middleware.AuthenticationMiddleware</span><span style="color: #800000">'</span><span style="color: #000000">,
    </span><span style="color: #800000">'</span><span style="color: #800000">django.contrib.messages.middleware.MessageMiddleware</span><span style="color: #800000">'</span><span style="color: #000000">,
    </span><span style="color: #800000">'</span><span style="color: #800000">django.middleware.clickjacking.XFrameOptionsMiddleware</span><span style="color: #800000">'</span><span style="color: #000000">,
]</span></pre>
</div>
<p>&nbsp;</p>
<p><span style="color: #ff0000; background-color: #ffff00"><strong>自定义中间件</strong></span></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000; background-color: #ffff00"><strong><strong><strong>1、定义中间件模块，在中间件模块里定义中间件类</strong></strong></strong></span></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">process_request(self, request)</span>有请求时执行</strong></span><br><strong>	　　request参数接收请求信息对象</strong></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">process_view(self, request, callback, callback_args, callback_kwargs)</span>逻辑处理之前执行</strong></span></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">process_exception(self, request, exception)</span>出错时执行</strong></span><br><strong>	　　exception参数接收错误信息</strong></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">process_response(self, request, response)</span>响应后执行，无论是否出错</strong></span><br><strong>	　　response参数接收html页面对象，立面包含响应码</strong></p>
<p>&nbsp;</p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000">coding:utf-8</span>
<span style="color: #0000ff">from</span> django.utils.deprecation <span style="color: #0000ff">import</span><span style="color: #000000; background-color: #ff99cc"> MiddlewareMixin
</span><span style="color: #0000ff">from</span> django.shortcuts <span style="color: #0000ff">import</span><span style="color: #000000"> render

</span><span style="color: #0000ff">class</span><span style="color: #000000"> zhongjianjian(<span style="background-color: #ff99cc">MiddlewareMixin</span>):

    </span><span style="color: #0000ff">def</span><span style="color: #000000"><span style="background-color: #ff99cc"> process_request(self, request)</span>:
        </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">有请求时执行</span><span style="color: #800000">'</span><span style="color: #000000">)
        </span><span style="color: #008000">#</span><span style="color: #008000"> print(request.META) #请求对象内容</span>
        <span style="color: #008000">#</span><span style="color: #008000">在这里可以做ip访问拦截器</span>

    <span style="color: #0000ff">def</span><span style="color: #000000"><span style="background-color: #ff99cc"> process_view(self, request, callback, callback_args, callback_kwargs)</span>:
        </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">逻辑处理之前执行</span><span style="color: #800000">'</span><span style="color: #000000">)


    </span><span style="color: #0000ff">def</span><span style="color: #000000"><span style="background-color: #ff99cc"> process_exception(self, request, exception)</span>:
        </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">出错时执行</span><span style="color: #800000">'</span><span style="color: #000000">)
        </span><span style="color: #008000">#</span><span style="color: #008000"> return render(request, 'app1/cuowu.html')</span>
        <span style="color: #0000ff">print</span><span style="color: #000000">(exception)
        </span><span style="color: #008000">#</span><span style="color: #008000">做程序出错时处理</span>


    <span style="color: #0000ff">def</span><span style="color: #000000"><span style="background-color: #ff99cc"> process_response(self, request, response)</span>:
        </span><span style="color: #0000ff">print</span>(<span style="color: #800000">'</span><span style="color: #800000">响应后执行，无论是否出错</span><span style="color: #800000">'</span><span style="color: #000000">)
        </span><span style="color: #0000ff">return</span> response</pre>
</div>
<p><span style="color: #ff0000; background-color: #ffff00"><strong>2、将中间件模块里的类路径注册到<strong>MIDDLEWARE列表里</strong></strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">中间件</span>
MIDDLEWARE =<span style="color: #000000"> [
    </span><span style="color: #800000">'</span><span style="color: #800000; background-color: #ff99cc">app1.chajian.zhong_jian_jian.zhongjianjian</span><span style="color: #800000">'</span><span style="color: #000000">,
    </span><span style="color: #800000">'</span><span style="color: #800000">django.middleware.security.SecurityMiddleware</span><span style="color: #800000">'</span><span style="color: #000000">,
    </span><span style="color: #800000">'</span><span style="color: #800000">django.contrib.sessions.middleware.SessionMiddleware</span><span style="color: #800000">'</span><span style="color: #000000">,
    </span><span style="color: #800000">'</span><span style="color: #800000">django.middleware.common.CommonMiddleware</span><span style="color: #800000">'</span><span style="color: #000000">,
    </span><span style="color: #008000">#</span><span style="color: #008000"> 'django.middleware.csrf.CsrfViewMiddleware',   #</span>
    <span style="color: #800000">'</span><span style="color: #800000">django.contrib.auth.middleware.AuthenticationMiddleware</span><span style="color: #800000">'</span><span style="color: #000000">,
    </span><span style="color: #800000">'</span><span style="color: #800000">django.contrib.messages.middleware.MessageMiddleware</span><span style="color: #800000">'</span><span style="color: #000000">,
    </span><span style="color: #800000">'</span><span style="color: #800000">django.middleware.clickjacking.XFrameOptionsMiddleware</span><span style="color: #800000">'</span><span style="color: #000000">,
]</span></pre>
</div>
<p><img src="https://images2015.cnblogs.com/blog/955761/201707/955761-20170720143608552-699718127.png" alt=""></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000; background-color: #ffff00"><strong>中间件工作流程</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">中间件</span>
MIDDLEWARE =<span style="color: #000000"> [
    </span><span style="color: #800000">'</span><span style="color: #800000">app1.chajian.zhong_jian_jian.zhongjianjian</span><span style="color: #800000">'</span><span style="color: #000000">,
    </span><span style="color: #800000">'</span><span style="color: #800000">django.middleware.security.SecurityMiddleware</span><span style="color: #800000">'</span><span style="color: #000000">,
    </span><span style="color: #800000">'</span><span style="color: #800000">django.contrib.sessions.middleware.SessionMiddleware</span><span style="color: #800000">'</span><span style="color: #000000">,
    </span><span style="color: #800000">'</span><span style="color: #800000">django.middleware.common.CommonMiddleware</span><span style="color: #800000">'</span><span style="color: #000000">,
    </span><span style="color: #008000">#</span><span style="color: #008000"> 'django.middleware.csrf.CsrfViewMiddleware',   #</span>
    <span style="color: #800000">'</span><span style="color: #800000">django.contrib.auth.middleware.AuthenticationMiddleware</span><span style="color: #800000">'</span><span style="color: #000000">,
    </span><span style="color: #800000">'</span><span style="color: #800000">django.contrib.messages.middleware.MessageMiddleware</span><span style="color: #800000">'</span><span style="color: #000000">,
    </span><span style="color: #800000">'</span><span style="color: #800000">django.middleware.clickjacking.XFrameOptionsMiddleware</span><span style="color: #800000">'</span><span style="color: #000000">,
]</span></pre>
</div>
<p><img src="https://images2015.cnblogs.com/blog/955761/201707/955761-20170720145215083-1771999296.png" alt=""></p>
<p><span style="color: #ff0000"><strong>如果出错流程</strong></span></p>
<p>&nbsp;<img src="https://images2015.cnblogs.com/blog/955761/201707/955761-20170720145604255-2139965103.png" alt=""></p></div>