第三百二十七节，web爬虫讲解2—urllib库爬虫—基础使用—超时设置—自动模拟http请求


			<div id="cnblogs_post_body" class="blogpost-body"><p><br><strong>第三百二十七节，web爬虫讲解2—urllib库爬虫</strong></p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>利用python系统自带的<strong>urllib库写简单爬虫</strong></strong></span></p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">urlopen()</span>获取一个URL的html源码</strong></span><br><span style="color: #ff0000"><strong><span style="color: #0000ff">read()</span>读出html源码内容</strong></span><br><span style="color: #ff0000"><strong><span style="color: #0000ff">decode("utf-8")</span>将字节转化成字符串</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf-8 -*-</span>
<span style="color: #0000ff">import</span><span style="color: #000000"> urllib.<span style="background-color: #ff99cc">request</span>
html </span>= urllib.request.<span style="background-color: #ff99cc">urlopen(<span style="color: #800000">'</span><span style="color: #800000">http://edu.51cto.com/course/8360.html</span><span style="color: #800000">'</span>)</span>.<span style="background-color: #ff99cc">read()</span>.<span style="background-color: #ff99cc">decode(<span style="color: #800000">"</span><span style="color: #800000">utf-8</span><span style="color: #800000">"</span><span style="color: #000000">)
</span></span><span style="color: #0000ff">print</span>(html)</pre>
</div>
<div class="cnblogs_code">
<pre><span style="color: #0000ff">&lt;!</span><span style="color: #ff00ff">DOCTYPE html</span><span style="color: #0000ff">&gt;</span>
<span style="color: #0000ff">&lt;</span><span style="color: #800000">html </span><span style="color: #ff0000">lang</span><span style="color: #0000ff">="zh-CN"</span><span style="color: #0000ff">&gt;</span>
<span style="color: #0000ff">&lt;</span><span style="color: #800000">head</span><span style="color: #0000ff">&gt;</span>
    <span style="color: #0000ff">&lt;</span><span style="color: #800000">meta </span><span style="color: #ff0000">charset</span><span style="color: #0000ff">="UTF-8"</span><span style="color: #0000ff">&gt;</span>
    <span style="color: #0000ff">&lt;</span><span style="color: #800000">meta </span><span style="color: #ff0000">name</span><span style="color: #0000ff">="viewport"</span><span style="color: #ff0000"> content</span><span style="color: #0000ff">="width=device-width, initial-scale=1"</span><span style="color: #0000ff">&gt;</span>
    <span style="color: #0000ff">&lt;</span><span style="color: #800000">meta </span><span style="color: #ff0000">name</span><span style="color: #0000ff">="csrf-param"</span><span style="color: #ff0000"> content</span><span style="color: #0000ff">="_csrf"</span><span style="color: #0000ff">&gt;</span>
    <span style="color: #0000ff">&lt;</span><span style="color: #800000">meta </span><span style="color: #ff0000">name</span><span style="color: #0000ff">="csrf-token"</span><span style="color: #ff0000"> content</span><span style="color: #0000ff">="X1pZZnpKWnQAIGkLFisPFT4jLlJNIWMHHWM6HBBnbiwPbz4/LH1pWQ=="</span><span style="color: #0000ff">&gt;</span></pre>
</div>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong>正则获取页面指定内容</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf-8 -*-</span>
<span style="color: #0000ff">import</span><span style="color: #000000"> urllib.request
</span><span style="color: #0000ff">import</span><span style="color: #000000"> re
html </span>= urllib.request.urlopen(<span style="color: #800000">'</span><span style="color: #800000">http://edu.51cto.com/course/8360.html</span><span style="color: #800000">'</span>).read().decode(<span style="color: #800000">"</span><span style="color: #800000">utf-8</span><span style="color: #800000">"</span>)   <span style="color: #008000">#</span><span style="color: #008000">获取html源码</span>
<span style="background-color: #ff99cc">pat</span> = <span style="color: #800000">"</span><span style="color: #800000">51CTO学院Python实战群\((\d*?)\)</span><span style="color: #800000">"</span>      <span style="color: #008000">#</span><span style="color: #008000">正则规则，获取到QQ号</span>
<span style="background-color: #ff99cc">rst</span> =<span style="color: #000000"> re.compile(<span style="background-color: #ff99cc">pat</span>).findall(<span style="background-color: #ff99cc">html</span>)
</span><span style="color: #0000ff">print</span><span style="color: #000000">(rst)

</span><span style="color: #008000">#</span><span style="color: #008000; background-color: #ff99cc">['325935753']</span></pre>
</div>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">urlretrieve()</span>将网络文件下载保存到本地，参数1网络文件URL，参数2保存路径</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf-8 -*-</span>
<span style="color: #0000ff">from</span> urllib <span style="color: #0000ff">import</span><span style="color: #ff0000; background-color: #ffff00"> request
</span><span style="color: #0000ff">import</span><span style="color: #000000"> re
</span><span style="color: #0000ff">import</span><span style="color: #000000"> os

file_path </span>= os.path.join(os.getcwd() + <span style="color: #800000">'</span><span style="color: #800000">/222.html</span><span style="color: #800000">'</span>)    <span style="color: #008000">#</span><span style="color: #008000">拼接文件保存路径</span><span style="color: #008000">
#</span><span style="color: #008000"> print(file_path)</span>
request.<span style="background-color: #ff99cc">urlretrieve(<span style="color: #800000">'</span><span style="color: #800000">http://edu.51cto.com/course/8360.html</span><span style="color: #800000">'</span>, file_path)</span> <span style="color: #008000">#</span><span style="color: #008000">下载这个文件保存到指定路径</span></pre>
</div>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">urlcleanup()</span>清除爬虫产生的内存</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf-8 -*-</span>
<span style="color: #0000ff">from</span> urllib <span style="color: #0000ff">import</span><span style="color: #000000; background-color: #ff99cc"> request
</span><span style="color: #0000ff">import</span><span style="color: #000000"> re
</span><span style="color: #0000ff">import</span><span style="color: #000000"> os

file_path </span>= os.path.join(os.getcwd() + <span style="color: #800000">'</span><span style="color: #800000">/222.html</span><span style="color: #800000">'</span>)    <span style="color: #008000">#</span><span style="color: #008000">拼接文件保存路径</span><span style="color: #008000">
#</span><span style="color: #008000"> print(file_path)</span>
request.urlretrieve(<span style="color: #800000">'</span><span style="color: #800000">http://edu.51cto.com/course/8360.html</span><span style="color: #800000">'</span>, file_path) <span style="color: #008000">#</span><span style="color: #008000">下载这个文件保存到指定路径</span>
<span style="background-color: #ff99cc">request.urlcleanup()</span></pre>
</div>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">info()</span>查看抓取页面的简介</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf-8 -*-</span>
<span style="color: #0000ff">import</span><span style="color: #000000"> urllib.<span style="background-color: #ff99cc">request
</span></span><span style="color: #0000ff">import</span><span style="color: #000000"> re
html </span>= urllib.request.urlopen(<span style="color: #800000">'</span><span style="color: #800000">http://edu.51cto.com/course/8360.html</span><span style="color: #800000">'</span>)   <span style="color: #008000">#</span><span style="color: #008000">获取html源码</span>
a =<span style="color: #000000"> html.<span style="background-color: #ff99cc">info()
</span></span><span style="color: #0000ff">print</span><span style="color: #000000">(a)

</span><span style="color: #008000">#</span><span style="color: #008000"> C:\Users\admin\AppData\Local\Programs\Python\Python35\python.exe H:/py/15/chshi.py</span><span style="color: #008000">
#</span><span style="color: #008000"> Date: Tue, 25 Jul 2017 16:08:17 GMT</span><span style="color: #008000">
#</span><span style="color: #008000"> Content-Type: text/html; charset=UTF-8</span><span style="color: #008000">
#</span><span style="color: #008000"> Transfer-Encoding: chunked</span><span style="color: #008000">
#</span><span style="color: #008000"> Connection: close</span><span style="color: #008000">
#</span><span style="color: #008000"> Set-Cookie: aliyungf_tc=AQAAALB8CzAikwwA9aReq63oa31pNIez; Path=/; HttpOnly</span><span style="color: #008000">
#</span><span style="color: #008000"> Server: Tengine</span><span style="color: #008000">
#</span><span style="color: #008000"> Vary: Accept-Encoding</span><span style="color: #008000">
#</span><span style="color: #008000"> Vary: Accept-Encoding</span><span style="color: #008000">
#</span><span style="color: #008000"> Vary: Accept-Encoding</span></pre>
</div>
<p>&nbsp;</p>
<p><strong><span style="color: #ff0000"><span style="color: #0000ff">getcode()</span>获取状态码</span></strong></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf-8 -*-</span>
<span style="color: #0000ff">import</span><span style="color: #000000"> urllib.request
</span><span style="color: #0000ff">import</span><span style="color: #000000"> re
html </span>= urllib.request.urlopen(<span style="color: #800000">'</span><span style="color: #800000">http://edu.51cto.com/course/8360.html</span><span style="color: #800000">'</span>)   <span style="color: #008000">#</span><span style="color: #008000">获取html源码</span>
a = html.<span style="background-color: #ff99cc">getcode()</span>  <span style="color: #008000">#</span><span style="color: #008000">获取状态码</span>
<span style="color: #0000ff">print</span><span style="color: #000000">(a)

</span><span style="color: #008000">#</span><span style="color: #008000">200</span></pre>
</div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">geturl()</span>获取当前抓取页面的URL</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf-8 -*-</span>
<span style="color: #0000ff">import</span><span style="color: #000000"> urllib.<span style="background-color: #ff99cc">request
</span></span><span style="color: #0000ff">import</span><span style="color: #000000"> re
html </span>= urllib.request.urlopen(<span style="color: #800000">'</span><span style="color: #800000">http://edu.51cto.com/course/8360.html</span><span style="color: #800000">'</span>)   <span style="color: #008000">#</span><span style="color: #008000">获取html源码</span>
a = html.<span style="background-color: #ff99cc">geturl()</span>  <span style="color: #008000">#</span><span style="color: #008000">获取当前抓取页面的URL</span>
<span style="color: #0000ff">print</span><span style="color: #000000">(a)

</span><span style="color: #008000">#</span><span style="color: #008000">http://edu.51cto.com/course/8360.html</span></pre>
</div>
<p>&nbsp;</p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">timeout</span>抓取超时设置，单位为秒</strong></span></p>
<p><span style="color: #0000ff"><strong>是指抓取一个页面时对方服务器响应太慢，或者很久没响应，设置一个超时时间，超过超时时间就不抓取了</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding:utf-8 -*-</span>
<span style="color: #0000ff">import</span><span style="color: #000000"> urllib.<span style="background-color: #ff99cc">request
</span></span><span style="color: #0000ff">import</span><span style="color: #000000"> re
html </span>= urllib.request.urlopen(<span style="color: #800000">'</span><span style="color: #800000">http://edu.51cto.com/course/8360.html</span><span style="color: #800000">'</span>,<span style="background-color: #ff99cc">timeout=30</span>)   <span style="color: #008000">#</span><span style="color: #008000">获取html源码</span>
a = html.geturl()  <span style="color: #008000">#</span><span style="color: #008000">获取当前抓取页面的URL</span>
<span style="color: #0000ff">print</span><span style="color: #000000">(a)

</span><span style="color: #008000">#</span><span style="color: #008000">http://edu.51cto.com/course/8360.html</span></pre>
</div>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p><strong><span style="color: #ff0000">自动模拟http请求</span></strong></p>
<p><span style="color: #ff0000"><strong>http请求一般常用的就是get请求和post请求</strong></span></p>
<p><span style="color: #ff0000"><strong><strong>get请求</strong></strong></span></p>
<p><strong>比如360搜索，就是通过get请求并且将用户的搜索关键词传入到服务器获取数据的</strong></p>
<p><strong>所以我们可以模拟百度http请求，构造关键词自动请求</strong></p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">quote()</span>将关键词转码成浏览器认识的字符，默认网站不能是中文</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding: utf-8 -*-</span>

<span style="color: #0000ff">import</span><span style="color: #000000"> urllib.request
</span><span style="color: #0000ff">import</span><span style="color: #000000"> re
<span style="background-color: #ff99cc">gjc </span></span><span style="background-color: #ff99cc">= <span style="color: #800000">"</span><span style="color: #800000">手机</span><span style="color: #800000">"</span>     <span style="color: #008000">#</span><span style="color: #008000">设置关键词</span></span>
gjc = urllib.request.<span style="background-color: #ff99cc">quote(gjc)</span>         <span style="color: #008000">#</span><span style="color: #008000">将关键词转码成浏览器认识的字符，默认网站不能是中文</span>
<span style="background-color: #ff99cc">url = <span style="color: #800000">"</span><span style="color: #800000">https://www.so.com/s?q=</span><span style="color: #800000">"</span>+gjc</span>     <span style="color: #008000">#</span><span style="color: #008000">构造url地址</span><span style="color: #008000">
#</span><span style="color: #008000"> print(url)</span>
html = urllib.request.urlopen(<span style="background-color: #ff99cc">url</span>).read().decode(<span style="color: #800000">"</span><span style="color: #800000">utf-8</span><span style="color: #800000">"</span>)  <span style="color: #008000">#</span><span style="color: #008000">获取html源码</span>
pat = <span style="color: #800000">"</span><span style="color: #800000">(\w*&lt;em&gt;\w*&lt;/em&gt;\w*)</span><span style="color: #800000">"</span>            <span style="color: #008000">#</span><span style="color: #008000">正则获取相关标题</span>
rst =<span style="color: #000000"> re.compile(pat).findall(html)
</span><span style="color: #008000">#</span><span style="color: #008000"> print(rst)</span>
<span style="color: #0000ff">for</span> i <span style="color: #0000ff">in</span><span style="color: #000000"> rst:
    </span><span style="color: #0000ff">print</span>(i)                            <span style="color: #008000">#</span><span style="color: #008000">循环出获取的标题</span>

    <span style="color: #008000">#</span><span style="color: #008000"> 官网 &lt; em &gt; 手机 &lt; / em &gt;</span>
    <span style="color: #008000">#</span><span style="color: #008000"> 官网 &lt; em &gt; 手机 &lt; / em &gt;</span>
    <span style="color: #008000">#</span><span style="color: #008000"> 官网 &lt; em &gt; 手机 &lt; / em &gt; 这么低的价格</span>
    <span style="color: #008000">#</span><span style="color: #008000"> 大牌 &lt; em &gt; 手机 &lt; / em &gt; 低价抢</span>
    <span style="color: #008000">#</span><span style="color: #008000"> &lt; em &gt; 手机 &lt; / em &gt;</span>
    <span style="color: #008000">#</span><span style="color: #008000"> 淘宝网推荐 &lt; em &gt; 手机 &lt; / em &gt;</span>
    <span style="color: #008000">#</span><span style="color: #008000"> &lt; em &gt; 手机 &lt; / em &gt;</span>
    <span style="color: #008000">#</span><span style="color: #008000"> &lt; em &gt; 手机 &lt; / em &gt;</span>
    <span style="color: #008000">#</span><span style="color: #008000"> &lt; em &gt; 手机 &lt; / em &gt;</span>
    <span style="color: #008000">#</span><span style="color: #008000"> &lt; em &gt; 手机 &lt; / em &gt;</span>
    <span style="color: #008000">#</span><span style="color: #008000"> 苏宁易购买 &lt; em &gt; 手机 &lt; / em &gt;</span>
    <span style="color: #008000">#</span><span style="color: #008000"> 买 &lt; em &gt; 手机 &lt; / em &gt;</span>
    <span style="color: #008000">#</span><span style="color: #008000"> 买 &lt; em &gt; 手机 &lt; / em &gt;</span></pre>
</div>
<p><span style="color: #ff0000"><strong>&nbsp;post请求</strong></span></p>
<p><span style="color: #ff0000"><strong><span style="color: #0000ff">urlencode()</span>封装post请求提交的表单数据，参数是字典形式的键值对表单数据</strong></span><br><span style="color: #ff0000"><strong><span style="color: #0000ff">Request()</span>提交post请求，参数1是url地址，参数2是封装的表单数据</strong></span></p>
<div class="cnblogs_code">
<pre><span style="color: #008000">#</span><span style="color: #008000">!/usr/bin/env python</span><span style="color: #008000">
#</span><span style="color: #008000"> -*- coding: utf-8 -*-</span>

<span style="color: #0000ff">import</span><span style="color: #000000"> urllib.request
</span><span style="color: #0000ff">import</span><span style="color: #000000"> urllib.parse

posturl </span>= <span style="color: #800000">"</span><span style="color: #800000">http://www.iqianyue.com/mypost/</span><span style="color: #800000">"</span><span style="color: #000000">
shuju </span>= urllib.parse.<span style="background-color: #ff99cc">urlencode</span>({                <span style="color: #008000">#</span><span style="color: #008000">urlencode()封装post请求提交的表单数据，参数是字典形式的键值对表单数据</span>
    <span style="color: #800000">'</span><span style="color: #800000">name</span><span style="color: #800000">'</span>: <span style="color: #800000">'</span><span style="color: #800000">123</span><span style="color: #800000">'</span><span style="color: #000000">,
    </span><span style="color: #800000">'</span><span style="color: #800000">pass</span><span style="color: #800000">'</span>: <span style="color: #800000">'</span><span style="color: #800000">456</span><span style="color: #800000">'</span><span style="color: #000000">
    }).encode(</span><span style="color: #800000">'</span><span style="color: #800000">utf-8</span><span style="color: #800000">'</span><span style="color: #000000">)
req </span>= urllib.request.<span style="background-color: #ff99cc">Request(posturl,shuju)</span>     <span style="color: #008000">#</span><span style="color: #008000">Request()提交post请求，参数1是url地址，参数2是封装的表单数据</span>
html = urllib.request.urlopen(req).read().decode(<span style="color: #800000">"</span><span style="color: #800000">utf-8</span><span style="color: #800000">"</span>)  <span style="color: #008000">#</span><span style="color: #008000">获取post请求返回的页面</span>
<span style="color: #0000ff">print</span>(html)</pre>
</div>
<p>&nbsp;</p></div>